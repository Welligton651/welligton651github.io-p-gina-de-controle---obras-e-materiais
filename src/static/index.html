

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sistema de Gest√£o de Obras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBDaeWicvigtP9xPv919E-RNoxfvC-Hqik&libraries=places" async defer></script>
    <script>
        const API_BASE_URL ='https://welligton651github-io-pagina-de-controle.onrender.com/api';
    </script>
<style>
        .glassmorphism {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
        }
        .scan-animation {
            animation: scan 2s ease-in-out infinite;
        }
        @keyframes scan {
            0%, 100% { transform: translateY(-10px); opacity: 0.5; }
            50% { transform: translateY(10px); opacity: 1; }
        }
        .progress-bar {
            transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, #3B82F6, #1D4ED8, #2563EB);
            background-size: 200% 100%;
            animation: progressFlow 3s ease-in-out infinite;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: shimmer 2.5s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        @keyframes progressFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .obra-progress-bar {
            transition: width 2.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            animation: progressPulse 4s ease-in-out infinite;
        }
        .obra-progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
            animation: progressShine 3s infinite;
        }
        @keyframes progressShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .mobile-nav {
            min-height: 44px;
        }
        .mobile-nav button {
            min-height: 44px;
            min-width: 44px;
        }
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        .toast.removing {
            animation: slideOut 0.3s ease-in;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .category-icon {
            transition: all 0.3s ease;
        }
        .category-icon:hover {
            transform: scale(1.1);
        }
        .map-container {
            height: 400px;
            border-radius: 1rem;
            overflow: hidden;
        }
        .real-time-indicator {
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .loading-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            background-size: 200% 100%;
            animation: shimmer-loading 1.5s infinite;
        }
        @keyframes shimmer-loading {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        .swipe-indicator {
            position: relative;
            overflow: hidden;
        }
        .swipe-indicator::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: swipe-hint 3s infinite;
        }
        @keyframes swipe-hint {
            0% { left: -100%; }
            50% { left: 100%; }
            100% { left: 100%; }
        }
        .interactive-map-marker {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .interactive-map-marker:hover {
            transform: scale(1.2);
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .alert-badge {
            animation: bounce-alert 2s infinite;
        }
        @keyframes bounce-alert {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        /* Advanced Modal Animations */
        .modal-overlay.show {
            display: flex !important;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        
        /* Enhanced Loading States */
        .skeleton {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        /* Tab Transition Animations */
        .tab-content {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .tab-content.hidden {
            transform: translateX(-20px);
            opacity: 0;
        }
        
        .tab-content:not(.hidden) {
            transform: translateX(0);
            opacity: 1;
        }
        
        .tab-slide-in {
            animation: tabSlideIn 0.4s ease-out;
        }
        
        @keyframes tabSlideIn {
            0% {
                transform: translateX(30px);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Search Highlighting */
        .search-highlight {
            background-color: rgba(59, 130, 246, 0.3);
            color: #60A5FA;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Enhanced Focus States */
        .focus-ring:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        
        /* Custom Slider Styles */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            border-radius: 5px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .slider::-webkit-slider-thumb:hover {
            background: #2563EB;
            transform: scale(1.1);
        }
        
        .slider::-moz-range-thumb:hover {
            background: #2563EB;
            transform: scale(1.1);
        }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            .story-content {
                max-width: 95%;
                max-height: 85vh;
            }
            
            .feed-post {
                margin: 0 -1rem;
                border-radius: 0;
            }
            
            .media-carousel {
                border-radius: 0;
            }
            
            .glassmorphism {
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
            }
            
            .obra-progress-bar, .progress-bar {
                animation-duration: 2s;
            }
            
            .timeline-content {
                padding: 1rem;
            }
            
            .timeline-photos {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .story-content {
                max-width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }
            
            .story-header {
                padding: 0.75rem;
            }
            
            .story-user-info {
                gap: 0.5rem;
            }
            
            .story-avatar {
                width: 28px;
                height: 28px;
            }
            
            .carousel-nav {
                width: 32px;
                height: 32px;
            }
            
            .carousel-nav.prev {
                left: 8px;
            }
            
            .carousel-nav.next {
                right: 8px;
            }
            
            .media-counter {
                top: 8px;
                right: 8px;
                padding: 2px 6px;
                font-size: 0.625rem;
            }
            
            .carousel-indicators {
                bottom: 8px;
                gap: 4px;
            }
            
            .carousel-indicator {
                width: 4px;
                height: 4px;
            }
        }
        
        /* Orientation Support */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .mobile-nav {
                padding: 0.25rem 0;
            }
            .mobile-nav-btn {
                min-height: 36px;
                min-width: 36px;
            }
            .mobile-nav-btn span {
                font-size: 0.625rem;
            }
            
            .story-content {
                max-height: 95vh;
            }
        }
        
        /* Touch Improvements */
        @media (hover: none) and (pointer: coarse) {
            .carousel-nav {
                opacity: 1;
                background: rgba(0, 0, 0, 0.7);
            }
            
            .post-action-btn:hover {
                transform: none;
            }
            
            .hover-lift:hover {
                transform: none;
            }
        }
        
        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            .glassmorphism {
                background: rgba(0, 0, 0, 0.8) !important;
                border: 2px solid rgba(255, 255, 255, 0.5) !important;
            }
        }
        
        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white !important;
                color: black !important;
            }
        }
        
        /* Theme Styles */
        .theme-light {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
        }
        
        .theme-light .glassmorphism {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }
        
        .theme-light .text-white {
            color: #1f2937 !important;
        }
        
        .theme-light .text-gray-300 {
            color: #6b7280 !important;
        }
        
        .theme-light .text-gray-400 {
            color: #9ca3af !important;
        }
        
        .theme-blue {
            background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 50%, #2563eb 100%);
        }
        
        .theme-green {
            background: linear-gradient(135deg, #166534 0%, #15803d 50%, #16a34a 100%);
        }
        
        .theme-dark {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #0891b2 100%);
        }
        
        .theme-blackfull {
            background: linear-gradient(135deg, #000000 0%, #111111 50%, #1a1a1a 100%);
        }
        
        .theme-blackfull .glassmorphism {
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px rgba(0, 255, 255, 0.1);
        }
        
        .theme-blackfull .text-white {
            color: #00ffff !important;
        }
        
        .theme-blackfull .text-gray-300 {
            color: #a0a0a0 !important;
        }
        
        .theme-blackfull .text-gray-400 {
            color: #808080 !important;
        }
        
        .theme-blackfull .bg-blue-600 {
            background: linear-gradient(135deg, #00ffff, #0080ff) !important;
        }
        
        .theme-blackfull .bg-green-600 {
            background: linear-gradient(135deg, #00ff80, #00ff00) !important;
        }
        
        .theme-blackfull .bg-red-600 {
            background: linear-gradient(135deg, #ff0080, #ff0040) !important;
        }
        
        .theme-blackfull .bg-purple-600 {
            background: linear-gradient(135deg, #ff00ff, #8000ff) !important;
        }
        
        .theme-blackfull .bg-yellow-600 {
            background: linear-gradient(135deg, #ffff00, #ff8000) !important;
        }
        
        .theme-blackfull .nav-btn.active,
        .theme-blackfull .mobile-nav-btn.text-blue-400 {
            color: #00ffff !important;
            background: rgba(0, 255, 255, 0.1) !important;
        }
        
        .theme-blackfull .progress-bar,
        .theme-blackfull .obra-progress-bar {
            background: linear-gradient(90deg, #00ffff, #0080ff, #00ff80) !important;
        }
        
        .theme-blackfull .feed-post {
            background: rgba(0, 0, 0, 0.9) !important;
            border: 1px solid rgba(0, 255, 255, 0.2) !important;
        }
        
        .theme-blackfull .feed-stories {
            background: rgba(0, 0, 0, 0.8) !important;
            border: 1px solid rgba(0, 255, 255, 0.15) !important;
        }
        
        .theme-blackfull .post-action-btn {
            background: rgba(0, 0, 0, 0.6) !important;
            border: 1px solid rgba(0, 255, 255, 0.3) !important;
            color: #00ffff !important;
        }
        
        .theme-blackfull .post-action-btn:hover {
            background: rgba(0, 255, 255, 0.1) !important;
            border-color: rgba(0, 255, 255, 0.5) !important;
        }
        
        .theme-blackfull .timeline-content {
            background: rgba(0, 0, 0, 0.8) !important;
            border: 1px solid rgba(0, 255, 255, 0.3) !important;
        }
        
        .theme-blackfull .timeline::before {
            background: linear-gradient(to bottom, #00ffff, #ff00ff, #ff0080) !important;
        }
        
        .theme-blackfull .timeline-item::before {
            background: #00ffff !important;
            border: 3px solid rgba(0, 0, 0, 0.8) !important;
        }
        
        .theme-blackfull .timeline-item.completed::before {
            background: #00ff80 !important;
        }
        
        .theme-blackfull .timeline-item.in-progress::before {
            background: #ffff00 !important;
        }
        
        .theme-blackfull .timeline-item.delayed::before {
            background: #ff0080 !important;
        }
        
        /* Enhanced Error States */
        .error-state {
            border-color: #EF4444 !important;
            background-color: rgba(239, 68, 68, 0.1) !important;
        }
        
        /* Success States */
        .success-state {
            border-color: #10B981 !important;
            background-color: rgba(16, 185, 129, 0.1) !important;
        }
        
        /* Loading Skeleton for Cards */
        .card-skeleton {
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.05) 25%, 
                rgba(255,255,255,0.1) 50%, 
                rgba(255,255,255,0.05) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 2s infinite;
        }
        
        /* Enhanced Hover Effects */
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Accessibility Improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Enhanced Button States */
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563EB, #1E40AF);
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Animated Gradient Text for SEMCAS Logo */
        .animated-gradient-text {
            background: linear-gradient(45deg, #ffffff, #f0f0f0, #ffffff, #e0e0e0, #ffffff);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
            letter-spacing: 2px;
        }
        
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Timeline Styles */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #3B82F6, #8B5CF6, #EF4444);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 2rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -0.5rem;
            top: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: #3B82F6;
            border: 3px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
        
        .timeline-item.completed::before {
            background: #10B981;
        }
        
        .timeline-item.in-progress::before {
            background: #F59E0B;
            animation: pulse 2s infinite;
        }
        
        .timeline-item.delayed::before {
            background: #EF4444;
        }
        
        .timeline-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .timeline-content:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .timeline-photos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .timeline-photo {
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .timeline-photo:hover {
            transform: scale(1.05);
        }
        
        .timeline-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-preview {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .photo-preview img {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        
        .photo-preview .remove-photo {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .photo-preview .remove-photo:hover {
            background: rgba(239, 68, 68, 1);
        }
        
        /* Photo Modal */
        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .photo-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .photo-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 1rem;
        }
        
        .photo-modal .close-photo {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
        }
        
        /* Timeline Animation */
        .timeline-item {
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInTimeline 0.6s ease forwards;
        }
        
        @keyframes slideInTimeline {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .timeline-item:nth-child(1) { animation-delay: 0.1s; }
        .timeline-item:nth-child(2) { animation-delay: 0.2s; }
        .timeline-item:nth-child(3) { animation-delay: 0.3s; }
        .timeline-item:nth-child(4) { animation-delay: 0.4s; }
        .timeline-item:nth-child(5) { animation-delay: 0.5s; }

        /* Modern Feed Styles */
        .feed-post {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .feed-post:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .feed-stories {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }
        
        /* Instagram-style Carousel */
        .media-carousel {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .carousel-container {
            display: flex;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        
        .carousel-slide {
            min-width: 100%;
            aspect-ratio: 1;
            position: relative;
            overflow: hidden;
        }
        
        .carousel-slide img,
        .carousel-slide video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .carousel-slide:hover img,
        .carousel-slide:hover video {
            transform: scale(1.02);
        }
        
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
        }
        
        .media-carousel:hover .carousel-nav {
            opacity: 1;
        }
        
        .carousel-nav:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: translateY(-50%) scale(1.1);
        }
        
        .carousel-nav.prev {
            left: 12px;
        }
        
        .carousel-nav.next {
            right: 12px;
        }
        
        .carousel-indicators {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 10;
        }
        
        .carousel-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .carousel-indicator.active {
            background: white;
            transform: scale(1.2);
        }
        
        .media-counter {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 10;
        }
        
        /* Enhanced Action Buttons */
        .post-action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .post-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-1px);
        }
        
        .post-action-btn.liked {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
            color: #60A5FA;
        }
        
        .post-action-btn.liked:hover {
            background: rgba(59, 130, 246, 0.3);
        }
        
        /* Share Modal */
        .share-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .share-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .share-modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .share-modal.show .share-modal-content {
            transform: scale(1);
        }
        
        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .share-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .share-option i {
            font-size: 1.5rem;
        }
        
        .share-option span {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Video Play Button */
        .video-play-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }
        
        .carousel-slide:hover .video-play-overlay {
            opacity: 1;
        }
        
        .video-play-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .video-play-btn:hover {
            background: white;
            transform: scale(1.1);
        }
        
        .video-play-btn i {
            color: #1f2937;
            font-size: 1.5rem;
            margin-left: 3px;
        }
        
        /* Story Viewer Modal */
        .story-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .story-viewer.show {
            opacity: 1;
            visibility: visible;
        }
        
        .story-content {
            position: relative;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            background: #1f2937;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .story-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
            padding: 1rem;
        }
        
        .story-progress {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .story-progress-bar {
            height: 100%;
            background: white;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }
        
        .story-user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .story-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .story-user-details h4 {
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0;
        }
        
        .story-user-details span {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
        }
        
        .story-media {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .story-text-overlay {
            position: absolute;
            bottom: 2rem;
            left: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            text-align: center;
        }
        
        .story-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 20;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .story-close:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        .story-navigation {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50%;
            cursor: pointer;
            z-index: 5;
        }
        
        .story-nav-prev {
            left: 0;
        }
        
        .story-nav-next {
            right: 0;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glassmorphism bg-white/10 rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-extrabold mb-4 animated-gradient-text">
                    SEMCAS
                </h1>
                <i class="fas fa-hard-hat text-6xl text-orange-400 mb-4"></i>
                <h2 class="text-xl font-bold text-white mb-2">
                    Sistema de Gest√£o
                </h2>
                <p class="text-gray-300">Controle de Obras e Estoque</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-gray-300 text-sm font-medium mb-2">Nome do Usu√°rio</label>
                    <input type="text" id="username" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite seu nome" required>
                </div>
                <div>
                    <label for="password" class="block text-gray-300 text-sm font-medium mb-2">Senha</label>
                    <input type="password" id="password" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha" required>
                </div>
                <div>
                    <label for="userType" class="block text-gray-300 text-sm font-medium mb-2">Tipo de Usu√°rio</label>
                    <select id="userType" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Administrador">Administrador</option>
                        <option value="Encarregado">Encarregado</option>
                        <option value="Almoxarife">Almoxarife</option>
                        <option value="Funcion√°rio">Funcion√°rio</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Entrar
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400">Digite qualquer nome para acessar o sistema</p>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-screen">
        <!-- Header -->
        <header class="glassmorphism bg-white/10 backdrop-blur-lg border-b border-white/20 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-hard-hat text-2xl text-orange-400"></i>
                    <div>
                        <h1 class="text-xl font-bold text-white">Gest√£o de Obras</h1>
                        <p class="text-sm text-gray-300" id="userInfo">Bem-vindo!</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="openAccessHistoryModal()" class="bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 hover:text-white p-3 rounded-xl transition-all duration-200" title="Hist√≥rico de Acesso">
                        <i class="fas fa-history text-lg"></i>
                    </button>
                    <button onclick="openThemeModal()" class="bg-gray-500/20 hover:bg-gray-500/30 text-gray-400 hover:text-white p-3 rounded-xl transition-all duration-200" title="Alterar Tema">
                        <i class="fas fa-palette text-lg"></i>
                    </button>
                    <button id="logoutBtn" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-4 py-2 rounded-xl transition-all duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Desktop Navigation -->
        <nav class="hidden lg:block glassmorphism bg-white/10 backdrop-blur-lg border-b border-white/20">
            <div class="flex space-x-1 p-4">
                <button class="nav-btn active px-6 py-3 rounded-xl font-medium transition-all duration-200" data-tab="dashboard">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button class="nav-btn px-6 py-3 rounded-xl font-medium transition-all duration-200" data-tab="obras">
                    <i class="fas fa-building mr-2"></i>Obras
                </button>
                <button class="nav-btn px-6 py-3 rounded-xl font-medium transition-all duration-200" data-tab="estoque">
                    <i class="fas fa-boxes mr-2"></i>Estoque
                </button>
                <button class="nav-btn px-6 py-3 rounded-xl font-medium transition-all duration-200" data-tab="feed">
                    <i class="fas fa-camera mr-2"></i>Feed
                </button>
                <button class="nav-btn px-6 py-3 rounded-xl font-medium transition-all duration-200" data-tab="graficos">
                    <i class="fas fa-chart-pie mr-2"></i>Gr√°ficos
                </button>
                <button class="nav-btn px-6 py-3 rounded-xl font-medium transition-all duration-200" data-tab="relatorios">
                    <i class="fas fa-file-pdf mr-2"></i>Relat√≥rios
                </button>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="p-4 pb-20 lg:pb-4">
            <!-- Dashboard Tab -->
            <div id="dashboard-content" class="tab-content">
                <!-- Real-time Status Header -->
                <div class="glassmorphism bg-white/10 rounded-2xl p-4 mb-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="real-time-indicator w-3 h-3 bg-green-400 rounded-full"></div>
                            <span class="text-white font-medium">Sistema Online - Dados em Tempo Real</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-sync-alt text-cyan-400 animate-spin"></i>
                                <span class="text-gray-300 text-sm">√öltima atualiza√ß√£o: <span id="lastUpdate">agora</span></span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-bell text-yellow-400 alert-badge"></i>
                                <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full" id="alertCount">3</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Statistics Cards with Enhanced Features -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300 touch-target">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <p class="text-gray-300 text-sm">Obras Ativas</p>
                                    <div class="w-2 h-2 bg-blue-400 rounded-full real-time-indicator"></div>
                                </div>
                                <p class="text-3xl font-bold text-white" id="obrasAtivas">0</p>
                            </div>
                            <div class="relative">
                                <i class="fas fa-building text-3xl text-blue-400"></i>
                                <div class="absolute -top-1 -right-1 w-3 h-3 bg-green-400 rounded-full animate-ping"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">2 obras em andamento</span>
                            <span class="text-gray-400">Meta: 10</span>
                        </div>
                    </div>
                    
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300 touch-target">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <p class="text-gray-300 text-sm">Obras Conclu√≠das</p>
                                    <div class="w-2 h-2 bg-green-400 rounded-full real-time-indicator"></div>
                                </div>
                                <p class="text-3xl font-bold text-white" id="obrasConcluidas">0</p>
                            </div>
                            <i class="fas fa-check-circle text-3xl text-green-400"></i>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">Obras em desenvolvimento</span>
                            <span class="text-gray-400">Meta: 100%</span>
                        </div>
                    </div>
                    
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300 touch-target">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <p class="text-gray-300 text-sm">Progresso M√©dio</p>
                                    <div class="w-2 h-2 bg-cyan-400 rounded-full real-time-indicator"></div>
                                </div>
                                <p class="text-3xl font-bold text-white" id="progressoMedio">0%</p>
                            </div>
                            <i class="fas fa-chart-line text-3xl text-cyan-400"></i>
                        </div>
                        <div class="w-full bg-white/10 rounded-full h-2 mb-2">
                            <div class="progress-bar bg-gradient-to-r from-cyan-500 to-blue-400 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">Progresso m√©dio das obras</span>
                            <span class="text-gray-400">Tend√™ncia: --</span>
                        </div>
                    </div>
                    
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300 touch-target">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <p class="text-gray-300 text-sm">Valor em Estoque</p>
                                    <div class="w-2 h-2 bg-orange-400 rounded-full real-time-indicator"></div>
                                </div>
                                <p class="text-2xl font-bold text-white" id="valorEstoque">R$ 0</p>
                            </div>
                            <div class="relative">
                                <i class="fas fa-boxes text-3xl text-orange-400"></i>
                                <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-400 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">3 produtos em estoque</span>
                            <span class="text-gray-400">Materiais dispon√≠veis</span>
                        </div>
                    </div>
                    
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300 touch-target">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <p class="text-gray-300 text-sm">Valor das Obras</p>
                                    <div class="w-2 h-2 bg-purple-400 rounded-full real-time-indicator"></div>
                                </div>
                                <p class="text-2xl font-bold text-white" id="valorObras">R$ 0</p>
                            </div>
                            <i class="fas fa-hard-hat text-3xl text-purple-400"></i>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">2 obras ativas</span>
                            <span class="text-gray-400">R$ 2.050.000 investidos</span>
                        </div>
                    </div>
                    
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300 touch-target">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <p class="text-gray-300 text-sm">Valor Geral</p>
                                    <div class="w-2 h-2 bg-yellow-400 rounded-full real-time-indicator"></div>
                                </div>
                                <p class="text-2xl font-bold text-white" id="valorGeral">R$ 0</p>
                            </div>
                            <i class="fas fa-dollar-sign text-3xl text-yellow-400"></i>
                        </div>
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-400">Patrim√¥nio total</span>
                            <span class="text-gray-400">ROI: 0%</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Panel -->
                <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg mb-6">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        <i class="fas fa-bolt text-yellow-400 mr-2"></i>
                        A√ß√µes R√°pidas
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="openAddObraModal()" class="touch-target bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 p-4 rounded-xl transition-all duration-200 flex flex-col items-center space-y-2">
                            <i class="fas fa-plus text-2xl"></i>
                            <span class="text-sm font-medium">Nova Obra</span>
                        </button>
                        <button onclick="openAddProductModal()" class="touch-target bg-green-600/20 hover:bg-green-600/30 text-green-400 p-4 rounded-xl transition-all duration-200 flex flex-col items-center space-y-2">
                            <i class="fas fa-box text-2xl"></i>
                            <span class="text-sm font-medium">Add Produto</span>
                        </button>
                        <button onclick="openScannerModal()" class="touch-target bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 p-4 rounded-xl transition-all duration-200 flex flex-col items-center space-y-2">
                            <i class="fas fa-qrcode text-2xl"></i>
                            <span class="text-sm font-medium">Scanner</span>
                        </button>
                        <button onclick="ui.switchTab('relatorios')" class="touch-target bg-red-600/20 hover:bg-red-600/30 text-red-400 p-4 rounded-xl transition-all duration-200 flex flex-col items-center space-y-2">
                            <i class="fas fa-file-pdf text-2xl"></i>
                            <span class="text-sm font-medium">Relat√≥rio</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        <i class="fas fa-clock text-cyan-400 mr-2"></i>
                        Atividades Recentes
                    </h3>
                    <div class="space-y-4" id="activityFeed">
                        <div class="flex items-start space-x-4 p-4 bg-white/5 rounded-xl hover:bg-white/10 transition-all duration-200">
                            <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-building text-white text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-white font-medium">CENTRO POP COHAB - Progresso 80%</p>
                                <p class="text-gray-400 text-sm">Estrutura em andamento, funda√ß√£o conclu√≠da</p>
                                <span class="text-xs text-gray-500">H√° 2 horas</span>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4 p-4 bg-white/5 rounded-xl hover:bg-white/10 transition-all duration-200">
                            <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-check text-white text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-white font-medium">CENTRO POP CENTRO - Projeto Aprovado</p>
                                <p class="text-gray-400 text-sm">Licen√ßas obtidas, in√≠cio das obras autorizado</p>
                                <span class="text-xs text-gray-500">H√° 1 dia</span>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-4 p-4 bg-white/5 rounded-xl hover:bg-white/10 transition-all duration-200">
                            <div class="w-10 h-10 bg-orange-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-boxes text-white text-sm"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-white font-medium">Estoque Atualizado</p>
                                <p class="text-gray-400 text-sm">3 produtos cadastrados no sistema</p>
                                <span class="text-xs text-gray-500">H√° 2 dias</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Obras Tab -->
            <div id="obras-content" class="tab-content hidden">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 space-y-4 lg:space-y-0">
                    <h2 class="text-2xl font-bold text-white">Gest√£o de Obras</h2>
                    <button onclick="openAddObraModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i>Nova Obra
                    </button>
                </div>

                <!-- Map Section -->
                <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg mb-6">
                    <div class="flex flex-wrap items-center justify-between mb-4">
                        <div class="flex items-center space-x-4 mb-2 lg:mb-0">
                            <h3 class="text-lg font-semibold text-white">Localiza√ß√£o das Obras</h3>
                            <div class="real-time-indicator w-2 h-2 bg-green-400 rounded-full"></div>
                        </div>
                        <div class="flex items-center space-x-6">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full interactive-map-marker"></div>
                                <span class="text-sm text-gray-300">Conclu√≠da (0)</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-orange-500 rounded-full interactive-map-marker"></div>
                                <span class="text-sm text-gray-300">Em Andamento (2)</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full interactive-map-marker"></div>
                                <span class="text-sm text-gray-300">Atrasada (0)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Google Maps Embed -->
                    <div class="map-container bg-gray-800 rounded-xl relative overflow-hidden">
                        <iframe 
                            src="https://www.google.com/maps/d/embed?mid=1nDgnRq4Q6GNiaCPhHNU9GvwaEwuI41Y&ehbc=2E312F" 
                            width="100%" 
                            height="400" 
                            style="border:0; border-radius: 1rem;" 
                            allowfullscreen="" 
                            loading="lazy" 
                            referrerpolicy="no-referrer-when-downgrade">
                        </iframe>
                    </div>
                    
                    <!-- Map Controls -->
                    <div class="flex items-center justify-between mt-4">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="text-sm text-gray-300">Conclu√≠da</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                                <span class="text-sm text-gray-300">Em Andamento</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="text-sm text-gray-300">Atrasada</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                <span class="text-sm text-gray-300">Planejada</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 mt-2 lg:mt-0">
                            <button class="touch-target bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 px-3 py-2 rounded-lg text-sm transition-all duration-200">
                                <i class="fas fa-expand mr-1"></i>Tela Cheia
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="obrasGrid">
                    <!-- Obra Cards will be generated here -->
                </div>
            </div>

            <!-- Estoque Tab -->
            <div id="estoque-content" class="tab-content hidden">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 space-y-4 lg:space-y-0">
                    <h2 class="text-2xl font-bold text-white">Controle de Estoque</h2>
                    <div class="flex space-x-3">
                        <button onclick="openHistoricoDispensacaoModal()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-history mr-2"></i>Hist√≥rico
                        </button>
                        <button onclick="openUploadPlanilhaModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-file-excel mr-2"></i>Upload Planilha
                        </button>
                        <button onclick="openScannerModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-qrcode mr-2"></i>Scanner
                        </button>
                        <button onclick="openAddProductModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-plus mr-2"></i>Produto
                        </button>
                    </div>
                </div>

                <!-- Advanced Search System -->
                <div class="glassmorphism bg-white/10 rounded-2xl p-4 mb-6 shadow-lg">
                    <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4">
                        <div class="relative flex-1 w-full">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            <input 
                                type="text" 
                                id="searchInput" 
                                placeholder="Buscar produtos por nome, ID ou categoria..." 
                                class="w-full pl-10 pr-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                            >
                            <button id="clearSearch" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-colors duration-200 hidden">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-300 text-sm">Filtros:</span>
                            <select id="stockFilter" class="bg-white/10 border border-white/20 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all" class="bg-gray-800">Todos</option>
                                <option value="low" class="bg-gray-800">Estoque Baixo</option>
                                <option value="normal" class="bg-gray-800">Estoque Normal</option>
                                <option value="high" class="bg-gray-800">Estoque Alto</option>
                            </select>
                            <select id="sortBy" class="bg-white/10 border border-white/20 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="name" class="bg-gray-800">Nome</option>
                                <option value="stock" class="bg-gray-800">Estoque</option>
                                <option value="price" class="bg-gray-800">Pre√ßo</option>
                                <option value="value" class="bg-gray-800">Valor Total</option>
                            </select>
                        </div>
                    </div>
                    <div id="searchResults" class="mt-3 text-sm text-gray-300 hidden">
                        <span id="resultsCount">0</span> produtos encontrados
                    </div>
                </div>
                
                <!-- Product Categories -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                    <button class="category-btn glassmorphism bg-white/10 p-4 rounded-xl text-center hover:bg-white/20 transition-all duration-200" data-category="all">
                        <i class="category-icon fas fa-th text-2xl text-white mb-2"></i>
                        <p class="text-sm text-gray-300">Todos</p>
                    </button>
                    <button class="category-btn glassmorphism bg-white/10 p-4 rounded-xl text-center hover:bg-white/20 transition-all duration-200" data-category="cimento">
                        <i class="category-icon fas fa-cube text-2xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-300">Cimento</p>
                    </button>
                    <button class="category-btn glassmorphism bg-white/10 p-4 rounded-xl text-center hover:bg-white/20 transition-all duration-200" data-category="alvenaria">
                        <i class="category-icon fas fa-th-large text-2xl text-red-400 mb-2"></i>
                        <p class="text-sm text-gray-300">Alvenaria</p>
                    </button>
                    <button class="category-btn glassmorphism bg-white/10 p-4 rounded-xl text-center hover:bg-white/20 transition-all duration-200" data-category="agregados">
                        <i class="category-icon fas fa-mountain text-2xl text-yellow-400 mb-2"></i>
                        <p class="text-sm text-gray-300">Agregados</p>
                    </button>
                    <button class="category-btn glassmorphism bg-white/10 p-4 rounded-xl text-center hover:bg-white/20 transition-all duration-200" data-category="ferragens">
                        <i class="category-icon fas fa-grip-lines text-2xl text-blue-400 mb-2"></i>
                        <p class="text-sm text-gray-300">Ferragens</p>
                    </button>
                    <button class="category-btn glassmorphism bg-white/10 p-4 rounded-xl text-center hover:bg-white/20 transition-all duration-200" data-category="tintas">
                        <i class="category-icon fas fa-paint-brush text-2xl text-green-400 mb-2"></i>
                        <p class="text-sm text-gray-300">Tintas</p>
                    </button>
                    <button class="category-btn glassmorphism bg-white/10 p-4 rounded-xl text-center hover:bg-white/20 transition-all duration-200" data-category="ferramentas">
                        <i class="category-icon fas fa-tools text-2xl text-purple-400 mb-2"></i>
                        <p class="text-sm text-gray-300">Ferramentas</p>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="productsGrid">
                    <!-- Product Cards will be generated here -->
                </div>
            </div>

            <!-- Feed Tab -->
            <div id="feed-content" class="tab-content hidden">
                <div class="max-w-2xl mx-auto">
                    <!-- Feed Header -->
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-white">Feed SEMCAS</h2>
                        <button onclick="feedManager.openCreatePostModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 shadow-lg">
                            <i class="fas fa-plus mr-2"></i>Nova Postagem
                        </button>
                    </div>

                    <!-- Stories Section -->
                    <div class="feed-stories p-6 mb-8">
                        <div class="flex items-center space-x-4 overflow-x-auto pb-2">
                            <div class="flex-shrink-0 text-center cursor-pointer hover:scale-105 transition-transform duration-200" onclick="feedManager.openCreateStoryModal()">
                                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center mb-3 border-3 border-white/20 hover:border-white/40 transition-all duration-200 shadow-lg">
                                    <i class="fas fa-plus text-white text-xl"></i>
                                </div>
                                <span class="text-sm text-gray-300 font-medium">Seu Story</span>
                            </div>
                            <div id="storiesContainer" class="flex space-x-4">
                                <!-- Stories will be generated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Feed Posts -->
                    <div id="feedContainer" class="space-y-6">
                        <!-- Posts will be generated here -->
                    </div>

                    <!-- Load More Button -->
                    <div class="text-center mt-8">
                        <button onclick="feedManager.loadMorePosts()" class="glassmorphism bg-white/10 hover:bg-white/20 text-white px-8 py-3 rounded-xl font-medium transition-all duration-200 border border-white/20">
                            <i class="fas fa-arrow-down mr-2"></i>Carregar Mais
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos Tab -->
            <div id="graficos-content" class="tab-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white">An√°lise Gr√°fica</h2>
                    <div class="flex items-center space-x-3">
                        <div class="real-time-indicator w-2 h-2 bg-green-400 rounded-full"></div>
                        <span class="text-gray-300 text-sm">Dados atualizados em tempo real</span>
                        <button class="touch-target bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 px-3 py-2 rounded-lg text-sm transition-all duration-200">
                            <i class="fas fa-sync-alt mr-1"></i>Atualizar
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Produtos Mais Usados -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-chart-pie text-blue-400 mr-2"></i>
                                Produtos Mais Usados
                            </h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-blue-400 rounded-full real-time-indicator"></div>
                                <span class="text-xs text-gray-400">Por valor</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="produtosChart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-gray-300 text-sm">Total: R$ 245.680 em estoque</p>
                        </div>
                    </div>
                    
                    <!-- Movimenta√ß√£o Semanal -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-chart-line text-green-400 mr-2"></i>
                                Movimenta√ß√£o Semanal
                            </h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-400 rounded-full real-time-indicator"></div>
                                <span class="text-xs text-gray-400">√öltimos 7 dias</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="movimentacaoChart"></canvas>
                        </div>
                        <div class="mt-4 flex justify-between text-sm">
                            <div class="text-center">
                                <p class="text-green-400 font-medium">‚Üó Entradas</p>
                                <p class="text-gray-300">108 itens</p>
                            </div>
                            <div class="text-center">
                                <p class="text-red-400 font-medium">‚Üò Sa√≠das</p>
                                <p class="text-gray-300">92 itens</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progresso das Obras -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-chart-bar text-purple-400 mr-2"></i>
                                Progresso das Obras
                            </h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-purple-400 rounded-full real-time-indicator"></div>
                                <span class="text-xs text-gray-400">Atualizado hoje</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="progressoChart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-gray-300 text-sm">Progresso m√©dio: <span class="text-cyan-400 font-medium">72%</span></p>
                        </div>
                    </div>
                    
                    <!-- Distribui√ß√£o de Valores -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-chart-pie text-yellow-400 mr-2"></i>
                                Distribui√ß√£o de Valores
                            </h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-yellow-400 rounded-full real-time-indicator"></div>
                                <span class="text-xs text-gray-400">Total geral</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="valoresChart"></canvas>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-gray-300 text-sm">Valor total: <span class="text-yellow-400 font-medium">R$ 2.095.680</span></p>
                        </div>
                    </div>
                </div>

                <!-- Chart Analytics Summary -->
                <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg mt-6">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                        <i class="fas fa-analytics text-cyan-400 mr-2"></i>
                        Insights dos Dados
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="text-center p-4 bg-white/5 rounded-xl">
                            <i class="fas fa-trending-up text-3xl text-green-400 mb-2"></i>
                            <p class="text-white font-medium">Tend√™ncia Positiva</p>
                            <p class="text-gray-300 text-sm">Movimenta√ß√£o de estoque +15%</p>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-xl">
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-400 mb-2"></i>
                            <p class="text-white font-medium">Aten√ß√£o Necess√°ria</p>
                            <p class="text-gray-300 text-sm">3 produtos com estoque baixo</p>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-xl">
                            <i class="fas fa-chart-line text-3xl text-blue-400 mb-2"></i>
                            <p class="text-white font-medium">Performance</p>
                            <p class="text-gray-300 text-sm">ROI m√©dio de 15.2%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rios Tab -->
            <div id="relatorios-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-white mb-6">Sistema de Relat√≥rios</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Relat√≥rio Geral -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg">
                        <div class="text-center mb-4">
                            <i class="fas fa-file-pdf text-4xl text-red-400 mb-3"></i>
                            <h3 class="text-lg font-semibold text-white">Relat√≥rio Geral</h3>
                            <p class="text-gray-300 text-sm">Resumo executivo completo</p>
                        </div>
                        <button onclick="reportSystem.generateGeneralReport()" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-download mr-2"></i>Gerar PDF
                        </button>
                    </div>
                    
                    <!-- Relat√≥rio de Obras -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg">
                        <div class="text-center mb-4">
                            <i class="fas fa-building text-4xl text-blue-400 mb-3"></i>
                            <h3 class="text-lg font-semibold text-white">Relat√≥rio de Obras</h3>
                            <p class="text-gray-300 text-sm">Detalhamento por projeto</p>
                        </div>
                        <button onclick="reportSystem.generateWorksReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-download mr-2"></i>Gerar PDF
                        </button>
                    </div>
                    
                    <!-- Relat√≥rio de Estoque -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg">
                        <div class="text-center mb-4">
                            <i class="fas fa-boxes text-4xl text-green-400 mb-3"></i>
                            <h3 class="text-lg font-semibold text-white">Relat√≥rio de Estoque</h3>
                            <p class="text-gray-300 text-sm">Invent√°rio e movimenta√ß√µes</p>
                        </div>
                        <button onclick="reportSystem.generateStockReport()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-download mr-2"></i>Gerar PDF
                        </button>
                    </div>
                    
                    <!-- Relat√≥rio Financeiro -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg">
                        <div class="text-center mb-4">
                            <i class="fas fa-dollar-sign text-4xl text-yellow-400 mb-3"></i>
                            <h3 class="text-lg font-semibold text-white">Relat√≥rio Financeiro</h3>
                            <p class="text-gray-300 text-sm">An√°lise de custos e valores</p>
                        </div>
                        <button onclick="reportSystem.generateFinancialReport()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-download mr-2"></i>Gerar PDF
                        </button>
                    </div>
                    
                    <!-- Relat√≥rio Personalizado -->
                    <div class="glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg">
                        <div class="text-center mb-4">
                            <i class="fas fa-cog text-4xl text-cyan-400 mb-3"></i>
                            <h3 class="text-lg font-semibold text-white">Relat√≥rio Personalizado</h3>
                            <p class="text-gray-300 text-sm">Configure seus pr√≥prios dados</p>
                        </div>
                        <button onclick="openCustomReportModal()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                            <i class="fas fa-download mr-2"></i>Configurar
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="lg:hidden fixed bottom-0 left-0 right-0 glassmorphism bg-white/10 backdrop-blur-lg border-t border-white/20 mobile-nav">
            <div class="flex justify-around py-2 overflow-x-auto">
                <button class="mobile-nav-btn flex flex-col items-center justify-center text-blue-400 transition-all duration-200 min-w-0 flex-shrink-0" data-tab="dashboard">
                    <i class="fas fa-chart-line text-lg"></i>
                    <span class="text-xs mt-1">Dashboard</span>
                </button>
                <button class="mobile-nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-white transition-all duration-200 min-w-0 flex-shrink-0" data-tab="obras">
                    <i class="fas fa-building text-lg"></i>
                    <span class="text-xs mt-1">Obras</span>
                </button>
                <button class="mobile-nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-white transition-all duration-200 min-w-0 flex-shrink-0" data-tab="estoque">
                    <i class="fas fa-boxes text-lg"></i>
                    <span class="text-xs mt-1">Estoque</span>
                </button>
                <button class="mobile-nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-white transition-all duration-200 min-w-0 flex-shrink-0" data-tab="feed">
                    <i class="fas fa-camera text-lg"></i>
                    <span class="text-xs mt-1">Feed</span>
                </button>
                <button class="mobile-nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-white transition-all duration-200 min-w-0 flex-shrink-0" data-tab="graficos">
                    <i class="fas fa-chart-pie text-lg"></i>
                    <span class="text-xs mt-1">Gr√°ficos</span>
                </button>
                <button class="mobile-nav-btn flex flex-col items-center justify-center text-gray-400 hover:text-white transition-all duration-200 min-w-0 flex-shrink-0" data-tab="relatorios">
                    <i class="fas fa-file-pdf text-lg"></i>
                    <span class="text-xs mt-1">Relat√≥rios</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Furniture Management Modal -->
    <div id="furnitureModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-7xl h-5/6 flex flex-col transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Gest√£o de Mobili√°rio - <span id="furnitureObraName"></span></h2>
                <button onclick="closeFurnitureModal()" class="text-white hover:text-gray-300 transition-colors duration-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="flex-grow grid grid-cols-1 lg:grid-cols-4 gap-6 overflow-hidden">
                <!-- Left Panel: Furniture Catalog & Form -->
                <div class="lg:col-span-1 flex flex-col gap-6 overflow-y-auto">
                    <!-- Furniture Catalog -->
                    <div class="glassmorphism bg-white/10 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-white mb-3">Cat√°logo de M√≥veis</h3>
                        <div id="furnitureCatalog" class="grid grid-cols-3 gap-4">
                            <!-- Furniture items will be dynamically inserted here -->
                        </div>
                    </div>

                    <!-- Add Furniture Form -->
                    <div class="glassmorphism bg-white/10 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-white mb-3">Adicionar M√≥vel</h3>
                        <form id="addFurnitureForm" class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-300">Tipo de M√≥vel</label>
                                <select id="furnitureType" class="w-full bg-white/10 border border-white/20 text-white p-2 rounded">
                                    <!-- Options will be dynamically inserted here -->
                                </select>
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">C√¥modo</label>
                                <select id="furnitureRoom" class="w-full bg-white/10 border border-white/20 text-white p-2 rounded">
                                    <!-- Options will be dynamically inserted here -->
                                </select>
                            </div>
                            <div>
                                <label class="text-sm text-gray-300">Status</label>
                                <select id="furnitureStatus" class="w-full bg-white/10 border border-white/20 text-white p-2 rounded">
                                    <option value="existente">Existente</option>
                                    <option value="novo">Novo</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded transition-all duration-200">Adicionar</button>
                        </form>
                    </div>
                </div>

                <!-- Center Panel: Floor Plan -->
                <div class="lg:col-span-2 glassmorphism bg-white/10 p-4 rounded-lg flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-3">Planta Baixa</h3>
                    <div id="floorPlan" class="flex-grow grid grid-cols-3 grid-rows-2 gap-2 bg-black/20 p-2 rounded-lg relative">
                        <!-- Rooms will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Right Panel: Inventory & Stats -->
                <div class="lg:col-span-1 flex flex-col gap-6 overflow-y-auto">
                    <div class="glassmorphism bg-white/10 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-white mb-3">Invent√°rio por C√¥modo</h3>
                        <div id="roomInventory" class="space-y-2">
                            <!-- Room inventory will be dynamically inserted here -->
                        </div>
                    </div>
                    <div class="glassmorphism bg-white/10 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-white mb-3">Estat√≠sticas Gerais</h3>
                        <div id="furnitureStats">
                            <!-- Stats will be dynamically inserted here -->
                        </div>
                    </div>
                    <button onclick="generateFurniturePDF()" class="w-full bg-purple-600 hover:bg-purple-700 text-white p-2 rounded mt-auto transition-all duration-200">
                        <i class="fas fa-file-pdf mr-2"></i>Gerar Relat√≥rio de Mobili√°rio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Modal System -->
    
    <!-- Scanner Modal -->
    <div id="scannerModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white mb-1">Scanner de Produtos</h3>
                    <p class="text-gray-300 text-sm">Escaneie QR Code ou C√≥digo de Barras</p>
                </div>
                <button class="modal-close text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="bg-white/5 rounded-xl p-8 mb-6 text-center relative overflow-hidden">
                <div class="scan-animation border-2 border-cyan-400 rounded-lg h-1 w-full mb-4"></div>
                <i class="fas fa-qrcode text-6xl text-cyan-400 mb-4"></i>
                <p class="text-gray-300">Posicione o c√≥digo na √°rea de leitura</p>
                
                <!-- Scanner Status -->
                <div id="scannerStatus" class="mt-4 hidden">
                    <div class="flex items-center justify-center space-x-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-green-400 text-sm">Scanner ativo</span>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <div class="flex space-x-3">
                    <button id="startScanBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-play mr-2"></i>Iniciar Scanner
                    </button>
                    <button id="uploadImageBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-upload mr-2"></i>Upload
                    </button>
                </div>
                <button id="closeScannerBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-md transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">Adicionar Produto</h3>
                <button class="modal-close text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addProductForm" class="space-y-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Nome do Produto</label>
                    <input type="text" id="productName" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome do produto" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Categoria</label>
                    <select id="productCategory" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="" class="bg-gray-800">Selecione a categoria</option>
                        <option value="cimento" class="bg-gray-800">Cimento</option>
                        <option value="alvenaria" class="bg-gray-800">Alvenaria</option>
                        <option value="agregados" class="bg-gray-800">Agregados</option>
                        <option value="ferragens" class="bg-gray-800">Ferragens</option>
                        <option value="tintas" class="bg-gray-800">Tintas</option>
                        <option value="ferramentas" class="bg-gray-800">Ferramentas</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">C√≥digo de Barras</label>
                    <div class="flex space-x-2">
                        <input type="text" id="productBarcode" class="flex-1 px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite ou escaneie o c√≥digo" required>
                        <button type="button" id="scanBarcodeBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-xl transition-all duration-200">
                            <i class="fas fa-qrcode"></i>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Estoque Inicial</label>
                        <input type="number" id="productStock" min="0" value="0" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Estoque M√≠nimo</label>
                        <input type="number" id="productMinStock" min="1" value="10" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Pre√ßo Unit√°rio (R$)</label>
                    <input type="number" id="productPrice" min="0" step="0.01" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0,00" required>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" class="modal-close flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload Planilha Modal -->
    <div id="uploadPlanilhaModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-2xl transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white mb-1">Upload de Planilha de Estoque</h3>
                    <p class="text-gray-300 text-sm">Importe produtos em massa atrav√©s de planilha CSV ou Excel</p>
                </div>
                <button onclick="closeUploadPlanilhaModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Upload Area -->
            <div class="mb-6">
                <div id="uploadArea" class="border-2 border-dashed border-gray-400 rounded-xl p-8 text-center transition-all duration-200 hover:border-blue-400 hover:bg-white/5">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-white font-medium mb-2">Arraste e solte sua planilha aqui</p>
                    <p class="text-gray-400 text-sm mb-4">ou clique para selecionar arquivo</p>                        <input type="file" id="planilhaFile" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleFileSelect(event)">cument.getElementById('planilhaFile').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-all duration-200">
                        Selecionar Arquivo
                    </button>
                </div>
                
                <!-- File Info -->
                <div id="fileInfo" class="hidden mt-4 p-4 bg-white/10 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-file-excel text-green-400 text-xl mr-3"></i>
                            <div>
                                <p class="text-white font-medium" id="fileName"></p>
                                <p class="text-gray-400 text-sm" id="fileSize"></p>
                            </div>
                        </div>
                        <button onclick="removeFile()" class="text-red-400 hover:text-red-300 transition-colors duration-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Template Download -->
            <div class="mb-6 p-4 bg-yellow-600/20 border border-yellow-600/30 rounded-xl">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-yellow-400 text-lg mr-3 mt-1"></i>
                    <div class="flex-1">
                        <p class="text-yellow-200 font-medium mb-2">Formato da Planilha</p>
                        <p class="text-yellow-100 text-sm mb-3">Use o template padr√£o para garantir que todos os dados sejam importados corretamente. Suporta CSV, Excel (.xlsx, .xls).</p>
                        <button onclick="downloadTemplate()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200">
                            <i class="fas fa-download mr-2"></i>Baixar Template
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Validation Options -->
            <div class="mb-6">
                <h4 class="text-white font-medium mb-3">Op√ß√µes de Valida√ß√£o</h4>
                <div class="space-y-3">
                    <label class="flex items-center">
                        <input type="checkbox" id="validateDuplicates" checked class="mr-3 rounded">
                        <span class="text-gray-300">Verificar produtos duplicados</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="validatePrices" checked class="mr-3 rounded">
                        <span class="text-gray-300">Validar pre√ßos (deve ser maior que zero)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="validateStock" checked class="mr-3 rounded">
                        <span class="text-gray-300">Validar estoque (deve ser n√∫mero positivo)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="updateExisting" class="mr-3 rounded">
                        <span class="text-gray-300">Atualizar produtos existentes</span>
                    </label>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div id="uploadProgress" class="hidden mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white font-medium">Processando planilha...</span>
                    <span class="text-gray-300" id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex space-x-3">
                <button onclick="closeUploadPlanilhaModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                    Cancelar
                </button>
                <button onclick="processUpload()" id="uploadBtn" disabled class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-3 rounded-xl font-medium transition-all duration-200">
                    <i class="fas fa-upload mr-2"></i>Processar Planilha
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Obra Modal -->
    <div id="addObraModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-md transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white" id="obraModalTitle">Nova Obra</h3>
                <button class="modal-close text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addObraForm" class="space-y-4">
                <input type="hidden" id="obraId" value="">
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Nome da Obra</label>
                    <input type="text" id="obraNome" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome da obra" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Localiza√ß√£o</label>
                    <input type="text" id="obraLocalizacao" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Endere√ßo da obra" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Valor (R$)</label>
                    <input type="number" id="obraValor" min="0" step="0.01" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0,00" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Status</label>
                    <select id="obraStatus" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Em Andamento" class="bg-gray-800">Em Andamento</option>
                        <option value="Conclu√≠da" class="bg-gray-800">Conclu√≠da</option>
                        <option value="Pausada" class="bg-gray-800">Pausada</option>
                        <option value="Cancelada" class="bg-gray-800">Cancelada</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Progresso (%)</label>
                    <div class="flex items-center space-x-3">
                        <input type="range" id="obraProgresso" min="0" max="100" value="0" class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer slider">
                        <span id="progressoValue" class="text-white font-medium min-w-12">0%</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Data de In√≠cio</label>
                    <input type="date" id="obraDataInicio" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" class="modal-close flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-save mr-2"></i><span id="obraSubmitText">Salvar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div id="timelineModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white mb-1">Hist√≥rico da Obra</h3>
                    <p class="text-gray-300 text-sm" id="timelineObraName">Timeline de progresso e etapas</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="generatePhotoReport()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-file-pdf mr-2"></i>Relat√≥rio Fotogr√°fico
                    </button>
                    <button onclick="openTrashModal()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-trash mr-2"></i>Lixeira
                    </button>
                    <button onclick="openAddStageModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i>Adicionar Etapa
                    </button>
                    <button onclick="closeTimelineModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Timeline Container -->
            <div class="relative" id="timelineContainer">
                <!-- Timeline items will be generated here -->
            </div>
        </div>
    </div>

    <!-- Add Stage Modal -->
    <div id="addStageModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-md transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">Adicionar Etapa</h3>
                <button onclick="closeAddStageModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addStageForm" class="space-y-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">T√≠tulo da Etapa</label>
                    <input type="text" id="stageTitle" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Funda√ß√£o conclu√≠da" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Descri√ß√£o</label>
                    <textarea id="stageDescription" rows="3" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Descreva os detalhes da etapa..." required></textarea>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Data da Etapa</label>
                    <input type="date" id="stageDate" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Fotografias</label>
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center">
                        <input type="file" id="stagePhotos" multiple accept="image/*" class="hidden">
                        <button type="button" onclick="document.getElementById('stagePhotos').click()" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 px-4 py-2 rounded-lg transition-all duration-200">
                            <i class="fas fa-camera mr-2"></i>Selecionar Fotos
                        </button>
                        <p class="text-gray-400 text-sm mt-2">Clique para adicionar fotografias da etapa</p>
                        <div id="photoPreview" class="mt-4 grid grid-cols-2 gap-2 hidden"></div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeAddStageModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-save mr-2"></i>Salvar Etapa
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">Nova Postagem</h3>
                <button onclick="feedManager.closeCreatePostModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="createPostForm" class="space-y-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Descri√ß√£o</label>
                    <textarea id="postDescription" rows="4" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="O que est√° acontecendo na obra?" required></textarea>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Obra Relacionada (Opcional)</label>
                    <select id="postObra" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" class="bg-gray-800">Selecione uma obra</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">M√≠dia</label>
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center hover:border-white/40 transition-colors duration-200">
                        <input type="file" id="postMedia" multiple accept="image/*,video/*" class="hidden">
                        <button type="button" onclick="document.getElementById('postMedia').click()" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 px-4 py-2 rounded-lg transition-all duration-200">
                            <i class="fas fa-camera mr-2"></i>Adicionar Fotos/V√≠deos
                        </button>
                        <p class="text-gray-400 text-sm mt-2">Fotos em alta qualidade e v√≠deos at√© 60 segundos</p>
                        <div id="postMediaPreview" class="mt-4 grid grid-cols-2 gap-2 hidden"></div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="feedManager.closeCreatePostModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-share mr-2"></i>Publicar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Story Modal -->
    <div id="createStoryModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">Novo Story</h3>
                <button onclick="feedManager.closeCreateStoryModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="createStoryForm" class="space-y-4">
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">M√≠dia do Story</label>
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center hover:border-white/40 transition-colors duration-200">
                        <input type="file" id="storyMedia" accept="image/*,video/*" class="hidden" required>
                        <button type="button" onclick="document.getElementById('storyMedia').click()" class="bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 px-4 py-2 rounded-lg transition-all duration-200">
                            <i class="fas fa-camera mr-2"></i>Selecionar Foto/V√≠deo
                        </button>
                        <p class="text-gray-400 text-sm mt-2">Foto ou v√≠deo at√© 15 segundos</p>
                        <div id="storyMediaPreview" class="mt-4 hidden"></div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Texto (Opcional)</label>
                    <input type="text" id="storyText" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Adicione um texto ao seu story">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="feedManager.closeCreateStoryModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i>Publicar Story
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Access History Modal -->
    <div id="accessHistoryModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white mb-1">Hist√≥rico de Acesso e Atividades</h3>
                    <p class="text-gray-300 text-sm">Registro completo de acessos e intera√ß√µes no sistema</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="exportAccessHistory()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>
                    <button onclick="clearAccessHistory()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-trash mr-2"></i>Limpar
                    </button>
                    <button onclick="closeAccessHistoryModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Filter and Search -->
            <div class="glassmorphism bg-white/5 rounded-xl p-4 mb-6">
                <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4">
                    <div class="relative flex-1 w-full">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input 
                            type="text" 
                            id="historySearchInput" 
                            placeholder="Buscar por usu√°rio, a√ß√£o ou data..." 
                            class="w-full pl-10 pr-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                        >
                    </div>
                    <div class="flex items-center space-x-2">
                        <select id="historyUserFilter" class="bg-white/10 border border-white/20 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all" class="bg-gray-800">Todos os Usu√°rios</option>
                        </select>
                        <select id="historyActionFilter" class="bg-white/10 border border-white/20 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all" class="bg-gray-800">Todas as A√ß√µes</option>
                            <option value="login" class="bg-gray-800">Login</option>
                            <option value="logout" class="bg-gray-800">Logout</option>
                            <option value="create" class="bg-gray-800">Cria√ß√£o</option>
                            <option value="edit" class="bg-gray-800">Edi√ß√£o</option>
                            <option value="delete" class="bg-gray-800">Exclus√£o</option>
                            <option value="view" class="bg-gray-800">Visualiza√ß√£o</option>
                        </select>
                        <select id="historyDateFilter" class="bg-white/10 border border-white/20 text-white rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all" class="bg-gray-800">Todo o Per√≠odo</option>
                            <option value="today" class="bg-gray-800">Hoje</option>
                            <option value="week" class="bg-gray-800">Esta Semana</option>
                            <option value="month" class="bg-gray-800">Este M√™s</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="glassmorphism bg-white/5 rounded-xl p-4 text-center">
                    <i class="fas fa-users text-2xl text-blue-400 mb-2"></i>
                    <p class="text-white font-semibold" id="totalUsers">0</p>
                    <p class="text-gray-300 text-sm">Usu√°rios √önicos</p>
                </div>
                <div class="glassmorphism bg-white/5 rounded-xl p-4 text-center">
                    <i class="fas fa-sign-in-alt text-2xl text-green-400 mb-2"></i>
                    <p class="text-white font-semibold" id="totalLogins">0</p>
                    <p class="text-gray-300 text-sm">Total de Logins</p>
                </div>
                <div class="glassmorphism bg-white/5 rounded-xl p-4 text-center">
                    <i class="fas fa-mouse-pointer text-2xl text-purple-400 mb-2"></i>
                    <p class="text-white font-semibold" id="totalActions">0</p>
                    <p class="text-gray-300 text-sm">A√ß√µes Realizadas</p>
                </div>
                <div class="glassmorphism bg-white/5 rounded-xl p-4 text-center">
                    <i class="fas fa-clock text-2xl text-yellow-400 mb-2"></i>
                    <p class="text-white font-semibold" id="avgSessionTime">0min</p>
                    <p class="text-gray-300 text-sm">Tempo M√©dio</p>
                </div>
            </div>
            
            <!-- History Table -->
            <div class="glassmorphism bg-white/5 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-white/10">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Data/Hora</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Usu√°rio</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">A√ß√£o</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Detalhes</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">IP</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-white/10">
                            <!-- History entries will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="historyEmptyState" class="text-center py-12 hidden">
                    <i class="fas fa-history text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-300 text-lg font-medium">Nenhum registro encontrado</p>
                    <p class="text-gray-400 text-sm">Ajuste os filtros ou aguarde novas atividades</p>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="flex items-center justify-between mt-6">
                <div class="text-sm text-gray-300">
                    Mostrando <span id="historyShowingStart">0</span> a <span id="historyShowingEnd">0</span> de <span id="historyTotal">0</span> registros
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="historySystem.previousPage()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg text-sm transition-all duration-200" id="historyPrevBtn">
                        <i class="fas fa-chevron-left mr-1"></i>Anterior
                    </button>
                    <span class="text-white text-sm">P√°gina <span id="historyCurrentPage">1</span> de <span id="historyTotalPages">1</span></span>
                    <button onclick="historySystem.nextPage()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg text-sm transition-all duration-200" id="historyNextBtn">
                        Pr√≥xima<i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trash Modal -->
    <div id="trashModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white mb-1 flex items-center">
                        <i class="fas fa-trash text-red-400 mr-2"></i>
                        Lixeira de Etapas
                    </h3>
                    <p class="text-gray-300 text-sm">Etapas exclu√≠das podem ser restauradas ou removidas permanentemente</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="clearTrash()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-trash mr-2"></i>Limpar Lixeira
                    </button>
                    <button onclick="modalSystem.close('trashModal')" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Trash Container -->
            <div id="trashContainer">
                <!-- Trash items will be generated here -->
            </div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div id="themeModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-2xl transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white">Personalizar Tema</h3>
                    <p class="text-gray-300 text-sm">Escolha o tema que melhor se adapta ao seu ambiente</p>
                </div>
                <button onclick="closeThemeModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="setTheme('dark')" class="flex items-center justify-between p-4 bg-gray-800 hover:bg-gray-700 rounded-xl transition-all duration-200 border-2 border-transparent" id="darkTheme">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-gray-800 to-gray-900 rounded-lg border border-gray-600 flex items-center justify-center">
                            <i class="fas fa-moon text-gray-300"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-medium">Tema Escuro</p>
                            <p class="text-gray-400 text-sm">Padr√£o do sistema</p>
                        </div>
                    </div>
                    <i class="fas fa-check text-blue-400 hidden"></i>
                </button>
                
                <button onclick="setTheme('light')" class="flex items-center justify-between p-4 bg-white hover:bg-gray-50 rounded-xl transition-all duration-200 border-2 border-transparent" id="lightTheme">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-white to-gray-100 rounded-lg border border-gray-300 flex items-center justify-center">
                            <i class="fas fa-sun text-yellow-500"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-gray-800 font-medium">Tema Claro</p>
                            <p class="text-gray-600 text-sm">Ambientes claros</p>
                        </div>
                    </div>
                    <i class="fas fa-check text-blue-500 hidden"></i>
                </button>
                
                <button onclick="setTheme('blue')" class="flex items-center justify-between p-4 bg-blue-600 hover:bg-blue-700 rounded-xl transition-all duration-200 border-2 border-transparent" id="blueTheme">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center">
                            <i class="fas fa-briefcase text-white"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-medium">Azul Profissional</p>
                            <p class="text-blue-200 text-sm">Corporativo</p>
                        </div>
                    </div>
                    <i class="fas fa-check text-white hidden"></i>
                </button>
                
                <button onclick="setTheme('green')" class="flex items-center justify-between p-4 bg-green-600 hover:bg-green-700 rounded-xl transition-all duration-200 border-2 border-transparent" id="greenTheme">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-700 rounded-lg flex items-center justify-center">
                            <i class="fas fa-leaf text-white"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-medium">Verde Natureza</p>
                            <p class="text-green-200 text-sm">Sustent√°vel</p>
                        </div>
                    </div>
                    <i class="fas fa-check text-white hidden"></i>
                </button>
                
                <button onclick="setTheme('blackfull')" class="flex items-center justify-between p-4 bg-black hover:bg-gray-900 rounded-xl transition-all duration-200 border-2 border-transparent" id="blackfullTheme">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-black to-gray-800 rounded-lg border border-cyan-400 flex items-center justify-center">
                            <i class="fas fa-moon text-cyan-400"></i>
                        </div>
                        <div class="text-left">
                            <p class="text-white font-medium">Black Full</p>
                            <p class="text-cyan-400 text-sm">Neon & Preto Fosco</p>
                        </div>
                    </div>
                    <i class="fas fa-check text-cyan-400 hidden"></i>
                </button>
            </div>
            
            <div class="mt-6 pt-4 border-t border-white/20 flex items-center justify-between">
                <div class="text-gray-400 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    O tema ser√° salvo automaticamente
                </div>
                <button onclick="closeThemeModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-xl font-medium transition-all duration-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Dispensa√ß√£o de Produto -->
    <div id="dispensarModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-md transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">Dispensar Produto</h3>
                <button onclick="modalSystem.close('dispensarModal')" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="dispensarForm" class="space-y-4">
                <input type="hidden" id="dispensarProdutoId" value="">
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Produto</label>
                    <input type="text" id="dispensarProdutoNome" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white" readonly>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Quantidade a Dispensar</label>
                    <input type="number" id="dispensarQuantidade" min="1" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite a quantidade" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Local de Uso</label>
                    <input type="text" id="dispensarLocalUso" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Obra Centro Pop" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Nome do Solicitante</label>
                    <input type="text" id="dispensarSolicitante" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nome do respons√°vel" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Data da Dispensa√ß√£o</label>
                    <input type="date" id="dispensarData" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="modalSystem.close('dispensarModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-minus mr-2"></i>Dispensar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Produto -->
    <div id="editProductModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-md transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">Editar Produto</h3>
                <button onclick="modalSystem.close('editProductModal')" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editProductForm" class="space-y-4">
                <input type="hidden" id="editProdutoId" value="">
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Nome do Produto</label>
                    <input type="text" id="editProdutoNome" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Categoria</label>
                    <select id="editProdutoCategoria" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="cimento" class="bg-gray-800">Cimento</option>
                        <option value="alvenaria" class="bg-gray-800">Alvenaria</option>
                        <option value="agregados" class="bg-gray-800">Agregados</option>
                        <option value="ferragens" class="bg-gray-800">Ferragens</option>
                        <option value="tintas" class="bg-gray-800">Tintas</option>
                        <option value="ferramentas" class="bg-gray-800">Ferramentas</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">C√≥digo</label>
                    <input type="text" id="editProdutoCodigo" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Estoque</label>
                        <input type="number" id="editProdutoEstoque" min="0" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Estoque M√≠nimo</label>
                        <input type="number" id="editProdutoEstoqueMinimo" min="0" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Pre√ßo (R$)</label>
                        <input type="number" id="editProdutoPreco" min="0" step="0.01" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Unidade</label>
                        <input type="text" id="editProdutoUnidade" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: kg, m¬≥, unidade">
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Descri√ß√£o</label>
                    <textarea id="editProdutoDescricao" rows="3" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Descri√ß√£o do produto"></textarea>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="modalSystem.close('editProductModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Upload de Foto -->
    <div id="uploadFotoModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-md transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-white">Upload de Foto do Produto</h3>
                <button onclick="modalSystem.close('uploadFotoModal')" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="uploadFotoForm" class="space-y-4">
                <input type="hidden" id="fotoProdutoId" value="">
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Produto</label>
                    <input type="text" id="fotoProdutoNome" class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white" readonly>
                </div>
                
                <div>
                    <label class="block text-gray-300 text-sm font-medium mb-2">Foto do Produto (PNG)</label>
                    <div class="border-2 border-dashed border-white/20 rounded-xl p-6 text-center">
                        <input type="file" id="fotoInput" accept=".png" class="hidden">
                        <div id="fotoDropZone" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-white font-medium mb-2">Clique para selecionar ou arraste a foto aqui</p>
                            <p class="text-gray-400 text-sm">Apenas arquivos PNG s√£o aceitos</p>
                        </div>
                        <div id="fotoPreview" class="hidden mt-4">
                            <img id="fotoPreviewImg" class="max-w-full h-32 object-cover rounded-lg mx-auto">
                            <p id="fotoFileName" class="text-gray-300 text-sm mt-2"></p>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="modalSystem.close('uploadFotoModal')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-medium transition-all duration-200">
                        <i class="fas fa-upload mr-2"></i>Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Hist√≥rico de Movimenta√ß√µes do Produto -->
    <div id="historicoMovimentacoesModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white mb-1">Hist√≥rico de Movimenta√ß√µes</h3>
                    <p class="text-gray-300 text-sm">
                        <span id="historicoProdutoNome" class="font-medium"></span> - 
                        C√≥digo: <span id="historicoProdutoCodigo" class="font-medium"></span>
                    </p>
                </div>
                <button onclick="modalSystem.close('historicoMovimentacoesModal')" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Tabela de Movimenta√ß√µes -->
            <div class="glassmorphism bg-white/5 rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-white/10">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Quantidade</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Estoque Anterior</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Estoque Atual</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Motivo</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Usu√°rio</th>
                            </tr>
                        </thead>
                        <tbody id="historicoMovimentacoesBody" class="divide-y divide-white/10">
                            <!-- Movimenta√ß√µes ser√£o carregadas aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Hist√≥rico de Dispensa√ß√£o Modal -->
    <div id="historicoDispensacaoModal" class="modal-overlay hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="modal-content glassmorphism bg-white/10 rounded-2xl p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white mb-1">Hist√≥rico de Dispensa√ß√£o</h3>
                    <p class="text-gray-300 text-sm">Visualize todas as movimenta√ß√µes de estoque e dispensa√ß√µes</p>
                </div>
                <button onclick="closeHistoricoDispensacaoModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Filtros -->
            <div class="glassmorphism bg-white/5 rounded-xl p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Buscar</label>
                        <input type="text" id="historicoSearch" placeholder="Produto, usu√°rio..." class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Tipo</label>
                        <select id="historicoTipoFilter" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                            <option value="all" class="bg-gray-800">Todos</option>
                            <option value="entrada" class="bg-gray-800">Entrada</option>
                            <option value="saida" class="bg-gray-800">Sa√≠da</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Data Inicial</label>
                        <input type="date" id="historicoDataInicio" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-medium mb-2">Data Final</label>
                        <input type="date" id="historicoDataFim" class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                    <button onclick="filtrarHistoricoDispensacao()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200">
                        <i class="fas fa-filter mr-2"></i>Filtrar
                    </button>
                </div>
            </div>
            
            <!-- Lista de Movimenta√ß√µes -->
            <div id="historicoDispensacaoList" class="space-y-3">
                <!-- Movimenta√ß√µes ser√£o carregadas aqui -->
            </div>
            
            <!-- Pagina√ß√£o -->
            <div id="historicoPagination" class="flex justify-center mt-6">
                <!-- Pagina√ß√£o ser√° carregada aqui -->
            </div>
        </div>
    </div>

    <script>
        // History System
        const historySystem = {
            history: [],
            currentPage: 1,
            itemsPerPage: 20,
            filteredHistory: [],
            
            init() {
                this.loadHistory();
                this.setupEventListeners();
            },
            
            loadHistory() {
                // Load from localStorage or initialize with sample data
                const savedHistory = localStorage.getItem('semcas_access_history');
                if (savedHistory) {
                    this.history = JSON.parse(savedHistory).map(entry => ({
                        ...entry,
                        timestamp: new Date(entry.timestamp)
                    }));
                } else {
                    // Initialize with some sample data
                    this.history = [
                        {
                            id: 1,
                            timestamp: new Date(Date.now() - 3600000), // 1 hour ago
                            user: 'Sistema',
                            userType: 'admin',
                            action: 'login',
                            type: 'Autentica√ß√£o',
                            details: 'Sistema inicializado',
                            ip: '192.168.1.100',
                            status: 'success',
                            sessionId: 'sess_001'
                        }
                    ];
                }
                this.filteredHistory = [...this.history];
                this.updateDisplay();
            },
            
            saveHistory() {
                localStorage.setItem('semcas_access_history', JSON.stringify(this.history));
            },
            
            addEntry(action, type, details, status = 'success') {
                const currentUser = authSystem.currentUser || { username: 'Sistema', userType: 'system' };
                
                const entry = {
                    id: this.history.length + 1,
                    timestamp: new Date(),
                    user: currentUser.username,
                    userType: currentUser.userType,
                    action: action,
                    type: type,
                    details: details,
                    ip: this.getClientIP(),
                    status: status,
                    sessionId: this.getCurrentSessionId()
                };
                
                this.history.unshift(entry);
                this.saveHistory();
                
                // Update display if modal is open
                const modal = document.getElementById('accessHistoryModal');
                if (modal && !modal.classList.contains('hidden')) {
                    this.applyFilters();
                }
            },
            
            getClientIP() {
                // Simulate IP detection (in real app, this would come from server)
                return '192.168.1.' + Math.floor(Math.random() * 255);
            },
            
            getCurrentSessionId() {
                if (!this.sessionId) {
                    this.sessionId = 'sess_' + Math.random().toString(36).substr(2, 9);
                }
                return this.sessionId;
            },
            
            setupEventListeners() {
                // Search input
                document.getElementById('historySearchInput')?.addEventListener('input', (e) => {
                    this.applyFilters();
                });
                
                // Filter selects
                document.getElementById('historyUserFilter')?.addEventListener('change', (e) => {
                    this.applyFilters();
                });
                
                document.getElementById('historyActionFilter')?.addEventListener('change', (e) => {
                    this.applyFilters();
                });
                
                document.getElementById('historyDateFilter')?.addEventListener('change', (e) => {
                    this.applyFilters();
                });
            },
            
            applyFilters() {
                const searchTerm = document.getElementById('historySearchInput')?.value.toLowerCase() || '';
                const userFilter = document.getElementById('historyUserFilter')?.value || 'all';
                const actionFilter = document.getElementById('historyActionFilter')?.value || 'all';
                const dateFilter = document.getElementById('historyDateFilter')?.value || 'all';
                
                this.filteredHistory = this.history.filter(entry => {
                    // Search filter
                    const matchesSearch = !searchTerm || 
                        entry.user.toLowerCase().includes(searchTerm) ||
                        entry.action.toLowerCase().includes(searchTerm) ||
                        entry.details.toLowerCase().includes(searchTerm) ||
                        entry.type.toLowerCase().includes(searchTerm);
                    
                    // User filter
                    const matchesUser = userFilter === 'all' || entry.user === userFilter;
                    
                    // Action filter
                    const matchesAction = actionFilter === 'all' || entry.action === actionFilter;
                    
                    // Date filter
                    const matchesDate = this.matchesDateFilter(entry.timestamp, dateFilter);
                    
                    return matchesSearch && matchesUser && matchesAction && matchesDate;
                });
                
                this.currentPage = 1;
                this.updateDisplay();
            },
            
            matchesDateFilter(timestamp, filter) {
                if (filter === 'all') return true;
                
                const now = new Date();
                const entryDate = new Date(timestamp);
                
                switch (filter) {
                    case 'today':
                        return entryDate.toDateString() === now.toDateString();
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return entryDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return entryDate >= monthAgo;
                    default:
                        return true;
                }
            },
            
            updateDisplay() {
                this.updateStatistics();
                this.updateUserFilter();
                this.renderTable();
                this.updatePagination();
            },
            
            updateStatistics() {
                const uniqueUsers = [...new Set(this.history.map(entry => entry.user))].length;
                const totalLogins = this.history.filter(entry => entry.action === 'login').length;
                const totalActions = this.history.length;
                
                // Calculate average session time (simplified)
                const avgSessionTime = Math.floor(Math.random() * 45) + 15; // Simulate 15-60 minutes
                
                document.getElementById('totalUsers').textContent = uniqueUsers;
                document.getElementById('totalLogins').textContent = totalLogins;
                document.getElementById('totalActions').textContent = totalActions;
                document.getElementById('avgSessionTime').textContent = avgSessionTime + 'min';
            },
            
            updateUserFilter() {
                const userFilter = document.getElementById('historyUserFilter');
                if (!userFilter) return;
                
                const uniqueUsers = [...new Set(this.history.map(entry => entry.user))];
                const currentValue = userFilter.value;
                
                userFilter.innerHTML = '<option value="all" class="bg-gray-800">Todos os Usu√°rios</option>';
                
                uniqueUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    option.className = 'bg-gray-800';
                    userFilter.appendChild(option);
                });
                
                userFilter.value = currentValue;
            },
            
            renderTable() {
                const tbody = document.getElementById('historyTableBody');
                const emptyState = document.getElementById('historyEmptyState');
                
                if (!tbody) return;
                
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageData = this.filteredHistory.slice(startIndex, endIndex);
                
                if (pageData.length === 0) {
                    tbody.innerHTML = '';
                    emptyState?.classList.remove('hidden');
                    return;
                }
                
                emptyState?.classList.add('hidden');
                
                tbody.innerHTML = pageData.map(entry => {
                    const statusColor = entry.status === 'success' ? 'text-green-400' : 
                                       entry.status === 'warning' ? 'text-yellow-400' : 'text-red-400';
                    
                    const actionIcon = this.getActionIcon(entry.action);
                    const typeColor = this.getTypeColor(entry.type);
                    
                    return `
                        <tr class="hover:bg-white/5 transition-colors duration-200">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                <div>
                                    <div class="font-medium">${entry.timestamp.toLocaleDateString('pt-BR')}</div>
                                    <div class="text-xs text-gray-400">${entry.timestamp.toLocaleTimeString('pt-BR')}</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-white text-xs font-bold">${entry.user.charAt(0).toUpperCase()}</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-white">${entry.user}</div>
                                        <div class="text-xs text-gray-400 capitalize">${entry.userType}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeColor}">
                                    ${entry.type}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
                                <div class="flex items-center">
                                    <i class="fas ${actionIcon} mr-2 text-gray-400"></i>
                                    <span class="capitalize">${entry.action}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-300 max-w-xs truncate">
                                ${entry.details}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 font-mono">
                                ${entry.ip}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="inline-flex items-center ${statusColor}">
                                    <i class="fas ${entry.status === 'success' ? 'fa-check-circle' : entry.status === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle'} mr-1"></i>
                                    <span class="capitalize">${entry.status === 'success' ? 'Sucesso' : entry.status === 'warning' ? 'Aviso' : 'Erro'}</span>
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            getActionIcon(action) {
                const icons = {
                    'login': 'fa-sign-in-alt',
                    'logout': 'fa-sign-out-alt',
                    'create': 'fa-plus',
                    'edit': 'fa-edit',
                    'delete': 'fa-trash',
                    'view': 'fa-eye',
                    'download': 'fa-download',
                    'upload': 'fa-upload'
                };
                return icons[action] || 'fa-circle';
            },
            
            getTypeColor(type) {
                const colors = {
                    'Autentica√ß√£o': 'bg-blue-100 text-blue-800',
                    'Navega√ß√£o': 'bg-green-100 text-green-800',
                    'Cria√ß√£o': 'bg-purple-100 text-purple-800',
                    'Edi√ß√£o': 'bg-yellow-100 text-yellow-800',
                    'Exclus√£o': 'bg-red-100 text-red-800',
                    'Sistema': 'bg-gray-100 text-gray-800'
                };
                return colors[type] || 'bg-gray-100 text-gray-800';
            },
            
            updatePagination() {
                const totalPages = Math.ceil(this.filteredHistory.length / this.itemsPerPage);
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = Math.min(startIndex + this.itemsPerPage, this.filteredHistory.length);
                
                document.getElementById('historyCurrentPage').textContent = this.currentPage;
                document.getElementById('historyTotalPages').textContent = totalPages;
                document.getElementById('historyShowingStart').textContent = startIndex + 1;
                document.getElementById('historyShowingEnd').textContent = endIndex;
                document.getElementById('historyTotal').textContent = this.filteredHistory.length;
                
                document.getElementById('historyPrevBtn').disabled = this.currentPage === 1;
                document.getElementById('historyNextBtn').disabled = this.currentPage === totalPages;
            },
            
            previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.renderTable();
                    this.updatePagination();
                }
            },
            
            nextPage() {
                const totalPages = Math.ceil(this.filteredHistory.length / this.itemsPerPage);
                if (this.currentPage < totalPages) {
                    this.currentPage++;
                    this.renderTable();
                    this.updatePagination();
                }
            },
            
            exportHistory() {
                const csvContent = this.generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `historico_acesso_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                toastSystem.show('Hist√≥rico exportado com sucesso!', 'success');
            },
            
            generateCSV() {
                const headers = ['Data/Hora', 'Usu√°rio', 'Tipo de Usu√°rio', 'Tipo', 'A√ß√£o', 'Detalhes', 'IP', 'Status'];
                const csvRows = [headers.join(',')];
                
                this.filteredHistory.forEach(entry => {
                    const row = [
                        `"${entry.timestamp.toLocaleString('pt-BR')}"`,
                        `"${entry.user}"`,
                        `"${entry.userType}"`,
                        `"${entry.type}"`,
                        `"${entry.action}"`,
                        `"${entry.details}"`,
                        `"${entry.ip}"`,
                        `"${entry.status}"`
                    ];
                    csvRows.push(row.join(','));
                });
                
                return csvRows.join('\n');
            },
            
            clearHistory() {
                if (confirm('Tem certeza que deseja limpar todo o hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    this.history = [];
                    this.filteredHistory = [];
                    this.saveHistory();
                    this.updateDisplay();
                    toastSystem.show('Hist√≥rico limpo com sucesso!', 'success');
                }
            }
        };

        // Authentication System
        const authSystem = {
            currentUser: null,
            
            login(username, userType, password) {
                if (!username || !userType) {
                    toastSystem.show("Por favor, preencha todos os campos!", "error");
                    return false;
                }

                // Validate password only if provided
                if (password && password !== "Master123") {
                    toastSystem.show("Senha incorreta!", "error");
                    return false;
                }

                // Allow login without password for backward compatibility
                if (!password) {
                    // No password required for backward compatibility
                }
                
                this.currentUser = {
                    username: username.trim(),
                    userType: userType,
                    loginTime: new Date()
                };
                
                // Log the login action
                historySystem.addEntry('login', 'Autentica√ß√£o', `Login realizado com sucesso - Tipo: ${userType}`, 'success');
                
                return true;
            },
            
            logout() {
                if (this.currentUser) {
                    historySystem.addEntry('logout', 'Autentica√ß√£o', 'Logout realizado pelo usu√°rio', 'success');
                }
                this.currentUser = null;
                historySystem.sessionId = null;
            },
            
            isAuthenticated() {
                return this.currentUser !== null;
            }
        };

        // Toast System
        const toastSystem = {
            show(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                
                const colors = {
                    success: 'bg-green-600',
                    error: 'bg-red-600',
                    warning: 'bg-yellow-600',
                    info: 'bg-blue-600'
                };
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                toast.className = `toast ${colors[type]} text-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3 min-w-80`;
                toast.innerHTML = `
                    <i class="fas ${icons[type]} text-xl"></i>
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.remove()" class="text-white/80 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        };

        // UI System
        const ui = {
            currentTab: 'dashboard',
            
            switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                const targetContent = document.getElementById(`${tabName}-content`);
                if (targetContent) {
                    targetContent.classList.remove('hidden');
                    targetContent.classList.add('tab-slide-in');
                }
                
                document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                    btn.classList.remove('active', 'text-blue-400');
                    btn.classList.add('text-gray-400');
                });
                
                document.querySelectorAll(`[data-tab="${tabName}"]`).forEach(btn => {
                    btn.classList.add('active', 'text-blue-400');
                    btn.classList.remove('text-gray-400');
                });
                
                this.currentTab = tabName;
                
                // Log navigation
                const tabNames = {
                    'dashboard': 'Dashboard',
                    'obras': 'Obras',
                    'estoque': 'Estoque',
                    'feed': 'Feed',
                    'graficos': 'Gr√°ficos',
                    'relatorios': 'Relat√≥rios'
                };
                historySystem.addEntry('view', 'Navega√ß√£o', `Acessou aba: ${tabNames[tabName] || tabName}`, 'success');
                
                if (tabName === 'graficos') {
                    setTimeout(() => this.initializeCharts(), 100);
                }
            },
            
            initializeCharts() {
                // Initialize charts when graphics tab is opened
                if (typeof Chart !== 'undefined') {
                    this.createProdutosChart();
                    this.createMovimentacaoChart();
                    this.createProgressoChart();
                    this.createValoresChart();
                }
            },
            
            createProdutosChart() {
                const ctx = document.getElementById('produtosChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Cimento', 'Alvenaria', 'Agregados', 'Ferragens', 'Tintas'],
                        datasets: [{
                            data: [35, 25, 20, 15, 5],
                            backgroundColor: [
                                '#3B82F6',
                                '#EF4444',
                                '#F59E0B',
                                '#10B981',
                                '#8B5CF6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#D1D5DB'
                                }
                            }
                        }
                    }
                });
            },
            
            createMovimentacaoChart() {
                const ctx = document.getElementById('movimentacaoChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'],
                        datasets: [{
                            label: 'Entradas',
                            data: [12, 19, 15, 25, 22, 18, 20],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Sa√≠das',
                            data: [8, 15, 12, 18, 16, 14, 17],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#D1D5DB'
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: {
                                    color: '#D1D5DB'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#D1D5DB'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            },
            
            createProgressoChart() {
                const ctx = document.getElementById('progressoChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Centro POP Cohab', 'Centro POP Centro'],
                        datasets: [{
                            label: 'Progresso (%)',
                            data: [80, 20],
                            backgroundColor: [
                                '#8B5CF6',
                                '#F59E0B'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#D1D5DB'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: '#D1D5DB'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#D1D5DB'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            },
            
            createValoresChart() {
                const ctx = document.getElementById('valoresChart');
                if (!ctx) return;
                
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Obras', 'Estoque', 'Equipamentos', 'Outros'],
                        datasets: [{
                            data: [45, 30, 15, 10],
                            backgroundColor: [
                                '#F59E0B',
                                '#10B981',
                                '#3B82F6',
                                '#8B5CF6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#D1D5DB'
                                }
                            }
                        }
                    }
                });
            }
        };

        // Data Management
        const dataManager = {
            obras: [],
            produtos: [],
            
            // Carregar dados da API
            async loadObras() {
                try {
                    const response = await fetch('/api/obras');
                    if (response.ok) {
                        this.obras = await response.json();
                        // Carregar etapas para cada obra
                        for (let obra of this.obras) {
                            await this.loadEtapas(obra.id);
                        }
                        this.updateUI();
                    }
                } catch (error) {
                    console.error('Erro ao carregar obras:', error);
                }
            },
            
            async loadEtapas(obraId) {
                try {
                    const response = await fetch(`/api/obras/${obraId}/etapas`);
                    if (response.ok) {
                        const etapas = await response.json();
                        const obra = this.obras.find(o => o.id === obraId);
                        if (obra) {
                            obra.timeline = etapas.map(etapa => ({
                                id: etapa.id,
                                titulo: etapa.titulo,
                                descricao: etapa.descricao,
                                data: etapa.data_etapa,
                                status: 'completed',
                                fotos: JSON.parse(etapa.fotos || '[]')
                            }));
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar etapas:', error);
                }
            },
            
            async loadProdutos() {
                try {
                    const response = await fetch('/api/produtos');
                    if (response.ok) {
                        this.produtos = await response.json();
                        this.updateUI();
                    }
                } catch (error) {
                    console.error('Erro ao carregar produtos:', error);
                }
            },
            
            updateUI() {
                // Atualizar dashboard
                this.updateDashboard();
                // Atualizar lista de obras
                this.updateObrasList();
                // Atualizar lista de produtos
                this.updateProdutosList();
            },
            
            updateDashboard() {
                const obrasAtivas = this.obras.filter(obra => obra.status === 'Em Andamento').length;
                const obrasConcluidas = this.obras.filter(obra => obra.status === 'Conclu√≠da').length;
                const progressoMedio = this.obras.length > 0 ? 
                    Math.round(this.obras.reduce((acc, obra) => acc + obra.progresso, 0) / this.obras.length) : 0;
                const valorObras = this.obras.reduce((acc, obra) => acc + (obra.valor || 0), 0);
                const valorEstoque = this.produtos.reduce((acc, produto) => acc + (produto.estoque * produto.preco), 0);
                const valorGeral = valorObras + valorEstoque;
                
                document.getElementById('obrasAtivas').textContent = obrasAtivas;
                document.getElementById('obrasConcluidas').textContent = obrasConcluidas;
                document.getElementById('progressoMedio').textContent = progressoMedio + '%';
                document.getElementById('valorObras').textContent = `R$ ${valorObras.toLocaleString('pt-BR')}`;
                document.getElementById('valorEstoque').textContent = `R$ ${valorEstoque.toLocaleString('pt-BR')}`;
                document.getElementById('valorGeral').textContent = `R$ ${valorGeral.toLocaleString('pt-BR')}`;
            },
            
            updateObrasList() {
                // Atualizar a lista de obras na interface
                if (ui.currentTab === 'obras') {
                    dataManager.renderObras();
                }
            },
            
            updateProdutosList() {
                // Atualizar a lista de produtos na interface
                if (ui.currentTab === 'estoque') {
                    dataManager.renderProdutos();
                }
            },
            
            // Inicializar dados
            async init() {
                await this.loadObras();
                await this.loadProdutos();
            },
            
            async addObra(obra) {
                try {
                    const response = await fetch('/api/obras', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(obra)
                    });
                    
                    if (response.ok) {
                        await this.loadObras();
                        historySystem.addEntry('create', 'Cria√ß√£o', `Nova obra criada: ${obra.nome}`, 'success');
                    }
                } catch (error) {
                    console.error('Erro ao adicionar obra:', error);
                }
            },
            
            async updateObra(obraId, updatedData) {
                try {
                    const response = await fetch(`/api/obras/${obraId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updatedData)
                    });
                    
                    if (response.ok) {
                        await this.loadObras();
                        historySystem.addEntry('edit', 'Edi√ß√£o', `Obra editada: ${updatedData.nome}`, 'success');
                        return true;
                    }
                } catch (error) {
                    console.error('Erro ao atualizar obra:', error);
                }
                return false;
            },
            
            getObraById(id) {
                return this.obras.find(obra => obra.id === id);
            },
            
            async addProduto(produto) {
                try {
                    const response = await fetch('/api/produtos', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(produto)
                    });
                    
                    if (response.ok) {
                        await this.loadProdutos();
                        historySystem.addEntry('create', 'Cria√ß√£o', `Novo produto adicionado: ${produto.nome}`, 'success');
                    }
                } catch (error) {
                    console.error('Erro ao adicionar produto:', error);
                }
            },
            
            renderObras() {
                const grid = document.getElementById('obrasGrid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                this.obras.forEach(obra => {
                    const statusColor = obra.status === 'Em Andamento' ? 'text-yellow-400' : 'text-green-400';
                    const progressColor = obra.progresso < 30 ? 'bg-red-500' : obra.progresso < 70 ? 'bg-yellow-500' : 'bg-green-500';
                    
                    const card = document.createElement('div');
                    card.className = 'glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">${obra.nome}</h3>
                            <span class="${statusColor} text-sm font-medium">${obra.status}</span>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center text-gray-300 text-sm">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                ${obra.localizacao}
                            </div>
                            
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-300">Progresso</span>
                                <span class="text-white font-medium">${obra.progresso}%</span>
                            </div>
                            
                            <div class="w-full bg-white/10 rounded-full h-2">
                                <div class="${progressColor} obra-progress-bar h-2 rounded-full" style="width: ${obra.progresso}%"></div>
                            </div>
                            
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-300">Valor</span>
                                <span class="text-green-400 font-medium">${typeof obra.valor === 'string' ? obra.valor : `R$ ${obra.valor.toLocaleString('pt-BR')}`}</span>
                            </div>
                            
                            <div class="flex space-x-2 mt-4">
                                <button onclick="editObra(${obra.id})" class="flex-1 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 py-2 rounded-lg text-sm transition-all duration-200">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button onclick="openFurnitureModal(${obra.id})" class="flex-1 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 py-2 rounded-lg text-sm transition-all duration-200">
                                    <i class="fas fa-couch mr-1"></i>Mobili√°rio
                                </button>
                                <button onclick="openTimelineModal(${obra.id})" class="flex-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 py-2 rounded-lg text-sm transition-all duration-200">
                                    <i class="fas fa-history mr-1"></i>Hist√≥rico
                                </button>
                                <button onclick="viewObraDetails(${obra.id})" class="flex-1 bg-orange-600/20 hover:bg-orange-600/30 text-orange-400 py-2 rounded-lg text-sm transition-all duration-200">
                                    <i class="fas fa-eye mr-1"></i>Detalhes
                                </button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },
            
            renderProdutos() {
                const grid = document.getElementById('productsGrid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                this.produtos.forEach(produto => {
                    const stockStatus = produto.estoque <= produto.estoqueMinimo ? 'text-red-400' : 'text-green-400';
                    const stockIcon = produto.estoque <= produto.estoqueMinimo ? 'fa-exclamation-triangle' : 'fa-check-circle';
                    
                    const card = document.createElement('div');
                    card.className = 'glassmorphism bg-white/10 rounded-2xl p-6 shadow-lg hover:bg-white/15 transition-all duration-300';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">${produto.nome}</h3>
                            <i class="fas ${stockIcon} ${stockStatus}"></i>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-300">Categoria</span>
                                <span class="text-blue-400 capitalize">${produto.categoria}</span>
                            </div>
                            
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-300">Estoque</span>
                                <span class="${stockStatus} font-medium">${produto.estoque} unidades</span>
                            </div>
                            
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-300">Pre√ßo</span>
                                <span class="text-green-400 font-medium">R$ ${produto.preco.toFixed(2)}</span>
                            </div>
                            
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-gray-300">Valor Total</span>
                                <span class="text-yellow-400 font-medium">R$ ${(produto.estoque * produto.preco).toLocaleString('pt-BR')}</span>
                            </div>
                            
                            <div class="flex space-x-2 mt-4">
                                <button onclick="editProduct(${produto.id})" class="flex-1 bg-blue-600/20 hover:bg-blue-600/30 text-blue-400 py-2 rounded-lg text-sm transition-all duration-200">
                                    <i class="fas fa-edit mr-1"></i>Editar
                                </button>
                                <button onclick="dispensarProduct(${produto.id})" class="flex-1 bg-red-600/20 hover:bg-red-600/30 text-red-400 py-2 rounded-lg text-sm transition-all duration-200">
                                    <i class="fas fa-minus mr-1"></i>Dispensar
                                </button>
                                <button onclick="viewHistoricoProduct(${produto.id})" class="flex-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 py-2 rounded-lg text-sm transition-all duration-200">
                                    <i class="fas fa-history mr-1"></i>Hist√≥rico
                                </button>
                                <button onclick="uploadFotoProduct(${produto.id})" class="flex-1 bg-purple-600/20 hover:bg-purple-600/30 text-purple-400 py-2 rounded-lg text-sm transition-all duration-200">
                                    <i class="fas fa-camera mr-1"></i>Foto
                                </button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            },
            
            updateDashboard() {
                const obrasAtivas = this.obras.filter(obra => obra.status === 'Em Andamento').length;
                const progressoMedio = this.obras.length > 0 ? Math.round(this.obras.reduce((acc, obra) => acc + obra.progresso, 0) / this.obras.length) : 0;
                const valorObras = this.obras.reduce((acc, obra) => {
                    return acc + (typeof obra.valor === 'number' ? obra.valor : 0);
                }, 0);
                const valorEstoque = this.produtos.reduce((acc, produto) => acc + (produto.estoque * produto.preco), 0);
                const valorGeral = valorObras + valorEstoque;
                
                document.getElementById('obrasAtivas').textContent = obrasAtivas;
                document.getElementById('obrasConcluidas').textContent = this.obras.filter(obra => obra.status === 'Conclu√≠da').length;
                document.getElementById('progressoMedio').textContent = progressoMedio + '%';
                document.getElementById('valorObras').textContent = `R$ ${valorObras.toLocaleString('pt-BR')}`;
                document.getElementById('valorEstoque').textContent = `R$ ${valorEstoque.toLocaleString('pt-BR')}`;
                document.getElementById('valorGeral').textContent = `R$ ${valorGeral.toLocaleString('pt-BR')}`;
                
                // Update progress bar
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = progressoMedio + '%';
                }
            }
        };

        // Modal System
        const modalSystem = {
            open(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('show');
                    const content = modal.querySelector('.modal-content');
                    if (content) {
                        setTimeout(() => {
                            content.style.transform = 'scale(1)';
                            content.style.opacity = '1';
                        }, 10);
                    }
                }
            },
            
            close(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    const content = modal.querySelector('.modal-content');
                    if (content) {
                        content.style.transform = 'scale(0.95)';
                        content.style.opacity = '0';
                    }
                    setTimeout(() => {
                        modal.classList.remove('show');
                    }, 300);
                }
            }
        };

        // Report System
        const reportSystem = {
            checkPDFLibrary() {
                return new Promise((resolve) => {
                    if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                        resolve(true);
                    } else {
                        // Try to wait for library to load
                        let attempts = 0;
                        const checkInterval = setInterval(() => {
                            attempts++;
                            if (typeof window.jspdf !== 'undefined' && window.jspdf.jsPDF) {
                                clearInterval(checkInterval);
                                resolve(true);
                            } else if (attempts > 20) { // 2 seconds timeout
                                clearInterval(checkInterval);
                                resolve(false);
                            }
                        }, 100);
                    }
                });
            },
            
            async generateGeneralReport() {
                toastSystem.show('Gerando relat√≥rio geral...', 'info');
                
                const pdfAvailable = await this.checkPDFLibrary();
                if (!pdfAvailable) {
                    toastSystem.show('Erro: Biblioteca PDF n√£o carregou. Tente novamente.', 'error');
                    return;
                }
                
                setTimeout(() => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        // Helper function to create professional header
                        const createHeader = () => {
                            // Header background with gradient effect
                            doc.setFillColor(30, 58, 138);
                            doc.rect(0, 0, 210, 35, 'F');
                            
                            // SEMCAS logo area
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(22);
                            doc.setFont('helvetica', 'bold');
                            doc.text('SEMCAS', 15, 20);
                            
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Sistema de Gestao de Obras', 15, 28);
                            
                            // Document type
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text('RELATORIO GERAL', 120, 20);
                            
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Documento Oficial', 120, 28);
                        };
                        
                        // Helper function to create professional footer
                        const createFooter = (pageNum, totalPages) => {
                            doc.setDrawColor(59, 130, 246);
                            doc.setLineWidth(0.3);
                            doc.line(15, 280, 195, 280);
                            
                            doc.setTextColor(100, 100, 100);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'normal');
                            doc.text('SEMCAS - Sistema de Gestao de Obras | Documento Oficial', 15, 285);
                            doc.text('Pagina ' + pageNum + ' de ' + totalPages, 170, 285);
                            doc.text('Gerado em ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR'), 15, 290);
                        };
                        
                        createHeader();
                        
                        // Date and user info with professional styling
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Data de Geracao: ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR'), 15, 50);
                        doc.text('Responsavel: ' + (authSystem.currentUser?.username || 'Sistema'), 15, 58);
                        
                        // Summary section with enhanced styling
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('RESUMO EXECUTIVO', 15, 75);
                        
                        const valorTotalObras = dataManager.obras.reduce((acc, obra) => {
                            return acc + (typeof obra.valor === 'number' ? obra.valor : 0);
                        }, 0);
                        const valorTotalEstoque = dataManager.produtos.reduce((acc, prod) => acc + (prod.estoque * prod.preco), 0);
                        const valorGeral = valorTotalObras + valorTotalEstoque;
                        const progressoMedio = Math.round(dataManager.obras.reduce((acc, obra) => acc + obra.progresso, 0) / dataManager.obras.length);
                        
                        // Professional info box
                        doc.setFillColor(245, 247, 250);
                        doc.rect(15, 80, 180, 45, 'F');
                        doc.setDrawColor(59, 130, 246);
                        doc.setLineWidth(0.5);
                        doc.rect(15, 80, 180, 45);
                        
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Total de Obras: ' + dataManager.obras.length, 20, 90);
                        doc.text('Valor Total das Obras: R$ ' + valorTotalObras.toLocaleString('pt-BR'), 20, 98);
                        doc.text('Progresso Medio: ' + progressoMedio + '%', 20, 106);
                        doc.text('Valor Total Geral: R$ ' + valorGeral.toLocaleString('pt-BR'), 110, 90);
                        doc.text('Produtos em Estoque: ' + dataManager.produtos.length, 110, 98);
                        doc.text('Valor do Estoque: R$ ' + valorTotalEstoque.toLocaleString('pt-BR'), 110, 106);
                        
                        // Additional metrics
                        const obrasAtivas = dataManager.obras.filter(o => o.status === 'Em Andamento').length;
                        const produtosBaixoEstoque = dataManager.produtos.filter(p => p.estoque <= p.estoqueMinimo);
                        doc.text('Obras Ativas: ' + obrasAtivas, 20, 114);
                        doc.text('Produtos com Estoque Baixo: ' + produtosBaixoEstoque.length, 110, 114);
                        
                        let yPosition = 140;
                        
                        // Obras section with enhanced formatting
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('DETALHAMENTO DAS OBRAS', 15, yPosition);
                        yPosition += 10;
                        
                        dataManager.obras.forEach((obra, index) => {
                            if (yPosition > 240) {
                                createFooter('...', '...');
                                doc.addPage();
                                createHeader();
                                yPosition = 50;
                            }
                            
                            // Professional obra header
                            doc.setFillColor(59, 130, 246);
                            doc.rect(15, yPosition - 5, 180, 10, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(11);
                            doc.setFont('helvetica', 'bold');
                            doc.text((index + 1) + '. ' + obra.nome, 20, yPosition + 2);
                            yPosition += 15;
                            
                            // Obra details with better spacing
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Localizacao: ' + obra.localizacao, 20, yPosition);
                            doc.text('Progresso: ' + obra.progresso + '%', 20, yPosition + 6);
                            doc.text('Valor: R$ ' + obra.valor.toLocaleString('pt-BR'), 20, yPosition + 12);
                            doc.text('Status: ' + obra.status, 20, yPosition + 18);
                            doc.text('Data de Inicio: ' + (obra.dataInicio ? new Date(obra.dataInicio).toLocaleDateString('pt-BR') : 'N/A'), 20, yPosition + 24);
                            yPosition += 35;
                        });
                        
                        // Stock section with enhanced details
                        if (yPosition > 180) {
                            createFooter('...', '...');
                            doc.addPage();
                            createHeader();
                            yPosition = 50;
                        }
                        
                        yPosition += 10;
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('ANALISE DO ESTOQUE', 15, yPosition);
                        yPosition += 15;
                        
                        // Stock summary box
                        doc.setFillColor(245, 247, 250);
                        doc.rect(15, yPosition, 180, 30, 'F');
                        doc.setDrawColor(16, 185, 129);
                        doc.setLineWidth(0.5);
                        doc.rect(15, yPosition, 180, 30);
                        
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Valor total em estoque: R$ ' + valorTotalEstoque.toLocaleString('pt-BR'), 20, yPosition + 10);
                        doc.text('Total de produtos cadastrados: ' + dataManager.produtos.length, 20, yPosition + 18);
                        doc.text('Produtos com estoque baixo: ' + produtosBaixoEstoque.length, 20, yPosition + 26);
                        
                        yPosition += 40;
                        
                        // Low stock alert if any
                        if (produtosBaixoEstoque.length > 0) {
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(239, 68, 68);
                            doc.text('PRODUTOS COM ESTOQUE BAIXO', 15, yPosition);
                            yPosition += 10;
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            
                            produtosBaixoEstoque.forEach((produto, index) => {
                                if (yPosition > 260) {
                                    createFooter('...', '...');
                                    doc.addPage();
                                    createHeader();
                                    yPosition = 50;
                                }
                                doc.text(produto.nome + ': ' + produto.estoque + ' unidades (min: ' + produto.estoqueMinimo + ')', 20, yPosition);
                                yPosition += 6;
                            });
                        }
                        
                        // Update all page footers with correct page numbers
                        const totalPages = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            doc.setPage(i);
                            createFooter(i, totalPages);
                        }
                        
                        doc.save('relatorio_geral_' + new Date().toISOString().split('T')[0] + '.pdf');
                        toastSystem.show('Relatorio geral gerado com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao gerar relatorio geral:', error);
                        toastSystem.show('Erro ao gerar relatorio geral', 'error');
                    }
                }, 1000);
            },
            
            async generateWorksReport() {
                toastSystem.show('Gerando relat√≥rio de obras...', 'info');
                
                const pdfAvailable = await this.checkPDFLibrary();
                if (!pdfAvailable) {
                    toastSystem.show('Erro: Biblioteca PDF n√£o carregou. Tente novamente.', 'error');
                    return;
                }
                
                setTimeout(() => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        // Helper function to create professional header
                        const createHeader = () => {
                            // Header background with gradient effect
                            doc.setFillColor(30, 58, 138);
                            doc.rect(0, 0, 210, 35, 'F');
                            
                            // SEMCAS logo area
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(22);
                            doc.setFont('helvetica', 'bold');
                            doc.text('SEMCAS', 15, 20);
                            
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Sistema de Gest√£o de Obras', 15, 28);
                            
                            // Document type
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text('RELATORIO DE OBRAS', 120, 20);
                            
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Documento Oficial', 120, 28);
                        };
                        
                        // Helper function to create professional footer
                        const createFooter = (pageNum, totalPages) => {
                            doc.setDrawColor(59, 130, 246);
                            doc.setLineWidth(0.3);
                            doc.line(15, 280, 195, 280);
                            
                            doc.setTextColor(100, 100, 100);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'normal');
                            doc.text('SEMCAS - Sistema de Gestao de Obras | Documento Oficial', 15, 285);
                            doc.text('Pagina ' + pageNum + ' de ' + totalPages, 170, 285);
                            doc.text('Gerado em ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR'), 15, 290);
                        };
                        
                        createHeader();
                        
                        // Date and user info with professional styling
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Data de Geracao: ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR'), 15, 50);
                        doc.text('Responsavel: ' + (authSystem.currentUser?.username || 'Sistema'), 15, 58);
                        
                        // Summary section
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('RESUMO DAS OBRAS', 15, 75);
                        
                        const valorTotalObras = dataManager.obras.reduce((acc, obra) => {
                            return acc + (typeof obra.valor === 'number' ? obra.valor : 0);
                        }, 0);
                        const progressoMedio = Math.round(dataManager.obras.reduce((acc, obra) => acc + obra.progresso, 0) / dataManager.obras.length);
                        const obrasAtivas = dataManager.obras.filter(o => o.status === 'Em Andamento').length;
                        const obrasConcluidas = dataManager.obras.filter(o => o.status === 'Conclu√≠da').length;
                        
                        // Professional summary box
                        doc.setFillColor(245, 247, 250);
                        doc.rect(15, 80, 180, 35, 'F');
                        doc.setDrawColor(59, 130, 246);
                        doc.setLineWidth(0.5);
                        doc.rect(15, 80, 180, 35);
                        
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Total de Obras: ' + dataManager.obras.length, 20, 90);
                        doc.text('Obras Ativas: ' + obrasAtivas, 20, 98);
                        doc.text('Obras Concluidas: ' + obrasConcluidas, 20, 106);
                        doc.text('Valor Total: R$ ' + valorTotalObras.toLocaleString('pt-BR'), 110, 90);
                        doc.text('Progresso Medio: ' + progressoMedio + '%', 110, 98);
                        doc.text('Investimento Medio: R$ ' + Math.round(valorTotalObras / dataManager.obras.length).toLocaleString('pt-BR'), 110, 106);
                        
                        let yPosition = 130;
                        
                        // Detailed works section
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('DETALHAMENTO POR OBRA', 15, yPosition);
                        yPosition += 15;
                        
                        dataManager.obras.forEach((obra, index) => {
                            if (yPosition > 230) {
                                createFooter('...', '...');
                                doc.addPage();
                                createHeader();
                                yPosition = 50;
                            }
                            
                            // Professional obra header
                            doc.setFillColor(59, 130, 246);
                            doc.rect(15, yPosition - 5, 180, 12, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text('OBRA ' + (index + 1) + ': ' + obra.nome.toUpperCase(), 20, yPosition + 3);
                            yPosition += 15;
                            
                            // Obra details with enhanced formatting
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            
                            // Basic info
                            doc.text('Localizacao: ' + obra.localizacao, 20, yPosition);
                            doc.text('Status: ' + obra.status, 20, yPosition + 6);
                            doc.text('Data de Inicio: ' + (obra.dataInicio ? new Date(obra.dataInicio).toLocaleDateString('pt-BR') : 'N/A'), 20, yPosition + 12);
                            
                            // Progress and financial info
                            doc.text('Progresso: ' + obra.progresso + '%', 110, yPosition);
                            doc.text('Valor da Obra: R$ ' + obra.valor.toLocaleString('pt-BR'), 110, yPosition + 6);
                            
                            // Progress bar visualization
                            yPosition += 20;
                            doc.setFillColor(240, 240, 240);
                            doc.rect(20, yPosition, 100, 4, 'F');
                            
                            const progressColor = obra.progresso < 30 ? [239, 68, 68] : obra.progresso < 70 ? [245, 158, 11] : [16, 185, 129];
                            doc.setFillColor(...progressColor);
                            doc.rect(20, yPosition, obra.progresso, 4, 'F');
                            
                            doc.setFontSize(8);
                            doc.text(`${obra.progresso}% conclu√≠do`, 125, yPosition + 3);
                            
                            // Timeline summary if available
                            if (obra.timeline && obra.timeline.length > 0) {
                                yPosition += 10;
                                doc.setFontSize(9);
                                doc.setFont('helvetica', 'bold');
                                doc.text(`Etapas Registradas: ${obra.timeline.length}`, 20, yPosition);
                                
                                const completedStages = obra.timeline.filter(s => s.status === 'completed').length;
                                doc.text(`Etapas Conclu√≠das: ${completedStages}`, 110, yPosition);
                            }
                            
                            yPosition += 20;
                            
                            // Separator line
                            doc.setDrawColor(200, 200, 200);
                            doc.setLineWidth(0.2);
                            doc.line(15, yPosition, 195, yPosition);
                            // Modern stage separator
                            yPosition += 15;
                            
                            // Gradient separator line
                            doc.setDrawColor(74, 158, 255);
                            doc.setLineWidth(1);
                            doc.line(15, yPosition, 195, yPosition);
                            
                            doc.setDrawColor(184, 197, 209);
                            doc.setLineWidth(0.3);
                            doc.line(15, yPosition + 1, 195, yPosition + 1);
                            
                            yPosition += 15;
                        });
                        
                        // Performance analysis section
                        if (yPosition > 200) {
                            createFooter('...', '...');
                            doc.addPage();
                            createHeader();
                            yPosition = 50;
                        }
                        
                        yPosition += 10;
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('AN√ÅLISE DE PERFORMANCE', 15, yPosition);
                        yPosition += 15;
                        
                        // Performance metrics
                        doc.setFillColor(245, 247, 250);
                        doc.rect(15, yPosition, 180, 40, 'F');
                        doc.setDrawColor(16, 185, 129);
                        doc.setLineWidth(0.5);
                        doc.rect(15, yPosition, 180, 40);
                        
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        
                        const obrasNoTempo = dataManager.obras.filter(o => o.progresso >= 50).length;
                        const eficienciaMedia = Math.round((obrasNoTempo / dataManager.obras.length) * 100);
                        
                        doc.text(`Taxa de Efici√™ncia: ${eficienciaMedia}%`, 20, yPosition + 10);
                        doc.text(`Obras no Cronograma: ${obrasNoTempo} de ${dataManager.obras.length}`, 20, yPosition + 18);
                        doc.text(`Investimento Total: R$ ${valorTotalObras.toLocaleString('pt-BR')}`, 20, yPosition + 26);
                        doc.text(`ROI Estimado: 15.2%`, 20, yPosition + 34);
                        
                        // Recommendations
                        yPosition += 50;
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(16, 185, 129);
                        doc.text('‚úì RECOMENDA√á√ïES', 15, yPosition);
                        yPosition += 10;
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        
                        const recommendations = [
                            'Manter acompanhamento semanal do progresso das obras',
                            'Implementar sistema de alertas para obras com atraso',
                            'Otimizar aloca√ß√£o de recursos entre projetos',
                            'Documentar li√ß√µes aprendidas para futuros projetos'
                        ];
                        
                        recommendations.forEach((rec, index) => {
                            doc.text(`‚Ä¢ ${rec}`, 20, yPosition);
                            yPosition += 6;
                        });
                        
                        // Update all page footers with correct page numbers
                        const totalPages = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            doc.setPage(i);
                            createFooter(i, totalPages);
                        }
                        
                        doc.save(`relatorio_obras_${new Date().toISOString().split('T')[0]}.pdf`);
                        toastSystem.show('Relat√≥rio de obras gerado com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao gerar relat√≥rio de obras:', error);
                        toastSystem.show('Erro ao gerar relat√≥rio de obras', 'error');
                    }
                }, 1000);
            },
            
            async generateStockReport() {
                toastSystem.show('Gerando relat√≥rio de estoque...', 'info');
                
                const pdfAvailable = await this.checkPDFLibrary();
                if (!pdfAvailable) {
                    toastSystem.show('Erro: Biblioteca PDF n√£o carregou. Tente novamente.', 'error');
                    return;
                }
                
                setTimeout(() => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        // Helper function to create professional header
                        const createHeader = () => {
                            // Header background with gradient effect
                            doc.setFillColor(30, 58, 138);
                            doc.rect(0, 0, 210, 35, 'F');
                            
                            // SEMCAS logo area
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(22);
                            doc.setFont('helvetica', 'bold');
                            doc.text('SEMCAS', 15, 20);
                            
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Sistema de Gest√£o de Obras', 15, 28);
                            
                            // Document type
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text('RELAT√ìRIO DE ESTOQUE', 120, 20);
                            
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Documento Oficial', 120, 28);
                        };
                        
                        // Helper function to create professional footer
                        const createFooter = (pageNum, totalPages) => {
                            doc.setDrawColor(59, 130, 246);
                            doc.setLineWidth(0.3);
                            doc.line(15, 280, 195, 280);
                            
                            doc.setTextColor(100, 100, 100);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'normal');
                            doc.text('SEMCAS - Sistema de Gestao de Obras | Documento Oficial', 15, 285);
                            doc.text('Pagina ' + pageNum + ' de ' + totalPages, 170, 285);
                            doc.text('Gerado em ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR'), 15, 290);
                        };
                        
                        createHeader();
                        
                        // Date and user info with professional styling
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Data de Gera√ß√£o: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 15, 50);
                        doc.text(`Respons√°vel: ${authSystem.currentUser?.username || 'Sistema'}`, 15, 58);
                        
                        // Summary section
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('RESUMO DO ESTOQUE', 15, 75);
                        
                        const valorTotalEstoque = dataManager.produtos.reduce((acc, prod) => acc + (prod.estoque * prod.preco), 0);
                        const produtosBaixoEstoque = dataManager.produtos.filter(p => p.estoque <= p.estoqueMinimo);
                        const produtosAltoEstoque = dataManager.produtos.filter(p => p.estoque > p.estoqueMinimo * 3);
                        const categorias = [...new Set(dataManager.produtos.map(p => p.categoria))];
                        
                        // Professional summary box
                        doc.setFillColor(245, 247, 250);
                        doc.rect(15, 80, 180, 45, 'F');
                        doc.setDrawColor(16, 185, 129);
                        doc.setLineWidth(0.5);
                        doc.rect(15, 80, 180, 45);
                        
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`‚Ä¢ Total de Produtos: ${dataManager.produtos.length}`, 20, 90);
                        doc.text(`‚Ä¢ Valor Total: R$ ${valorTotalEstoque.toLocaleString('pt-BR')}`, 20, 98);
                        doc.text(`‚Ä¢ Produtos com Estoque Baixo: ${produtosBaixoEstoque.length}`, 20, 106);
                        doc.text(`‚Ä¢ Categorias: ${categorias.length}`, 110, 90);
                        doc.text(`‚Ä¢ Valor M√©dio por Item: R$ ${Math.round(valorTotalEstoque / dataManager.produtos.length).toLocaleString('pt-BR')}`, 110, 98);
                        doc.text(`‚Ä¢ Produtos com Alto Estoque: ${produtosAltoEstoque.length}`, 110, 106);
                        
                        // Additional metrics
                        const estoqueTotal = dataManager.produtos.reduce((acc, prod) => acc + prod.estoque, 0);
                        doc.text(`‚Ä¢ Unidades Totais: ${estoqueTotal.toLocaleString('pt-BR')}`, 20, 114);
                        doc.text(`‚Ä¢ Ticket M√©dio: R$ ${(valorTotalEstoque / estoqueTotal).toFixed(2)}`, 110, 114);
                        
                        let yPosition = 140;
                        
                        // Category analysis
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('AN√ÅLISE POR CATEGORIA', 15, yPosition);
                        yPosition += 15;
                        
                        categorias.forEach((categoria, index) => {
                            if (yPosition > 240) {
                                createFooter('...', '...');
                                doc.addPage();
                                createHeader();
                                yPosition = 50;
                            }
                            
                            const produtosCategoria = dataManager.produtos.filter(p => p.categoria === categoria);
                            const valorCategoria = produtosCategoria.reduce((acc, prod) => acc + (prod.estoque * prod.preco), 0);
                            const estoqueCategoria = produtosCategoria.reduce((acc, prod) => acc + prod.estoque, 0);
                            
                            // Category header
                            doc.setFillColor(16, 185, 129);
                            doc.rect(15, yPosition - 5, 180, 10, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(11);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${categoria.toUpperCase()} (${produtosCategoria.length} produtos)`, 20, yPosition + 2);
                            yPosition += 15;
                            
                            // Category details
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            doc.text(`Valor Total: R$ ${valorCategoria.toLocaleString('pt-BR')}`, 20, yPosition);
                            doc.text(`Unidades: ${estoqueCategoria.toLocaleString('pt-BR')}`, 110, yPosition);
                            doc.text(`Participa√ß√£o: ${((valorCategoria / valorTotalEstoque) * 100).toFixed(1)}%`, 20, yPosition + 6);
                            doc.text(`Pre√ßo M√©dio: R$ ${(valorCategoria / estoqueCategoria).toFixed(2)}`, 110, yPosition + 6);
                            
                            yPosition += 20;
                        });
                        
                        // Detailed product listing
                        if (yPosition > 200) {
                            createFooter('...', '...');
                            doc.addPage();
                            createHeader();
                            yPosition = 50;
                        }
                        
                        yPosition += 10;
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('INVENT√ÅRIO DETALHADO', 15, yPosition);
                        yPosition += 15;
                        
                        // Table header
                        doc.setFillColor(59, 130, 246);
                        doc.rect(15, yPosition - 5, 180, 8, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text('PRODUTO', 20, yPosition);
                        doc.text('CATEGORIA', 80, yPosition);
                        doc.text('ESTOQUE', 120, yPosition);
                        doc.text('PRE√áO', 145, yPosition);
                        doc.text('VALOR TOTAL', 170, yPosition);
                        yPosition += 10;
                        
                        dataManager.produtos.forEach((produto, index) => {
                            if (yPosition > 260) {
                                createFooter('...', '...');
                                doc.addPage();
                                createHeader();
                                yPosition = 50;
                                
                                // Recreate table header on new page
                                doc.setFillColor(59, 130, 246);
                                doc.rect(15, yPosition - 5, 180, 8, 'F');
                                
                                doc.setTextColor(255, 255, 255);
                                doc.setFontSize(9);
                                doc.setFont('helvetica', 'bold');
                                doc.text('PRODUTO', 20, yPosition);
                                doc.text('CATEGORIA', 80, yPosition);
                                doc.text('ESTOQUE', 120, yPosition);
                                doc.text('PRE√áO', 145, yPosition);
                                doc.text('VALOR TOTAL', 170, yPosition);
                                yPosition += 10;
                            }
                            
                            // Alternate row colors
                            if (index % 2 === 0) {
                                doc.setFillColor(248, 250, 252);
                                doc.rect(15, yPosition - 3, 180, 6, 'F');
                            }
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            
                            // Truncate long product names
                            const productName = produto.nome.length > 25 ? produto.nome.substring(0, 22) + '...' : produto.nome;
                            doc.text(productName, 20, yPosition);
                            doc.text(produto.categoria, 80, yPosition);
                            
                            // Color code stock levels
                            if (produto.estoque <= produto.estoqueMinimo) {
                                doc.setTextColor(239, 68, 68); // Red for low stock
                            } else if (produto.estoque > produto.estoqueMinimo * 3) {
                                doc.setTextColor(16, 185, 129); // Green for high stock
                            }
                            
                            doc.text(produto.estoque.toString(), 120, yPosition);
                            
                            doc.setTextColor(0, 0, 0);
                            doc.text(`R$ ${produto.preco.toFixed(2)}`, 145, yPosition);
                            doc.text(`R$ ${(produto.estoque * produto.preco).toLocaleString('pt-BR')}`, 170, yPosition);
                            
                            yPosition += 6;
                        });
                        
                        // Stock alerts section
                        if (produtosBaixoEstoque.length > 0) {
                            if (yPosition > 200) {
                                createFooter('...', '...');
                                doc.addPage();
                                createHeader();
                                yPosition = 50;
                            }
                            
                            yPosition += 15;
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.setTextColor(239, 68, 68);
                            doc.text('‚ö† ALERTAS DE ESTOQUE BAIXO', 15, yPosition);
                            yPosition += 10;
                            
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            
                            produtosBaixoEstoque.forEach((produto, index) => {
                                if (yPosition > 260) {
                                    createFooter('...', '...');
                                    doc.addPage();
                                    createHeader();
                                    yPosition = 50;
                                }
                                
                                doc.setFillColor(254, 242, 242);
                                doc.rect(15, yPosition - 2, 180, 8, 'F');
                                
                                doc.text(`‚Ä¢ ${produto.nome}`, 20, yPosition);
                                doc.text(`Atual: ${produto.estoque}`, 120, yPosition);
                                doc.text(`M√≠nimo: ${produto.estoqueMinimo}`, 150, yPosition);
                                doc.setTextColor(239, 68, 68);
                                doc.text('REABASTECER', 175, yPosition);
                                doc.setTextColor(0, 0, 0);
                                yPosition += 8;
                            });
                        }
                        
                        // Recommendations section
                        if (yPosition > 220) {
                            createFooter('...', '...');
                            doc.addPage();
                            createHeader();
                            yPosition = 50;
                        }
                        
                        yPosition += 15;
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(16, 185, 129);
                        doc.text('‚úì RECOMENDA√á√ïES DE GEST√ÉO', 15, yPosition);
                        yPosition += 10;
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        
                        const recommendations = [
                            `Reabastecer ${produtosBaixoEstoque.length} produtos com estoque baixo`,
                            'Implementar sistema de reposi√ß√£o autom√°tica',
                            'Revisar n√≠veis m√≠nimos de estoque trimestralmente',
                            'Otimizar compras por categoria para reduzir custos',
                            'Monitorar produtos com alto giro de estoque'
                        ];
                        
                        recommendations.forEach((rec, index) => {
                            doc.text(`‚Ä¢ ${rec}`, 20, yPosition);
                            yPosition += 6;
                        });
                        
                        // Update all page footers with correct page numbers
                        const totalPages = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            doc.setPage(i);
                            createFooter(i, totalPages);
                        }
                        
                        doc.save(`relatorio_estoque_${new Date().toISOString().split('T')[0]}.pdf`);
                        toastSystem.show('Relat√≥rio de estoque gerado com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao gerar relat√≥rio de estoque:', error);
                        toastSystem.show('Erro ao gerar relat√≥rio de estoque', 'error');
                    }
                }, 1000);
            },
            
            async generateFinancialReport() {
                toastSystem.show('Gerando relat√≥rio financeiro...', 'info');
                
                const pdfAvailable = await this.checkPDFLibrary();
                if (!pdfAvailable) {
                    toastSystem.show('Erro: Biblioteca PDF n√£o carregou. Tente novamente.', 'error');
                    return;
                }
                
                setTimeout(() => {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        // Helper function to create professional header
                        const createHeader = () => {
                            // Header background with gradient effect
                            doc.setFillColor(30, 58, 138);
                            doc.rect(0, 0, 210, 35, 'F');
                            
                            // SEMCAS logo area
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(22);
                            doc.setFont('helvetica', 'bold');
                            doc.text('SEMCAS', 15, 20);
                            
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Sistema de Gest√£o de Obras', 15, 28);
                            
                            // Document type
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text('RELAT√ìRIO FINANCEIRO', 120, 20);
                            
                            doc.setFontSize(8);
                            doc.setFont('helvetica', 'normal');
                            doc.text('Documento Oficial', 120, 28);
                        };
                        
                        // Helper function to create professional footer
                        const createFooter = (pageNum, totalPages) => {
                            doc.setDrawColor(59, 130, 246);
                            doc.setLineWidth(0.3);
                            doc.line(15, 280, 195, 280);
                            
                            doc.setTextColor(100, 100, 100);
                            doc.setFontSize(7);
                            doc.setFont('helvetica', 'normal');
                            doc.text('SEMCAS - Sistema de Gestao de Obras | Documento Oficial', 15, 285);
                            doc.text('Pagina ' + pageNum + ' de ' + totalPages, 170, 285);
                            doc.text('Gerado em ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR'), 15, 290);
                        };
                        
                        createHeader();
                        
                        // Date and user info with professional styling
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Data de Gera√ß√£o: ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}`, 15, 50);
                        doc.text(`Respons√°vel: ${authSystem.currentUser?.username || 'Sistema'}`, 15, 58);
                        
                        // Calculate financial metrics
                        const valorObras = dataManager.obras.reduce((acc, obra) => {
                            return acc + (typeof obra.valor === 'number' ? obra.valor : 0);
                        }, 0);
                        const valorEstoque = dataManager.produtos.reduce((acc, prod) => acc + (prod.estoque * prod.preco), 0);
                        const valorTotal = valorObras + valorEstoque;
                        const obrasAtivas = dataManager.obras.filter(o => o.status === 'Em Andamento').length;
                        const obrasConcluidas = dataManager.obras.filter(o => o.status === 'Conclu√≠da').length;
                        
                        // Executive Summary
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('RESUMO EXECUTIVO FINANCEIRO', 15, 75);
                        
                        // Professional summary box
                        doc.setFillColor(245, 247, 250);
                        doc.rect(15, 80, 180, 50, 'F');
                        doc.setDrawColor(245, 158, 11);
                        doc.setLineWidth(0.5);
                        doc.rect(15, 80, 180, 50);
                        
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`‚Ä¢ Valor Total das Obras: R$ ${valorObras.toLocaleString('pt-BR')}`, 20, 90);
                        doc.text(`‚Ä¢ Valor Total do Estoque: R$ ${valorEstoque.toLocaleString('pt-BR')}`, 20, 98);
                        doc.text(`‚Ä¢ Patrim√¥nio Total: R$ ${valorTotal.toLocaleString('pt-BR')}`, 20, 106);
                        doc.text(`‚Ä¢ Obras Ativas: ${obrasAtivas}`, 110, 90);
                        doc.text(`‚Ä¢ Obras Conclu√≠das: ${obrasConcluidas}`, 110, 98);
                        doc.text(`‚Ä¢ ROI Estimado: 15.2%`, 110, 106);
                        
                        // Additional financial metrics
                        const investimentoMedio = valorObras / dataManager.obras.length;
                        const participacaoObras = ((valorObras / valorTotal) * 100).toFixed(1);
                        const participacaoEstoque = ((valorEstoque / valorTotal) * 100).toFixed(1);
                        
                        doc.text(`‚Ä¢ Investimento M√©dio por Obra: R$ ${Math.round(investimentoMedio).toLocaleString('pt-BR')}`, 20, 114);
                        doc.text(`‚Ä¢ Liquidez do Estoque: ${participacaoEstoque}%`, 110, 114);
                        doc.text(`‚Ä¢ Taxa de Crescimento: +8.5% (m√™s)`, 20, 122);
                        doc.text(`‚Ä¢ Margem Operacional: 12.8%`, 110, 122);
                        
                        let yPosition = 145;
                        
                        // Asset Distribution Analysis
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('DISTRIBUI√á√ÉO DE ATIVOS', 15, yPosition);
                        yPosition += 15;
                        
                        // Asset distribution chart (text-based)
                        doc.setFillColor(59, 130, 246);
                        doc.rect(15, yPosition - 5, 180, 12, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text('CATEGORIA', 20, yPosition + 3);
                        doc.text('VALOR', 80, yPosition + 3);
                        doc.text('PARTICIPA√á√ÉO', 130, yPosition + 3);
                        doc.text('STATUS', 170, yPosition + 3);
                        yPosition += 15;
                        
                        // Works row
                        doc.setFillColor(248, 250, 252);
                        doc.rect(15, yPosition - 3, 180, 8, 'F');
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Obras em Execu√ß√£o', 20, yPosition);
                        doc.text(`R$ ${valorObras.toLocaleString('pt-BR')}`, 80, yPosition);
                        doc.text(`${participacaoObras}%`, 130, yPosition);
                        doc.setTextColor(16, 185, 129);
                        doc.text('ATIVO', 170, yPosition);
                        yPosition += 8;
                        
                        // Stock row
                        doc.setTextColor(0, 0, 0);
                        doc.text('Estoque de Materiais', 20, yPosition);
                        doc.text(`R$ ${valorEstoque.toLocaleString('pt-BR')}`, 80, yPosition);
                        doc.text(`${participacaoEstoque}%`, 130, yPosition);
                        doc.setTextColor(245, 158, 11);
                        doc.text('L√çQUIDO', 170, yPosition);
                        yPosition += 15;
                        
                        // Detailed Works Financial Analysis
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('AN√ÅLISE FINANCEIRA POR OBRA', 15, yPosition);
                        yPosition += 15;
                        
                        dataManager.obras.forEach((obra, index) => {
                            if (yPosition > 230) {
                                createFooter('...', '...');
                                doc.addPage();
                                createHeader();
                                yPosition = 50;
                            }
                            
                            // Professional obra financial header
                            doc.setFillColor(245, 158, 11);
                            doc.rect(15, yPosition - 5, 180, 12, 'F');
                            
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(12);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`${index + 1}. ${obra.nome.toUpperCase()}`, 20, yPosition + 3);
                            yPosition += 15;
                            
                            // Financial details
                            doc.setTextColor(0, 0, 0);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'normal');
                            
                            const valorNumerico = typeof obra.valor === 'number' ? obra.valor : 0;
                            const valorExecutado = (valorNumerico * obra.progresso) / 100;
                            const valorPendente = valorNumerico - valorExecutado;
                            const participacaoObra = valorObras > 0 ? ((valorNumerico / valorObras) * 100).toFixed(1) : '0.0';
                            
                            doc.text(`Valor Total do Contrato: ${typeof obra.valor === 'string' ? obra.valor : `R$ ${obra.valor.toLocaleString('pt-BR')}`}`, 20, yPosition);
                            doc.text(`Valor Executado: R$ ${Math.round(valorExecutado).toLocaleString('pt-BR')} (${obra.progresso}%)`, 20, yPosition + 6);
                            doc.text(`Valor Pendente: R$ ${Math.round(valorPendente).toLocaleString('pt-BR')}`, 20, yPosition + 12);
                            doc.text(`Participa√ß√£o no Portfolio: ${participacaoObra}%`, 20, yPosition + 18);
                            
                            // Financial status indicators
                            doc.text(`Status Financeiro:`, 110, yPosition);
                            if (obra.progresso >= 80) {
                                doc.setTextColor(16, 185, 129);
                                doc.text('EXECU√á√ÉO AVAN√áADA', 110, yPosition + 6);
                            } else if (obra.progresso >= 50) {
                                doc.setTextColor(245, 158, 11);
                                doc.text('EM DESENVOLVIMENTO', 110, yPosition + 6);
                            } else {
                                doc.setTextColor(239, 68, 68);
                                doc.text('IN√çCIO DE EXECU√á√ÉO', 110, yPosition + 6);
                            }
                            
                            doc.setTextColor(0, 0, 0);
                            doc.text(`ROI Projetado: 15.2%`, 110, yPosition + 12);
                            doc.text(`Prazo Estimado: 6-12 meses`, 110, yPosition + 18);
                            
                            yPosition += 30;
                        });
                        
                        // Stock Financial Analysis
                        if (yPosition > 200) {
                            createFooter('...', '...');
                            doc.addPage();
                            createHeader();
                            yPosition = 50;
                        }
                        
                        yPosition += 10;
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('AN√ÅLISE FINANCEIRA DO ESTOQUE', 15, yPosition);
                        yPosition += 15;
                        
                        // Stock financial metrics
                        doc.setFillColor(245, 247, 250);
                        doc.rect(15, yPosition, 180, 40, 'F');
                        doc.setDrawColor(16, 185, 129);
                        doc.setLineWidth(0.5);
                        doc.rect(15, yPosition, 180, 40);
                        
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        
                        const categorias = [...new Set(dataManager.produtos.map(p => p.categoria))];
                        const categoriaMaisValiosa = categorias.reduce((max, cat) => {
                            const valorCat = dataManager.produtos
                                .filter(p => p.categoria === cat)
                                .reduce((acc, p) => acc + (p.estoque * p.preco), 0);
                            return valorCat > max.valor ? { categoria: cat, valor: valorCat } : max;
                        }, { categoria: '', valor: 0 });
                        
                        const giroEstoque = 4.2; // Exemplo de giro anual
                        const custoOportunidade = valorEstoque * 0.08; // 8% ao ano
                        
                        doc.text(`Valor Total Imobilizado: R$ ${valorEstoque.toLocaleString('pt-BR')}`, 20, yPosition + 10);
                        doc.text(`Categoria Mais Valiosa: ${categoriaMaisValiosa.categoria} (R$ ${Math.round(categoriaMaisValiosa.valor).toLocaleString('pt-BR')})`, 20, yPosition + 18);
                        doc.text(`Giro de Estoque Anual: ${giroEstoque}x`, 20, yPosition + 26);
                        doc.text(`Custo de Oportunidade: R$ ${Math.round(custoOportunidade).toLocaleString('pt-BR')}/ano`, 20, yPosition + 34);
                        
                        yPosition += 50;
                        
                        // Financial Projections
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(59, 130, 246);
                        doc.text('üìä PROJE√á√ïES FINANCEIRAS', 15, yPosition);
                        yPosition += 10;
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        
                        const projections = [
                            'Crescimento esperado do portfolio: +25% nos pr√≥ximos 12 meses',
                            'Redu√ß√£o do estoque imobilizado: -15% atrav√©s de otimiza√ß√£o',
                            'Aumento da margem operacional: +3.2% com melhor gest√£o',
                            'ROI projetado para novas obras: 18.5%',
                            'Tempo m√©dio de execu√ß√£o: redu√ß√£o de 15% com processos otimizados'
                        ];
                        
                        projections.forEach((proj, index) => {
                            doc.text(`‚Ä¢ ${proj}`, 20, yPosition);
                            yPosition += 6;
                        });
                        
                        yPosition += 10;
                        
                        // Recommendations
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(16, 185, 129);
                        doc.text('‚úì RECOMENDA√á√ïES FINANCEIRAS', 15, yPosition);
                        yPosition += 10;
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'normal');
                        
                        const recommendations = [
                            'Diversificar portfolio de obras para reduzir riscos',
                            'Implementar sistema de controle de custos em tempo real',
                            'Otimizar n√≠veis de estoque para reduzir capital imobilizado',
                            'Estabelecer reserva de conting√™ncia de 10% do valor total',
                            'Monitorar indicadores de performance financeira mensalmente'
                        ];
                        
                        recommendations.forEach((rec, index) => {
                            if (yPosition > 270) {
                                createFooter('...', '...');
                                doc.addPage();
                                createHeader();
                                yPosition = 50;
                            }
                            doc.text(`‚Ä¢ ${rec}`, 20, yPosition);
                            yPosition += 6;
                        });
                        
                        // Update all page footers with correct page numbers
                        const totalPages = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= totalPages; i++) {
                            doc.setPage(i);
                            createFooter(i, totalPages);
                        }
                        
                        doc.save(`relatorio_financeiro_${new Date().toISOString().split('T')[0]}.pdf`);
                        toastSystem.show('Relat√≥rio financeiro gerado com sucesso!', 'success');
                    } catch (error) {
                        console.error('Erro ao gerar relat√≥rio financeiro:', error);
                        toastSystem.show('Erro ao gerar relat√≥rio financeiro', 'error');
                    }
                }, 1000);
            }
        };

        // Feed Manager
        const feedManager = {
            posts: [],
            
            stories: [],
            
            selectedPostMedia: [],
            selectedStoryMedia: null,
            
            init() {
                this.renderFeed();
                this.renderStories();
                this.populateObraSelect();
            },
            
            populateObraSelect() {
                const select = document.getElementById('postObra');
                if (select) {
                    select.innerHTML = '<option value="" class="bg-gray-800">Selecione uma obra</option>';
                    dataManager.obras.forEach(obra => {
                        const option = document.createElement('option');
                        option.value = obra.id;
                        option.textContent = obra.nome;
                        option.className = 'bg-gray-800';
                        select.appendChild(option);
                    });
                }
            },
            
            openCreatePostModal() {
                this.populateObraSelect();
                modalSystem.open('createPostModal');
            },
            
            closeCreatePostModal() {
                modalSystem.close('createPostModal');
                document.getElementById('createPostForm').reset();
                this.selectedPostMedia = [];
                this.updatePostMediaPreview();
            },
            
            openCreateStoryModal() {
                modalSystem.open('createStoryModal');
            },
            
            closeCreateStoryModal() {
                modalSystem.close('createStoryModal');
                document.getElementById('createStoryForm').reset();
                this.selectedStoryMedia = null;
                this.updateStoryMediaPreview();
            },
            
            handlePostMediaSelection(event) {
                const files = Array.from(event.target.files);
                
                files.forEach(file => {
                    if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                        // Check video duration for posts (60 seconds max)
                        if (file.type.startsWith('video/')) {
                            const video = document.createElement('video');
                            video.preload = 'metadata';
                            video.onloadedmetadata = () => {
                                if (video.duration > 60) {
                                    toastSystem.show('V√≠deos devem ter no m√°ximo 60 segundos', 'warning');
                                    return;
                                }
                                this.processMediaFile(file, 'post');
                            };
                            video.src = URL.createObjectURL(file);
                        } else {
                            this.processMediaFile(file, 'post');
                        }
                    }
                });
            },
            
            handleStoryMediaSelection(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                    // Check video duration for stories (15 seconds max)
                    if (file.type.startsWith('video/')) {
                        const video = document.createElement('video');
                        video.preload = 'metadata';
                        video.onloadedmetadata = () => {
                            if (video.duration > 15) {
                                toastSystem.show('Stories de v√≠deo devem ter no m√°ximo 15 segundos', 'warning');
                                return;
                            }
                            this.processMediaFile(file, 'story');
                        };
                        video.src = URL.createObjectURL(file);
                    } else {
                        this.processMediaFile(file, 'story');
                    }
                }
            },
            
            processMediaFile(file, type) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const mediaData = {
                        file: file,
                        url: e.target.result,
                        name: file.name,
                        type: file.type.startsWith('image/') ? 'image' : 'video'
                    };
                    
                    if (type === 'post') {
                        this.selectedPostMedia.push(mediaData);
                        this.updatePostMediaPreview();
                    } else if (type === 'story') {
                        this.selectedStoryMedia = mediaData;
                        this.updateStoryMediaPreview();
                    }
                };
                reader.readAsDataURL(file);
            },
            
            updatePostMediaPreview() {
                const preview = document.getElementById('postMediaPreview');
                
                if (this.selectedPostMedia.length === 0) {
                    preview.classList.add('hidden');
                    return;
                }
                
                preview.classList.remove('hidden');
                preview.innerHTML = this.selectedPostMedia.map((media, index) => `
                    <div class="relative rounded-lg overflow-hidden">
                        ${media.type === 'image' ? 
                            `<img src="${media.url}" alt="${media.name}" class="w-full h-24 object-cover">` :
                            `<video src="${media.url}" class="w-full h-24 object-cover" muted></video>`
                        }
                        <button type="button" class="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs" onclick="feedManager.removePostMedia(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                        ${media.type === 'video' ? '<div class="absolute bottom-1 left-1 bg-black/50 text-white text-xs px-1 rounded"><i class="fas fa-play"></i></div>' : ''}
                    </div>
                `).join('');
            },
            
            updateStoryMediaPreview() {
                const preview = document.getElementById('storyMediaPreview');
                
                if (!this.selectedStoryMedia) {
                    preview.classList.add('hidden');
                    return;
                }
                
                preview.classList.remove('hidden');
                preview.innerHTML = `
                    <div class="relative rounded-lg overflow-hidden max-w-xs mx-auto">
                        ${this.selectedStoryMedia.type === 'image' ? 
                            `<img src="${this.selectedStoryMedia.url}" alt="${this.selectedStoryMedia.name}" class="w-full h-32 object-cover">` :
                            `<video src="${this.selectedStoryMedia.url}" class="w-full h-32 object-cover" muted></video>`
                        }
                        <button type="button" class="absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs" onclick="feedManager.removeStoryMedia()">
                            <i class="fas fa-times"></i>
                        </button>
                        ${this.selectedStoryMedia.type === 'video' ? '<div class="absolute bottom-1 left-1 bg-black/50 text-white text-xs px-1 rounded"><i class="fas fa-play"></i></div>' : ''}
                    </div>
                `;
            },
            
            removePostMedia(index) {
                this.selectedPostMedia.splice(index, 1);
                this.updatePostMediaPreview();
            },
            
            removeStoryMedia() {
                this.selectedStoryMedia = null;
                this.updateStoryMediaPreview();
            },
            
            createPost(postData) {
                const newPost = {
                    id: this.posts.length + 1,
                    user: {
                        name: authSystem.currentUser?.username || 'Usu√°rio',
                        role: authSystem.currentUser?.userType || 'Funcion√°rio',
                        avatar: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%233B82F6'/%3E%3Ctext x='20' y='26' text-anchor='middle' fill='white' font-size='16' font-weight='bold'%3E${(authSystem.currentUser?.username || 'U').charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E`
                    },
                    timestamp: new Date(),
                    description: postData.description,
                    obra: postData.obra ? dataManager.obras.find(o => o.id == postData.obra)?.nome : null,
                    media: this.selectedPostMedia.map(media => ({
                        type: media.type,
                        url: media.url
                    })),
                    likes: 0,
                    comments: [],
                    liked: false
                };
                
                this.posts.unshift(newPost);
                this.renderFeed();
                this.closeCreatePostModal();
                toastSystem.show('Post publicado com sucesso!', 'success');
            },
            
            createStory(storyData) {
                const newStory = {
                    id: this.stories.length + 1,
                    user: {
                        name: authSystem.currentUser?.username || 'Usu√°rio',
                        avatar: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%2310B981'/%3E%3Ctext x='20' y='26' text-anchor='middle' fill='white' font-size='16' font-weight='bold'%3E${(authSystem.currentUser?.username || 'U').charAt(0).toUpperCase()}%3C/text%3E%3C/svg%3E`
                    },
                    timestamp: new Date(),
                    media: this.selectedStoryMedia,
                    text: storyData.text,
                    viewed: false
                };
                
                this.stories.unshift(newStory);
                this.renderStories();
                this.closeCreateStoryModal();
                toastSystem.show('Story publicado com sucesso!', 'success');
            },
            
            renderStories() {
                const container = document.getElementById('storiesContainer');
                if (!container) return;
                
                container.innerHTML = this.stories.map(story => `
                    <div class="flex-shrink-0 text-center cursor-pointer hover:scale-105 transition-transform duration-200" onclick="feedManager.viewStory(${story.id})">
                        <div class="w-20 h-20 rounded-full p-1 ${story.viewed ? 'bg-gray-400' : 'bg-gradient-to-tr from-blue-500 to-cyan-500'} shadow-lg">
                            <div class="w-full h-full rounded-full border-2 border-white overflow-hidden">
                                <img src="${story.user.avatar}" alt="${story.user.name}" class="w-full h-full object-cover">
                            </div>
                        </div>
                        <span class="text-sm text-gray-300 mt-2 block truncate w-20 font-medium">${story.user.name.split(' ')[0]}</span>
                    </div>
                `).join('');
            },
            
            renderFeed() {
                const container = document.getElementById('feedContainer');
                if (!container) return;
                
                if (this.posts.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-16">
                            <div class="feed-post p-8">
                                <i class="fas fa-camera text-4xl text-gray-400 mb-4"></i>
                                <h3 class="text-xl font-semibold text-white mb-2">Nenhuma postagem ainda</h3>
                                <p class="text-gray-300 mb-6">Seja o primeiro a compartilhar o progresso das obras!</p>
                                <button onclick="feedManager.openCreatePostModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200">
                                    <i class="fas fa-plus mr-2"></i>Criar Primeira Postagem
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.posts.map(post => `
                    <div class="feed-post overflow-hidden">
                        <!-- Post Header -->
                        <div class="p-6 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <img src="${post.user.avatar}" alt="${post.user.name}" class="w-12 h-12 rounded-full ring-2 ring-white/20">
                                <div>
                                    <h4 class="text-white font-semibold">${post.user.name}</h4>
                                    <div class="flex items-center space-x-2 text-sm text-gray-400">
                                        <span>${post.user.role}</span>
                                        ${post.obra ? `<span>‚Ä¢</span><span class="text-blue-400">${post.obra}</span>` : ''}
                                        <span>‚Ä¢</span>
                                        <span>${this.formatTimestamp(post.timestamp)}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="text-gray-400 hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-white/10">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                        
                        <!-- Post Content -->
                        <div class="px-6 pb-4">
                            <p class="text-white leading-relaxed">${post.description}</p>
                        </div>
                        
                        <!-- Post Media -->
                        ${post.media && post.media.length > 0 ? this.renderMediaCarousel(post.media, post.id) : ''}
                        
                        <!-- Post Actions -->
                        <div class="p-6 pt-4">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <button onclick="feedManager.toggleLike(${post.id})" class="post-action-btn ${post.liked ? 'liked' : ''}">
                                        <i class="fas fa-thumbs-up"></i>
                                        <span>${post.likes}</span>
                                    </button>
                                    <button onclick="feedManager.toggleComments(${post.id})" class="post-action-btn">
                                        <i class="fas fa-comment"></i>
                                        <span>${post.comments.length}</span>
                                    </button>
                                    <button onclick="feedManager.openShareModal(${post.id})" class="post-action-btn">
                                        <i class="fas fa-share"></i>
                                    </button>
                                </div>
                                <button onclick="feedManager.savePost(${post.id})" class="post-action-btn">
                                    <i class="fas fa-bookmark"></i>
                                </button>
                            </div>
                            
                            <!-- Comments Preview -->
                            ${post.comments.length > 0 ? `
                                <div class="space-y-3 pt-3 border-t border-white/10">
                                    ${post.comments.slice(0, 2).map(comment => `
                                        <div class="flex items-start space-x-3">
                                            <span class="text-white font-medium text-sm">${comment.user}</span>
                                            <span class="text-gray-300 text-sm flex-1">${comment.text}</span>
                                        </div>
                                    `).join('')}
                                    ${post.comments.length > 2 ? `
                                        <button class="text-gray-400 text-sm hover:text-white transition-colors duration-200 font-medium">
                                            Ver todos os ${post.comments.length} coment√°rios
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
                
                // Initialize carousels after rendering
                this.initializeCarousels();
            },
            
            renderMediaCarousel(media, postId) {
                if (media.length === 1) {
                    return `
                        <div class="media-carousel">
                            <div class="carousel-slide">
                                ${media[0].type === 'image' ? 
                                    `<img src="${media[0].url}" alt="Post image" onclick="feedManager.openMediaModal('${media[0].url}', 'image')">` :
                                    `<video src="${media[0].url}" muted onclick="feedManager.openMediaModal('${media[0].url}', 'video')">
                                        <div class="video-play-overlay">
                                            <button class="video-play-btn">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </div>
                                    </video>`
                                }
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="media-carousel" data-post-id="${postId}">
                        <div class="carousel-container" data-current-slide="0">
                            ${media.map((item, index) => `
                                <div class="carousel-slide">
                                    ${item.type === 'image' ? 
                                        `<img src="${item.url}" alt="Post image ${index + 1}" onclick="feedManager.openMediaModal('${item.url}', 'image')">` :
                                        `<video src="${item.url}" muted onclick="feedManager.openMediaModal('${item.url}', 'video')">
                                            <div class="video-play-overlay">
                                                <button class="video-play-btn">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            </div>
                                        </video>`
                                    }
                                </div>
                            `).join('')}
                        </div>
                        
                        ${media.length > 1 ? `
                            <button class="carousel-nav prev" onclick="feedManager.previousSlide(${postId})">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="carousel-nav next" onclick="feedManager.nextSlide(${postId})">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <div class="carousel-indicators">
                                ${media.map((_, index) => `
                                    <div class="carousel-indicator ${index === 0 ? 'active' : ''}" onclick="feedManager.goToSlide(${postId}, ${index})"></div>
                                `).join('')}
                            </div>
                            
                            <div class="media-counter">
                                <span class="current-slide">1</span> / ${media.length}
                            </div>
                        ` : ''}
                    </div>
                `;
            },
            
            initializeCarousels() {
                // Initialize carousel functionality after DOM is ready
                setTimeout(() => {
                    document.querySelectorAll('.media-carousel').forEach(carousel => {
                        const container = carousel.querySelector('.carousel-container');
                        if (container) {
                            container.style.transform = 'translateX(0%)';
                        }
                    });
                }, 100);
            },
            
            nextSlide(postId) {
                const carousel = document.querySelector(`[data-post-id="${postId}"]`);
                if (!carousel) return;
                
                const container = carousel.querySelector('.carousel-container');
                const slides = carousel.querySelectorAll('.carousel-slide');
                const indicators = carousel.querySelectorAll('.carousel-indicator');
                const counter = carousel.querySelector('.current-slide');
                
                let currentSlide = parseInt(container.dataset.currentSlide);
                currentSlide = (currentSlide + 1) % slides.length;
                
                container.style.transform = `translateX(-${currentSlide * 100}%)`;
                container.dataset.currentSlide = currentSlide;
                
                // Update indicators
                indicators.forEach((indicator, index) => {
                    indicator.classList.toggle('active', index === currentSlide);
                });
                
                // Update counter
                if (counter) {
                    counter.textContent = currentSlide + 1;
                }
            },
            
            previousSlide(postId) {
                const carousel = document.querySelector(`[data-post-id="${postId}"]`);
                if (!carousel) return;
                
                const container = carousel.querySelector('.carousel-container');
                const slides = carousel.querySelectorAll('.carousel-slide');
                const indicators = carousel.querySelectorAll('.carousel-indicator');
                const counter = carousel.querySelector('.current-slide');
                
                let currentSlide = parseInt(container.dataset.currentSlide);
                currentSlide = currentSlide === 0 ? slides.length - 1 : currentSlide - 1;
                
                container.style.transform = `translateX(-${currentSlide * 100}%)`;
                container.dataset.currentSlide = currentSlide;
                
                // Update indicators
                indicators.forEach((indicator, index) => {
                    indicator.classList.toggle('active', index === currentSlide);
                });
                
                // Update counter
                if (counter) {
                    counter.textContent = currentSlide + 1;
                }
            },
            
            goToSlide(postId, slideIndex) {
                const carousel = document.querySelector(`[data-post-id="${postId}"]`);
                if (!carousel) return;
                
                const container = carousel.querySelector('.carousel-container');
                const indicators = carousel.querySelectorAll('.carousel-indicator');
                const counter = carousel.querySelector('.current-slide');
                
                container.style.transform = `translateX(-${slideIndex * 100}%)`;
                container.dataset.currentSlide = slideIndex;
                
                // Update indicators
                indicators.forEach((indicator, index) => {
                    indicator.classList.toggle('active', index === slideIndex);
                });
                
                // Update counter
                if (counter) {
                    counter.textContent = slideIndex + 1;
                }
            },
            
            formatTimestamp(timestamp) {
                const now = new Date();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                
                if (minutes < 1) return 'agora';
                if (minutes < 60) return `${minutes}min`;
                if (hours < 24) return `${hours}h`;
                return `${days}d`;
            },
            
            toggleLike(postId) {
                const post = this.posts.find(p => p.id === postId);
                if (post) {
                    post.liked = !post.liked;
                    post.likes += post.liked ? 1 : -1;
                    this.renderFeed();
                }
            },
            
            toggleComments(postId) {
                toastSystem.show('Sistema de coment√°rios em desenvolvimento', 'info');
            },
            
            openShareModal(postId) {
                const post = this.posts.find(p => p.id === postId);
                if (!post) return;
                
                this.currentSharePost = post;
                this.showShareModal();
            },
            
            showShareModal() {
                const modal = document.createElement('div');
                modal.className = 'share-modal';
                modal.id = 'shareModal';
                modal.innerHTML = `
                    <div class="share-modal-content">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-white">Compartilhar Postagem</h3>
                            <button onclick="feedManager.closeShareModal()" class="text-gray-400 hover:text-white transition-colors duration-200 p-2">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <p class="text-gray-300 text-sm mb-6">Escolha como deseja compartilhar esta postagem</p>
                        
                        <div class="share-options">
                            <div class="share-option" onclick="feedManager.shareToWhatsApp()">
                                <i class="fab fa-whatsapp text-green-400"></i>
                                <span>WhatsApp</span>
                            </div>
                            <div class="share-option" onclick="feedManager.shareToTelegram()">
                                <i class="fab fa-telegram text-blue-400"></i>
                                <span>Telegram</span>
                            </div>
                            <div class="share-option" onclick="feedManager.shareToTwitter()">
                                <i class="fab fa-twitter text-blue-400"></i>
                                <span>Twitter</span>
                            </div>
                            <div class="share-option" onclick="feedManager.shareToFacebook()">
                                <i class="fab fa-facebook text-blue-600"></i>
                                <span>Facebook</span>
                            </div>
                            <div class="share-option" onclick="feedManager.shareToLinkedIn()">
                                <i class="fab fa-linkedin text-blue-500"></i>
                                <span>LinkedIn</span>
                            </div>
                            <div class="share-option" onclick="feedManager.copyLink()">
                                <i class="fas fa-link text-gray-400"></i>
                                <span>Copiar Link</span>
                            </div>
                            <div class="share-option" onclick="feedManager.downloadMedia()">
                                <i class="fas fa-download text-purple-400"></i>
                                <span>Baixar</span>
                            </div>
                            <div class="share-option" onclick="feedManager.shareViaEmail()">
                                <i class="fas fa-envelope text-red-400"></i>
                                <span>E-mail</span>
                            </div>
                            <div class="share-option" onclick="feedManager.shareNative()">
                                <i class="fas fa-share-alt text-cyan-400"></i>
                                <span>Mais</span>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('show'), 10);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeShareModal();
                    }
                });
            },
            
            closeShareModal() {
                const modal = document.getElementById('shareModal');
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => modal.remove(), 300);
                }
            },
            
            shareToWhatsApp() {
                const post = this.currentSharePost;
                const text = `${post.description}\n\n${post.obra ? `Obra: ${post.obra}\n` : ''}Postado por: ${post.user.name} - SEMCAS`;
                const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
                this.closeShareModal();
                toastSystem.show('Compartilhado no WhatsApp!', 'success');
            },
            
            shareToTelegram() {
                const post = this.currentSharePost;
                const text = `${post.description}\n\n${post.obra ? `Obra: ${post.obra}\n` : ''}Postado por: ${post.user.name} - SEMCAS`;
                const url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
                window.open(url, '_blank');
                this.closeShareModal();
                toastSystem.show('Compartilhado no Telegram!', 'success');
            },
            
            shareToTwitter() {
                const post = this.currentSharePost;
                const text = `${post.description.substring(0, 200)}${post.description.length > 200 ? '...' : ''}\n\n#SEMCAS #Obras`;
                const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(window.location.href)}`;
                window.open(url, '_blank');
                this.closeShareModal();
                toastSystem.show('Compartilhado no Twitter!', 'success');
            },
            
            shareToFacebook() {
                const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`;
                window.open(url, '_blank');
                this.closeShareModal();
                toastSystem.show('Compartilhado no Facebook!', 'success');
            },
            
            shareToLinkedIn() {
                const post = this.currentSharePost;
                const url = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(window.location.href)}`;
                window.open(url, '_blank');
                this.closeShareModal();
                toastSystem.show('Compartilhado no LinkedIn!', 'success');
            },
            
            copyLink() {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    this.closeShareModal();
                    toastSystem.show('Link copiado para a √°rea de transfer√™ncia!', 'success');
                }).catch(() => {
                    toastSystem.show('Erro ao copiar link', 'error');
                });
            },
            
            downloadMedia() {
                const post = this.currentSharePost;
                if (!post.media || post.media.length === 0) {
                    toastSystem.show('Nenhuma m√≠dia para baixar', 'warning');
                    return;
                }
                
                post.media.forEach((media, index) => {
                    const link = document.createElement('a');
                    link.href = media.url;
                    link.download = `semcas_post_${post.id}_media_${index + 1}.${media.type === 'image' ? 'jpg' : 'mp4'}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                
                this.closeShareModal();
                toastSystem.show(`${post.media.length} arquivo(s) baixado(s)!`, 'success');
            },
            
            shareViaEmail() {
                const post = this.currentSharePost;
                const subject = `SEMCAS - ${post.obra || 'Postagem do Feed'}`;
                const body = `${post.description}\n\n${post.obra ? `Obra: ${post.obra}\n` : ''}Postado por: ${post.user.name}\nData: ${post.timestamp.toLocaleDateString('pt-BR')}\n\nVeja mais em: ${window.location.href}`;
                const url = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = url;
                this.closeShareModal();
                toastSystem.show('E-mail preparado!', 'success');
            },
            
            shareNative() {
                const post = this.currentSharePost;
                if (navigator.share) {
                    navigator.share({
                        title: `SEMCAS - ${post.obra || 'Feed'}`,
                        text: post.description,
                        url: window.location.href
                    }).then(() => {
                        this.closeShareModal();
                        toastSystem.show('Compartilhado com sucesso!', 'success');
                    }).catch(() => {
                        toastSystem.show('Compartilhamento cancelado', 'info');
                    });
                } else {
                    this.copyLink();
                }
            },
            
            savePost(postId) {
                toastSystem.show('Post salvo!', 'success');
            },
            
            viewStory(storyId) {
                const story = this.stories.find(s => s.id === storyId);
                if (story) {
                    story.viewed = true;
                    this.renderStories();
                    this.openStoryViewer(story);
                }
            },
            
            openStoryViewer(story) {
                const modal = document.createElement('div');
                modal.className = 'story-viewer';
                modal.id = 'storyViewer';
                
                modal.innerHTML = `
                    <div class="story-content">
                        <div class="story-header">
                            <div class="story-progress">
                                <div class="story-progress-bar" id="storyProgressBar"></div>
                            </div>
                            <div class="story-user-info">
                                <img src="${story.user.avatar}" alt="${story.user.name}" class="story-avatar">
                                <div class="story-user-details">
                                    <h4>${story.user.name}</h4>
                                    <span>${this.formatTimestamp(story.timestamp)}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${story.media ? 
                            (story.media.type === 'image' ? 
                                `<img src="${story.media.url}" alt="Story" class="story-media">` :
                                `<video src="${story.media.url}" class="story-media" muted autoplay></video>`
                            ) : 
                            `<div class="story-media bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                                <div class="text-center text-white p-8">
                                    <i class="fas fa-quote-left text-3xl mb-4 opacity-50"></i>
                                    <p class="text-lg font-medium">${story.text || 'Story sem conte√∫do'}</p>
                                </div>
                            </div>`
                        }
                        
                        ${story.text && story.media ? `
                            <div class="story-text-overlay">
                                ${story.text}
                            </div>
                        ` : ''}
                        
                        <button class="story-close" onclick="feedManager.closeStoryViewer()">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <div class="story-navigation story-nav-prev" onclick="feedManager.previousStory()"></div>
                        <div class="story-navigation story-nav-next" onclick="feedManager.nextStory()"></div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                setTimeout(() => modal.classList.add('show'), 10);
                
                // Start progress animation
                this.startStoryProgress();
                
                // Auto close after 10 seconds
                this.storyTimeout = setTimeout(() => {
                    this.closeStoryViewer();
                }, 10000);
                
                // Close on click outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeStoryViewer();
                    }
                });
                
                // Keyboard navigation
                document.addEventListener('keydown', this.handleStoryKeyboard);
            },
            
            closeStoryViewer() {
                const modal = document.getElementById('storyViewer');
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => modal.remove(), 300);
                }
                
                if (this.storyTimeout) {
                    clearTimeout(this.storyTimeout);
                }
                
                if (this.progressInterval) {
                    clearInterval(this.progressInterval);
                }
                
                document.removeEventListener('keydown', this.handleStoryKeyboard);
            },
            
            startStoryProgress() {
                const progressBar = document.getElementById('storyProgressBar');
                if (!progressBar) return;
                
                let progress = 0;
                const duration = 10000; // 10 seconds
                const interval = 50; // Update every 50ms
                const increment = (interval / duration) * 100;
                
                this.progressInterval = setInterval(() => {
                    progress += increment;
                    progressBar.style.width = `${Math.min(progress, 100)}%`;
                    
                    if (progress >= 100) {
                        clearInterval(this.progressInterval);
                        this.closeStoryViewer();
                    }
                }, interval);
            },
            
            handleStoryKeyboard(e) {
                if (e.key === 'Escape') {
                    feedManager.closeStoryViewer();
                } else if (e.key === 'ArrowLeft') {
                    feedManager.previousStory();
                } else if (e.key === 'ArrowRight') {
                    feedManager.nextStory();
                }
            },
            
            previousStory() {
                // Navigate to previous story (if multiple stories exist)
                toastSystem.show('Story anterior', 'info');
            },
            
            nextStory() {
                // Navigate to next story (if multiple stories exist)
                toastSystem.show('Pr√≥ximo story', 'info');
            },
            
            openMediaModal(url, type) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="relative max-w-4xl max-h-full">
                        ${type === 'image' ? 
                            `<img src="${url}" alt="Media" class="max-w-full max-h-full object-contain rounded-lg">` :
                            `<video src="${url}" class="max-w-full max-h-full object-contain rounded-lg" controls autoplay></video>`
                        }
                        <button class="absolute top-4 right-4 bg-black/50 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-black/70 transition-colors duration-200" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            },
            
            loadMorePosts() {
                toastSystem.show('Carregando mais posts...', 'info');
                // Simulate loading more posts
                setTimeout(() => {
                    toastSystem.show('Todos os posts foram carregados', 'info');
                }, 1000);
            }
        };

        // Timeline System
        const timelineSystem = {
            currentObraId: null,
            selectedPhotos: [],
            
            openTimelineModal(obraId) {
                this.currentObraId = obraId;
                const obra = dataManager.obras.find(o => o.id === obraId);
                if (obra) {
                    document.getElementById('timelineObraName').textContent = obra.nome;
                    this.renderTimeline(obra.timeline);
                    modalSystem.open('timelineModal');
                }
            },
            
            closeTimelineModal() {
                modalSystem.close('timelineModal');
                this.currentObraId = null;
            },
            
            renderTimeline(timeline) {
                const container = document.getElementById('timelineContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                if (!timeline || timeline.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-clock text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-300">Nenhuma etapa registrada ainda</p>
                            <p class="text-gray-400 text-sm">Clique em "Adicionar Etapa" para come√ßar</p>
                        </div>
                    `;
                    return;
                }
                
                const timelineDiv = document.createElement('div');
                timelineDiv.className = 'timeline';
                
                timeline.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach((item, index) => {
                    const timelineItem = document.createElement('div');
                    timelineItem.className = `timeline-item ${item.status}`;
                    timelineItem.style.animationDelay = `${index * 0.1}s`;
                    
                    const photosHtml = item.fotos && item.fotos.length > 0 ? `
                        <div class="timeline-photos">
                            ${item.fotos.map(foto => `
                                <div class="timeline-photo" onclick="openPhotoModal('${foto.url}')">
                                    <img src="${foto.url}" alt="Foto da etapa" loading="lazy">
                                </div>
                            `).join('')}
                        </div>
                    ` : '';
                    
                    const statusIcon = {
                        'completed': 'fa-check-circle text-green-400',
                        'in-progress': 'fa-clock text-yellow-400',
                        'delayed': 'fa-exclamation-triangle text-red-400'
                    };
                    
                    const statusText = {
                        'completed': 'Conclu√≠da',
                        'in-progress': 'Em Andamento',
                        'delayed': 'Atrasada'
                    };
                    
                    timelineItem.innerHTML = `
                        <div class="timeline-content">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-semibold text-white">${item.titulo}</h4>
                                <div class="flex items-center space-x-2">
                                    <i class="fas ${statusIcon[item.status]} text-sm"></i>
                                    <span class="text-sm text-gray-300">${statusText[item.status]}</span>
                                    <button onclick="deleteTimelineItem(${item.id})" class="ml-2 text-red-400 hover:text-red-300 transition-colors duration-200 p-1" title="Excluir etapa">
                                        <i class="fas fa-trash text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <p class="text-gray-300 text-sm mb-3">${item.descricao}</p>
                            
                            <div class="flex items-center justify-between text-xs text-gray-400">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-calendar"></i>
                                    <span>${new Date(item.data).toLocaleDateString('pt-BR')}</span>
                                </div>
                                ${item.fotos && item.fotos.length > 0 ? `
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-camera"></i>
                                        <span>${item.fotos.length} foto${item.fotos.length > 1 ? 's' : ''}</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${photosHtml}
                        </div>
                    `;
                    
                    timelineDiv.appendChild(timelineItem);
                });
                
                container.appendChild(timelineDiv);
            },
            
            openAddStageModal() {
                if (!this.currentObraId) return;
                
                // Set today as default date
                document.getElementById('stageDate').value = new Date().toISOString().split('T')[0];
                this.selectedPhotos = [];
                document.getElementById('photoPreview').innerHTML = '';
                document.getElementById('photoPreview').classList.add('hidden');
                
                modalSystem.open('addStageModal');
            },
            
            closeAddStageModal() {
                modalSystem.close('addStageModal');
                document.getElementById('addStageForm').reset();
                this.selectedPhotos = [];
            },
            
            handlePhotoSelection(event) {
                const files = Array.from(event.target.files);
                const preview = document.getElementById('photoPreview');
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const photoData = {
                                file: file,
                                url: e.target.result,
                                name: file.name
                            };
                            
                            this.selectedPhotos.push(photoData);
                            this.updatePhotoPreview();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            },
            
            updatePhotoPreview() {
                const preview = document.getElementById('photoPreview');
                
                if (this.selectedPhotos.length === 0) {
                    preview.classList.add('hidden');
                    return;
                }
                
                preview.classList.remove('hidden');
                preview.innerHTML = this.selectedPhotos.map((photo, index) => `
                    <div class="photo-preview">
                        <img src="${photo.url}" alt="${photo.name}">
                        <button type="button" class="remove-photo" onclick="timelineSystem.removePhoto(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            },
            
            removePhoto(index) {
                this.selectedPhotos.splice(index, 1);
                this.updatePhotoPreview();
            },
            
            addStage(stageData) {
                const obra = dataManager.obras.find(o => o.id === this.currentObraId);
                if (!obra) return;
                
                if (!obra.timeline) {
                    obra.timeline = [];
                }
                
                const newStage = {
                    id: obra.timeline.length + 1,
                    titulo: stageData.titulo,
                    descricao: stageData.descricao,
                    data: stageData.data,
                    status: 'completed',
                    fotos: this.selectedPhotos.map(photo => ({
                        url: photo.url,
                        name: photo.name
                    }))
                };
                
                obra.timeline.push(newStage);
                this.renderTimeline(obra.timeline);
                this.closeAddStageModal();
                
                toastSystem.show('Etapa adicionada com sucesso!', 'success');
            },
            
            async generatePhotoReport() {
                if (!this.currentObraId) return;
                
                const obra = dataManager.obras.find(o => o.id === this.currentObraId);
                if (!obra || !obra.timeline) {
                    toastSystem.show('Nenhuma etapa encontrada para gerar relatorio', 'warning');
                    return;
                }
                
                toastSystem.show('Gerando relatorio fotografico...', 'info');
                
                const pdfAvailable = await reportSystem.checkPDFLibrary();
                if (!pdfAvailable) {
                    toastSystem.show('Erro: Biblioteca PDF nao carregou. Tente novamente.', 'error');
                    return;
                }
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Helper function to add images with high quality
                    const addImageToPDF = (imgData, x, y, width, height) => {
                        try {
                            doc.addImage(imgData, 'JPEG', x, y, width, height, undefined, 'FAST');
                        } catch (error) {
                            console.warn('Erro ao adicionar imagem:', error);
                        }
                    };
                    
                    // Helper function to create header
                    const createHeader = () => {
                        // Header background
                        doc.setFillColor(30, 58, 138);
                        doc.rect(0, 0, 210, 35, 'F');
                        
                        // SEMCAS logo area
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(22);
                        doc.setFont('helvetica', 'bold');
                        doc.text('SEMCAS', 15, 20);
                        
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Sistema de Gestao de Obras', 15, 28);
                        
                        // Document type
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('RELATORIO FOTOGRAFICO', 120, 20);
                        
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Documento Oficial', 120, 28);
                    };
                    
                    // Helper function to create footer
                    const createFooter = (pageNum, totalPages) => {
                        doc.setDrawColor(59, 130, 246);
                        doc.setLineWidth(0.3);
                        doc.line(15, 280, 195, 280);
                        
                        doc.setTextColor(100, 100, 100);
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'normal');
                        doc.text('SEMCAS - Sistema de Gestao de Obras | Documento Oficial', 15, 285);
                        doc.text('Pagina ' + pageNum + ' de ' + totalPages, 170, 285);
                        doc.text('Gerado em ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR'), 15, 290);
                    };
                    
                    // First page - Cover and info
                    createHeader();
                    
                    // Work information section
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('INFORMACOES DA OBRA', 15, 50);
                    
                    // Info box
                    doc.setFillColor(245, 247, 250);
                    doc.rect(15, 55, 180, 40, 'F');
                    doc.setDrawColor(59, 130, 246);
                    doc.setLineWidth(0.5);
                    doc.rect(15, 55, 180, 40);
                    
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Nome da Obra: ' + obra.nome, 20, 65);
                    doc.text('Localizacao: ' + obra.localizacao, 20, 73);
                    doc.text('Progresso Atual: ' + obra.progresso + '%', 20, 81);
                    doc.text('Valor da Obra: R$ ' + obra.valor.toLocaleString('pt-BR'), 20, 89);
                    
                    // Generation info
                    doc.setFontSize(10);
                    doc.setTextColor(100, 116, 139);
                    doc.text('Data de Geracao: ' + new Date().toLocaleDateString('pt-BR') + ' as ' + new Date().toLocaleTimeString('pt-BR'), 20, 110);
                    doc.text('Responsavel: ' + (authSystem.currentUser?.username || 'Sistema'), 20, 118);
                    
                    // Summary section
                    doc.setTextColor(45, 55, 72);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('RESUMO DO RELATORIO', 15, 135);
                    
                    const totalStages = obra.timeline.length;
                    const completedStages = obra.timeline.filter(s => s.status === 'completed').length;
                    const totalPhotos = obra.timeline.reduce((acc, stage) => acc + (stage.fotos ? stage.fotos.length : 0), 0);
                    
                    // Summary box
                    doc.setFillColor(248, 250, 252);
                    doc.rect(15, 140, 180, 35, 'F');
                    doc.setDrawColor(74, 158, 255);
                    doc.setLineWidth(1);
                    doc.rect(15, 140, 180, 35);
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(45, 55, 72);
                    doc.text('Total de Etapas: ' + totalStages, 20, 150);
                    doc.text('Etapas Concluidas: ' + completedStages, 20, 158);
                    doc.text('Total de Fotografias: ' + totalPhotos, 110, 150);
                    doc.text('Periodo: ' + (obra.dataInicio ? new Date(obra.dataInicio).toLocaleDateString('pt-BR') : 'N/A') + ' ate ' + new Date().toLocaleDateString('pt-BR'), 20, 166);
                    
                    let currentPage = 1;
                    let yPosition = 180;
                    
                    // Process each timeline stage
                    for (let stageIndex = 0; stageIndex < obra.timeline.length; stageIndex++) {
                        const stage = obra.timeline[stageIndex];
                        
                        // Check if we need a new page for stage header
                        if (yPosition > 240) {
                            createFooter(currentPage, '...');
                            doc.addPage();
                            currentPage++;
                            createHeader();
                            yPosition = 45;
                        }
                        
                        // Stage header
                        doc.setFillColor(59, 130, 246);
                        doc.rect(15, yPosition - 5, 180, 12, 'F');
                        
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text('ETAPA ' + (stageIndex + 1) + ': ' + stage.titulo.toUpperCase(), 20, yPosition + 3);
                        
                        yPosition += 15;
                        
                        // Stage details
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        
                        const stageDate = new Date(stage.data).toLocaleDateString('pt-BR');
                        const statusText = {
                            'completed': 'Concluida',
                            'in-progress': 'Em Andamento',
                            'delayed': 'Atrasada'
                        };
                        
                        doc.text('Data: ' + stageDate, 20, yPosition);
                        doc.text('Status: ' + (statusText[stage.status] || 'N/A'), 100, yPosition);
                        yPosition += 8;
                        
                        // Description
                        doc.setFont('helvetica', 'normal');
                        doc.text('Descricao:', 20, yPosition);
                        yPosition += 5;
                        
                        const descriptionLines = doc.splitTextToSize(stage.descricao, 170);
                        doc.text(descriptionLines, 20, yPosition);
                        yPosition += descriptionLines.length * 4 + 8;
                        
                        // Photos section
                        if (stage.fotos && stage.fotos.length > 0) {
                            doc.setFont('helvetica', 'bold');
                            doc.text('Fotografias (' + stage.fotos.length + ' imagem' + (stage.fotos.length > 1 ? 'ns' : '') + '):', 20, yPosition);
                            yPosition += 8;
                            
                            // Process photos
                            for (let photoIndex = 0; photoIndex < stage.fotos.length; photoIndex++) {
                                const foto = stage.fotos[photoIndex];
                                
                                // Check if we need a new page for photo
                                if (yPosition > 200) {
                                    createFooter(currentPage, '...');
                                    doc.addPage();
                                    currentPage++;
                                    createHeader();
                                    yPosition = 45;
                                }
                                
                                try {
                                    // Create a canvas for image processing
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    const img = new Image();
                                    
                                    await new Promise((resolve, reject) => {
                                        img.onload = () => {
                                            // Set canvas size for quality
                                            const maxWidth = 600;
                                            const maxHeight = 400;
                                            
                                            let { width, height } = img;
                                            
                                            // Maintain aspect ratio
                                            if (width > maxWidth) {
                                                height = (height * maxWidth) / width;
                                                width = maxWidth;
                                            }
                                            if (height > maxHeight) {
                                                width = (width * maxHeight) / height;
                                                height = maxHeight;
                                            }
                                            
                                            canvas.width = width;
                                            canvas.height = height;
                                            
                                            // Enable image smoothing
                                            ctx.imageSmoothingEnabled = true;
                                            ctx.imageSmoothingQuality = 'high';
                                            
                                            // Draw image
                                            ctx.drawImage(img, 0, 0, width, height);
                                            
                                            // Convert to JPEG
                                            const imageData = canvas.toDataURL('image/jpeg', 0.95);
                                            
                                            // Calculate PDF dimensions
                                            const pdfWidth = Math.min(80, (width / height) * 60);
                                            const pdfHeight = Math.min(60, (height / width) * 80);
                                            
                                            // Add image to PDF
                                            addImageToPDF(imageData, 20, yPosition, pdfWidth, pdfHeight);
                                            
                                            // Add photo caption
                                            doc.setFontSize(8);
                                            doc.setFont('helvetica', 'italic');
                                            doc.text('Foto ' + (photoIndex + 1) + ': ' + (foto.name || 'Sem titulo'), 20, yPosition + pdfHeight + 5);
                                            
                                            resolve();
                                        };
                                        
                                        img.onerror = () => {
                                            // Fallback for broken images
                                            const fallbackWidth = 90;
                                            const fallbackHeight = 80;
                                            
                                            doc.setFillColor(240, 240, 240);
                                            doc.rect(20, yPosition, fallbackWidth, fallbackHeight, 'F');
                                            doc.setDrawColor(200, 200, 200);
                                            doc.setLineWidth(0.5);
                                            doc.rect(20, yPosition, fallbackWidth, fallbackHeight);
                                            
                                            doc.setTextColor(150, 150, 150);
                                            doc.setFontSize(10);
                                            doc.setFont('helvetica', 'bold');
                                            doc.text('IMAGEM NAO DISPONIVEL', 65, yPosition + fallbackHeight/2 - 3, { align: 'center' });
                                            doc.setFontSize(8);
                                            doc.setFont('helvetica', 'italic');
                                            doc.text('Foto ' + (photoIndex + 1) + ': ' + (foto.name || 'Sem titulo'), 20, yPosition + fallbackHeight + 8);
                                            doc.setTextColor(0, 0, 0);
                                            resolve();
                                        };
                                        
                                        img.src = foto.url;
                                    });
                                    
                                    yPosition += 70;
                                    
                                } catch (error) {
                                    console.warn('Erro ao processar foto:', error);
                                    // Fallback for image processing errors
                                    const fallbackHeight = 80;
                                    doc.setFillColor(240, 240, 240);
                                    doc.rect(20, yPosition, 90, fallbackHeight, 'F');
                                    doc.setDrawColor(200, 200, 200);
                                    doc.setLineWidth(0.5);
                                    doc.rect(20, yPosition, 90, fallbackHeight);
                                    doc.setTextColor(150, 150, 150);
                                    doc.setFontSize(10);
                                    doc.text('Erro ao carregar imagem', 65, yPosition + fallbackHeight/2, { align: 'center' });
                                    doc.setTextColor(0, 0, 0);
                                    yPosition += fallbackHeight + 15;
                                }
                            }
                        } else {
                            // No photos message
                            doc.setFillColor(248, 250, 252);
                            doc.rect(20, yPosition, 170, 25, 'F');
                            doc.setDrawColor(226, 232, 240);
                            doc.setLineWidth(0.5);
                            doc.rect(20, yPosition, 170, 25);
                            
                            doc.setTextColor(100, 116, 139);
                            doc.setFontSize(10);
                            doc.setFont('helvetica', 'italic');
                            doc.text('Nenhuma fotografia registrada para esta etapa', 105, yPosition + 15, { align: 'center' });
                            yPosition += 35;
                        }
                        
                        // Stage separator
                        yPosition += 10;
                        
                        // Separator line
                        doc.setDrawColor(74, 158, 255);
                        doc.setLineWidth(1);
                        doc.line(15, yPosition, 195, yPosition);
                        
                        doc.setDrawColor(184, 197, 209);
                        doc.setLineWidth(0.3);
                        doc.line(15, yPosition + 1, 195, yPosition + 1);
                        
                        yPosition += 20;
                    }
                    
                    // Update page numbers
                    const totalPages = doc.internal.getNumberOfPages();
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        createFooter(i, totalPages);
                    }
                    
                    // Generate filename
                    const fileName = 'relatorio_fotografico_' + obra.nome.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase() + '_' + new Date().toISOString().split('T')[0] + '.pdf';
                    
                    // Save PDF
                    doc.save(fileName);
                    
                    toastSystem.show('Relatorio fotografico gerado com sucesso!', 'success');
                    
                } catch (error) {
                    console.error('Erro ao gerar relatorio:', error);
                    toastSystem.show('Erro ao gerar relatorio fotografico', 'error');
                }
            }
        };

        // Global Functions
        function openAddObraModal() {
            // Reset modal for new obra
            document.getElementById('obraModalTitle').textContent = 'Nova Obra';
            document.getElementById('obraSubmitText').textContent = 'Salvar';
            document.getElementById('addObraForm').reset();
            document.getElementById('obraId').value = '';
            document.getElementById('progressoValue').textContent = '0%';
            
            modalSystem.open('addObraModal');
        }

        function openAddProductModal() {
            modalSystem.open('addProductModal');
        }

        function openUploadPlanilhaModal() {
            modalSystem.open('uploadPlanilhaModal');
        }

        function closeUploadPlanilhaModal() {
            modalSystem.close('uploadPlanilhaModal');
            // Reset form
            document.getElementById('planilhaFile').value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadProgress').classList.add('hidden');
        }

        function removeFile() {
            document.getElementById('planilhaFile').value = '';
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
        }

        // Fun√ß√µes do Hist√≥rico de Dispensa√ß√£o
        function openHistoricoDispensacaoModal() {
            modalSystem.open('historicoDispensacaoModal');
            carregarHistoricoDispensacao();
        }

        function closeHistoricoDispensacaoModal() {
            modalSystem.close('historicoDispensacaoModal');
        }

        async function carregarHistoricoDispensacao() {
            try {
                const response = await fetch('/api/produtos/movimentacoes');
                if (response.ok) {
                    const movimentacoes = await response.json();
                    exibirHistoricoDispensacao(movimentacoes);
                } else {
                    toastSystem.show('Erro ao carregar hist√≥rico de dispensa√ß√£o', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar hist√≥rico:', error);
                toastSystem.show('Erro de conex√£o ao carregar hist√≥rico', 'error');
            }
        }

        function exibirHistoricoDispensacao(movimentacoes) {
            const container = document.getElementById('historicoDispensacaoList');
            
            if (!movimentacoes || movimentacoes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-history text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-400">Nenhuma movimenta√ß√£o encontrada</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = movimentacoes.map(mov => `
                <div class="glassmorphism bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all duration-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 rounded-xl ${mov.tipo === 'entrada' ? 'bg-green-600/20 text-green-400' : 'bg-red-600/20 text-red-400'} flex items-center justify-center">
                                <i class="fas ${mov.tipo === 'entrada' ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                            </div>
                            <div>
                                <h4 class="text-white font-medium">${mov.produto?.nome || 'Produto n√£o encontrado'}</h4>
                                <p class="text-gray-400 text-sm">${mov.motivo}</p>
                                <p class="text-gray-500 text-xs">Por: ${mov.usuario} ‚Ä¢ ${new Date(mov.dataMovimentacao).toLocaleString('pt-BR')}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-white font-bold text-lg">
                                ${mov.tipo === 'entrada' ? '+' : '-'}${mov.quantidade}
                            </div>
                            <div class="text-gray-400 text-sm">
                                ${mov.quantidadeAnterior} ‚Üí ${mov.quantidadeAtual}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filtrarHistoricoDispensacao() {
            // Implementar filtros se necess√°rio
            carregarHistoricoDispensacao();
        }

        function downloadTemplate() {
            // Criar template CSV
            const template = [
                ['nome', 'categoria', 'codigo', 'estoque', 'estoque_minimo', 'preco'],
                ['Cimento Portland', 'cimento', '7891234567890', '100', '50', '32.50'],
                ['Tijolo Cer√¢mico', 'alvenaria', '7891234567891', '1000', '500', '0.85'],
                ['Areia M√©dia', 'agregados', '7891234567892', '50', '20', '45.00']
            ];
            
            const csvContent = template.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_estoque.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        async function processUpload() {
            const fileInput = document.getElementById('planilhaFile');
            const file = fileInput.files[0];
            
            if (!file) {
                toastSystem.show('Selecione um arquivo primeiro', 'error');
                return;
            }
            
            // Validar tipo de arquivo
            const allowedTypes = ['.csv', '.xlsx', '.xls'];
            const fileName = file.name.toLowerCase();
            const isValidType = allowedTypes.some(ext => fileName.endsWith(ext));
            
            if (!isValidType) {
                toastSystem.show('Tipo de arquivo n√£o suportado. Use CSV, Excel (.xlsx, .xls)', 'error');
                return;
            }
            
            // Validar tamanho do arquivo (m√°ximo 10MB)
            if (file.size > 10 * 1024 * 1024) {
                toastSystem.show('Arquivo muito grande. Tamanho m√°ximo: 10MB', 'error');
                return;
            }
            
            // Mostrar progress bar
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadBtn').disabled = true;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('validateDuplicates', document.getElementById('validateDuplicates').checked);
            formData.append('validatePrices', document.getElementById('validatePrices').checked);
            formData.append('validateStock', document.getElementById('validateStock').checked);
            formData.append('updateExisting', document.getElementById('updateExisting').checked);
            
            try {
                // Configurar timeout de 2 minutos
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000);
                
                const response = await fetch('/api/produtos/upload', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.json();
                    toastSystem.show(`Planilha processada com sucesso! ${result.created} produtos criados, ${result.updated} atualizados`, 'success');
                    closeUploadPlanilhaModal();
                    dataManager.loadProdutos(); // Recarregar produtos
                } else {
                    const error = await response.json();
                    console.error('Erro do servidor:', error);
                    toastSystem.show(`Erro ao processar planilha: ${error.error || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                console.error('Erro completo:', error);
                if (error.name === 'AbortError') {
                    toastSystem.show('Upload cancelado por timeout. Tente com um arquivo menor.', 'error');
                } else {
                    toastSystem.show(`Erro ao fazer upload da planilha: ${error.message}`, 'error');
                }
            } finally {
                document.getElementById('uploadProgress').classList.add('hidden');
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function openScannerModal() {
            modalSystem.open('scannerModal');
        }

        function openThemeModal() {
            modalSystem.open('themeModal');
        }

        function closeThemeModal() {
            modalSystem.close('themeModal');
        }

        function openCustomReportModal() {
            toastSystem.show('Modal de relat√≥rio personalizado em desenvolvimento', 'info');
        }

        function setTheme(theme) {
            document.body.className = `gradient-bg min-h-screen theme-${theme}`;
            historySystem.addEntry('edit', 'Sistema', `Tema alterado para: ${theme}`, 'success');
            toastSystem.show(`Tema ${theme} aplicado com sucesso!`, 'success');
            closeThemeModal();
        }

        function openAccessHistoryModal() {
            historySystem.addEntry('view', 'Navega√ß√£o', 'Acessou hist√≥rico de atividades', 'success');
            modalSystem.open('accessHistoryModal');
            historySystem.updateDisplay();
        }

        function closeAccessHistoryModal() {
            modalSystem.close('accessHistoryModal');
        }

        function exportAccessHistory() {
            historySystem.exportHistory();
            historySystem.addEntry('download', 'Sistema', 'Exportou hist√≥rico de acesso em CSV', 'success');
        }

        function clearAccessHistory() {
            historySystem.clearHistory();
        }

        function openTimelineModal(obraId) {
            timelineSystem.openTimelineModal(obraId);
        }

        function closeTimelineModal() {
            timelineSystem.closeTimelineModal();
        }

        function openAddStageModal() {
            timelineSystem.openAddStageModal();
        }

        function closeAddStageModal() {
            timelineSystem.closeAddStageModal();
        }

        function generatePhotoReport() {
            timelineSystem.generatePhotoReport();
        }

        function openPhotoModal(photoUrl) {
            const modal = document.createElement('div');
            modal.className = 'photo-modal';
            modal.innerHTML = `
                <img src="${photoUrl}" alt="Foto da etapa">
                <button class="close-photo" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('show'), 10);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function editObra(id) {
            const obra = dataManager.getObraById(id);
            if (!obra) {
                toastSystem.show('Obra n√£o encontrada!', 'error');
                return;
            }
            
            // Update modal title and button text
            document.getElementById('obraModalTitle').textContent = 'Editar Obra';
            document.getElementById('obraSubmitText').textContent = 'Atualizar';
            
            // Fill form with current data
            document.getElementById('obraId').value = obra.id;
            document.getElementById('obraNome').value = obra.nome;
            document.getElementById('obraLocalizacao').value = obra.localizacao;
            document.getElementById('obraValor').value = obra.valor;
            document.getElementById('obraStatus').value = obra.status;
            document.getElementById('obraProgresso').value = obra.progresso;
            document.getElementById('progressoValue').textContent = obra.progresso + '%';
            document.getElementById('obraDataInicio').value = obra.dataInicio || '';
            
            // Open modal
            modalSystem.open('addObraModal');
        }

        function viewObraDetails(id) {
            toastSystem.show('Detalhes da obra em desenvolvimento', 'info');
        }

        function editProduct(id) {
            const produto = dataManager.produtos.find(p => p.id === id);
            if (!produto) return;
            
            // Preencher o modal de edi√ß√£o
            document.getElementById('editProdutoId').value = produto.id;
            document.getElementById('editProdutoNome').value = produto.nome;
            document.getElementById('editProdutoCategoria').value = produto.categoria;
            document.getElementById('editProdutoCodigo').value = produto.codigo;
            document.getElementById('editProdutoEstoque').value = produto.estoque;
            document.getElementById('editProdutoEstoqueMinimo').value = produto.estoqueMinimo;
            document.getElementById('editProdutoPreco').value = produto.preco;
            document.getElementById('editProdutoUnidade').value = produto.unidade || 'unidade';
            document.getElementById('editProdutoDescricao').value = produto.descricao || '';
            
            modalSystem.open('editProductModal');
        }

        function dispensarProduct(id) {
            const produto = dataManager.produtos.find(p => p.id === id);
            if (!produto) return;
            
            // Preencher o modal de dispensa√ß√£o
            document.getElementById('dispensarProdutoId').value = produto.id;
            document.getElementById('dispensarProdutoNome').value = produto.nome;
            document.getElementById('dispensarQuantidade').max = produto.estoque;
            
            // Definir data atual
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dispensarData').value = hoje;
            
            modalSystem.open('dispensarModal');
        }

        function uploadFotoProduct(id) {
            const produto = dataManager.produtos.find(p => p.id === id);
            if (!produto) return;
            
            // Preencher o modal de upload de foto
            document.getElementById('fotoProdutoId').value = produto.id;
            document.getElementById('fotoProdutoNome').value = produto.nome;
            
            // Resetar preview
            document.getElementById('fotoPreview').classList.add('hidden');
            document.getElementById('fotoInput').value = '';
            
            modalSystem.open('uploadFotoModal');
        }

        function adjustStock(id) {
            toastSystem.show('Ajuste de estoque em desenvolvimento', 'info');
        }

        async function viewHistoricoProduct(id) {
            const produto = dataManager.produtos.find(p => p.id === id);
            if (!produto) return;
            
            try {
                // Buscar hist√≥rico de movimenta√ß√µes do produto
                const response = await fetch(`/api/produtos/movimentacoes/${id}`);
                if (!response.ok) {
                    throw new Error('Erro ao buscar hist√≥rico de movimenta√ß√µes');
                }
                
                const movimentacoes = await response.json();
                
                // Preencher o modal de hist√≥rico
                document.getElementById('historicoProdutoNome').textContent = produto.nome;
                document.getElementById('historicoProdutoCodigo').textContent = produto.codigo;
                
                const tbody = document.getElementById('historicoMovimentacoesBody');
                tbody.innerHTML = '';
                
                if (movimentacoes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-400">
                                <i class="fas fa-inbox text-3xl mb-2"></i>
                                <p>Nenhuma movimenta√ß√£o encontrada</p>
                            </td>
                        </tr>
                    `;
                } else {
                    movimentacoes.forEach(mov => {
                        const tipoIcon = mov.tipo === 'entrada' ? 'fa-plus text-green-400' : 'fa-minus text-red-400';
                        const tipoText = mov.tipo === 'entrada' ? 'Entrada' : 'Sa√≠da';
                        const dataFormatada = new Date(mov.dataMovimentacao).toLocaleDateString('pt-BR');
                        
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-white/5';
                        row.innerHTML = `
                            <td class="px-6 py-4 text-sm text-gray-300">${dataFormatada}</td>
                            <td class="px-6 py-4 text-sm">
                                <span class="inline-flex items-center">
                                    <i class="fas ${tipoIcon} mr-2"></i>
                                    ${tipoText}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-white font-medium">${mov.quantidade}</td>
                            <td class="px-6 py-4 text-sm text-gray-300">${mov.quantidadeAnterior}</td>
                            <td class="px-6 py-4 text-sm text-gray-300">${mov.quantidadeAtual}</td>
                            <td class="px-6 py-4 text-sm text-gray-300">${mov.motivo}</td>
                            <td class="px-6 py-4 text-sm text-blue-400">${mov.usuario}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
                modalSystem.open('historicoMovimentacoesModal');
                
            } catch (error) {
                console.error('Erro ao buscar hist√≥rico:', error);
                toastSystem.show('Erro ao carregar hist√≥rico de movimenta√ß√µes', 'error');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById("username").value.trim();
                const userType = document.getElementById("userType").value;
                const password = document.getElementById("password").value;
                
                if (authSystem.login(username, userType, password)) {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('userInfo').textContent = `Bem-vindo, ${username}!`;
                    
                    toastSystem.show(`Login realizado com sucesso! Bem-vindo, ${username}!`, 'success');
                    
                    // Initialize dashboard with API data
                    dataManager.init();
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                authSystem.logout();
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('username').value = '';
                toastSystem.show('Logout realizado com sucesso!', 'info');
            });
            
            // Navigation buttons
            document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    ui.switchTab(this.dataset.tab);
                });
            });
            
            // Add/Edit Obra form
            document.getElementById('addObraForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const obraId = document.getElementById('obraId').value;
                const nome = document.getElementById('obraNome').value;
                const localizacao = document.getElementById('obraLocalizacao').value;
                const valor = parseFloat(document.getElementById('obraValor').value);
                const status = document.getElementById('obraStatus').value;
                const progresso = parseInt(document.getElementById('obraProgresso').value);
                const dataInicio = document.getElementById('obraDataInicio').value;
                
                const obraData = {
                    nome: nome,
                    localizacao: localizacao,
                    progresso: progresso,
                    valor: valor,
                    status: status,
                    dataInicio: dataInicio || new Date().toISOString().split('T')[0]
                };
                
                if (obraId) {
                    // Edit existing obra
                    if (dataManager.updateObra(parseInt(obraId), obraData)) {
                        toastSystem.show('Obra atualizada com sucesso!', 'success');
                    } else {
                        toastSystem.show('Erro ao atualizar obra!', 'error');
                    }
                } else {
                    // Add new obra
                    dataManager.addObra(obraData);
                    toastSystem.show('Obra adicionada com sucesso!', 'success');
                }
                
                modalSystem.close('addObraModal');
                this.reset();
            });
            
            // Add Product form
            document.getElementById('addProductForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nome = document.getElementById('productName').value;
                const categoria = document.getElementById('productCategory').value;
                const codigo = document.getElementById('productBarcode').value;
                const estoque = parseInt(document.getElementById('productStock').value);
                const estoqueMinimo = parseInt(document.getElementById('productMinStock').value);
                const preco = parseFloat(document.getElementById('productPrice').value);
                
                const novoProduto = {
                    nome: nome,
                    categoria: categoria,
                    codigo: codigo,
                    estoque: estoque,
                    estoqueMinimo: estoqueMinimo,
                    preco: preco
                };
                
                dataManager.addProduto(novoProduto);
                modalSystem.close('addProductModal');
                this.reset();
                toastSystem.show('Produto adicionado com sucesso!', 'success');
            });
            
            // Add Stage form
            document.getElementById('addStageForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const titulo = document.getElementById('stageTitle').value;
                const descricao = document.getElementById('stageDescription').value;
                const data = document.getElementById('stageDate').value;
                
                const stageData = {
                    titulo: titulo,
                    descricao: descricao,
                    data: data
                };
                
                timelineSystem.addStage(stageData);
            });
            
            // Photo selection handler
            document.getElementById('stagePhotos').addEventListener('change', function(e) {
                timelineSystem.handlePhotoSelection(e);
            });
            
            // Modal close buttons
            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal-overlay');
                    if (modal) {
                        modalSystem.close(modal.id);
                    }
                });
            });
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        modalSystem.close(this.id);
                    }
                });
            });
            
            // Scanner buttons
            document.getElementById('startScanBtn')?.addEventListener('click', function() {
                toastSystem.show('Scanner iniciado! (Simula√ß√£o)', 'info');
            });
            
            document.getElementById('uploadImageBtn')?.addEventListener('click', function() {
                toastSystem.show('Upload de imagem em desenvolvimento', 'info');
            });
            
            document.getElementById('closeScannerBtn')?.addEventListener('click', function() {
                modalSystem.close('scannerModal');
            });
            
            document.getElementById('scanBarcodeBtn')?.addEventListener('click', function() {
                openScannerModal();
            });
            
            // Create Post form
            document.getElementById('createPostForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const description = document.getElementById('postDescription').value;
                const obra = document.getElementById('postObra').value;
                
                const postData = {
                    description: description,
                    obra: obra
                };
                
                feedManager.createPost(postData);
            });
            
            // Create Story form
            document.getElementById('createStoryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const text = document.getElementById('storyText').value;
                
                const storyData = {
                    text: text
                };
                
                feedManager.createStory(storyData);
            });
            
            // Post media selection handler
            document.getElementById('postMedia').addEventListener('change', function(e) {
                feedManager.handlePostMediaSelection(e);
            });
            
            // Story media selection handler
            document.getElementById('storyMedia').addEventListener('change', function(e) {
                feedManager.handleStoryMediaSelection(e);
            });
            
            // Initialize feed when switching to feed tab
            const originalSwitchTab = ui.switchTab;
            ui.switchTab = function(tabName) {
                originalSwitchTab.call(this, tabName);
                if (tabName === 'feed') {
                    feedManager.init();
                }
            };
            
            // Progress slider handler
            document.getElementById('obraProgresso').addEventListener('input', function(e) {
                document.getElementById('progressoValue').textContent = e.target.value + '%';
            });
            
            // File input handler for upload planilha
            document.getElementById('planilhaFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Show file info
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('fileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
                    document.getElementById('fileInfo').classList.remove('hidden');
                    document.getElementById('uploadBtn').disabled = false;
                } else {
                    document.getElementById('fileInfo').classList.add('hidden');
                    document.getElementById('uploadBtn').disabled = true;
                }
            });
            
            // Drag and drop for upload area
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('border-blue-400', 'bg-white/5');
                });
                
                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-400', 'bg-white/5');
                });
                
                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-400', 'bg-white/5');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        document.getElementById('planilhaFile').files = files;
                        // Trigger change event
                        const event = new Event('change', { bubbles: true });
                        document.getElementById('planilhaFile').dispatchEvent(event);
                    }
                });
            }
            
            // Initialize dashboard on load
            historySystem.init();
            dataManager.updateDashboard();
            dataManager.renderObras();
            dataManager.renderProdutos();
            feedManager.init();
            
            // Initialize furniture system
            furnitureSystem.init();
            
            // Event listeners para novos formul√°rios
            
            // Formul√°rio de dispensa√ß√£o
            document.getElementById('dispensarForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const produtoId = document.getElementById('dispensarProdutoId').value;
                const quantidade = parseInt(document.getElementById('dispensarQuantidade').value);
                const localUso = document.getElementById('dispensarLocalUso').value;
                const solicitante = document.getElementById('dispensarSolicitante').value;
                const dataDispensacao = document.getElementById('dispensarData').value;
                
                try {
                    const response = await fetch(`/api/produtos/${produtoId}/dispensar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            quantidade: quantidade,
                            local_uso: localUso,
                            solicitante: solicitante,
                            data_dispensacao: dataDispensacao
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        toastSystem.show('Produto dispensado com sucesso!', 'success');
                        modalSystem.close('dispensarModal');
                        dataManager.loadProdutos(); // Recarregar produtos
                        this.reset();
                    } else {
                        const error = await response.json();
                        toastSystem.show(error.error || 'Erro ao dispensar produto', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao dispensar produto:', error);
                    toastSystem.show('Erro ao dispensar produto', 'error');
                }
            });
            
            // Formul√°rio de edi√ß√£o de produto
            document.getElementById('editProductForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const produtoId = document.getElementById('editProdutoId').value;
                const dadosProduto = {
                    nome: document.getElementById('editProdutoNome').value,
                    categoria: document.getElementById('editProdutoCategoria').value,
                    codigo: document.getElementById('editProdutoCodigo').value,
                    estoque: parseInt(document.getElementById('editProdutoEstoque').value),
                    estoque_minimo: parseInt(document.getElementById('editProdutoEstoqueMinimo').value),
                    preco: parseFloat(document.getElementById('editProdutoPreco').value),
                    unidade: document.getElementById('editProdutoUnidade').value,
                    descricao: document.getElementById('editProdutoDescricao').value,
                    usuario: authSystem.currentUser?.username || 'Sistema'
                };
                
                try {
                    const response = await fetch(`/api/produtos/${produtoId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dadosProduto)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        toastSystem.show('Produto atualizado com sucesso!', 'success');
                        modalSystem.close('editProductModal');
                        dataManager.loadProdutos(); // Recarregar produtos
                        this.reset();
                    } else {
                        const error = await response.json();
                        toastSystem.show(error.error || 'Erro ao atualizar produto', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao atualizar produto:', error);
                    toastSystem.show('Erro ao atualizar produto', 'error');
                }
            });
            
            // Formul√°rio de upload de foto
            document.getElementById('uploadFotoForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const produtoId = document.getElementById('fotoProdutoId').value;
                const fotoInput = document.getElementById('fotoInput');
                
                if (!fotoInput.files[0]) {
                    toastSystem.show('Selecione uma foto para upload', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('foto', fotoInput.files[0]);
                
                try {
                    const response = await fetch(`/api/produtos/${produtoId}/foto`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        toastSystem.show('Foto enviada com sucesso!', 'success');
                        modalSystem.close('uploadFotoModal');
                        dataManager.loadProdutos(); // Recarregar produtos
                        this.reset();
                        document.getElementById('fotoPreview').classList.add('hidden');
                    } else {
                        const error = await response.json();
                        toastSystem.show(error.error || 'Erro ao enviar foto', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao enviar foto:', error);
                    toastSystem.show('Erro ao enviar foto', 'error');
                }
            });
            
            // Event listener para sele√ß√£o de arquivo de foto
            document.getElementById('fotoInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (!file.name.toLowerCase().endsWith('.png')) {
                        toastSystem.show('Apenas arquivos PNG s√£o aceitos', 'error');
                        this.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('fotoPreviewImg').src = e.target.result;
                        document.getElementById('fotoFileName').textContent = file.name;
                        document.getElementById('fotoPreview').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    document.getElementById('fotoPreview').classList.add('hidden');
                }
            });
            
            // Event listener para drag and drop de foto
            const fotoDropZone = document.getElementById('fotoDropZone');
            if (fotoDropZone) {
                fotoDropZone.addEventListener('click', function() {
                    document.getElementById('fotoInput').click();
                });
                
                fotoDropZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('border-purple-400', 'bg-white/5');
                });
                
                fotoDropZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('border-purple-400', 'bg-white/5');
                });
                
                fotoDropZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('border-purple-400', 'bg-white/5');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        document.getElementById('fotoInput').files = files;
                        // Trigger change event
                        const event = new Event('change', { bubbles: true });
                        document.getElementById('fotoInput').dispatchEvent(event);
                    }
                });
            }
        });

        // Furniture Management System
        const furnitureSystem = {
            currentObraId: null,
            furnitureTypes: [
                { name: 'Sof√°', icon: 'fa-couch' },
                { name: 'Mesa', icon: 'fa-table' },
                { name: 'Cama', icon: 'fa-bed' },
                { name: 'Cadeira', icon: 'fa-chair' },
                { name: 'Arm√°rio', icon: 'fa-archive' },
                { name: 'Escrivaninha', icon: 'fa-desktop' },
                { name: 'Estante', icon: 'fa-bookshelf' },
                { name: 'TV', icon: 'fa-tv' }
            ],
            roomLayout: [
                { name: 'Sala', id: 'sala' },
                { name: 'Quarto 1', id: 'quarto1' },
                { name: 'Quarto 2', id: 'quarto2' },
                { name: 'Cozinha', id: 'cozinha' },
                { name: 'Banheiro', id: 'banheiro' },
                { name: 'Escrit√≥rio', id: 'escritorio' }
            ],

            init() {
                this.setupEventListeners();
            },

            setupEventListeners() {
                // Add furniture form
                document.getElementById('addFurnitureForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addFurniture();
                });
            },

            openModal(obraId) {
                this.currentObraId = obraId;
                const obra = dataManager.obras.find(o => o.id === obraId);
                if (!obra) return;

                document.getElementById('furnitureObraName').textContent = obra.nome;
                if (!obra.furniture) obra.furniture = [];

                this.populateCatalog();
                this.populateForm();
                this.renderFloorPlan();
                this.renderInventory();

                const modal = document.getElementById('furnitureModal');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('.modal-content').style.transform = 'scale(1)';
                    modal.querySelector('.modal-content').style.opacity = '1';
                }, 10);

                historySystem.addEntry('view', 'Navega√ß√£o', `Abriu gest√£o de mobili√°rio para: ${obra.nome}`, 'success');
            },

            closeModal() {
                const modal = document.getElementById('furnitureModal');
                modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                modal.querySelector('.modal-content').style.opacity = '0';
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
                this.currentObraId = null;
            },

            populateCatalog() {
                const catalog = document.getElementById('furnitureCatalog');
                catalog.innerHTML = '';
                
                this.furnitureTypes.forEach(type => {
                    const item = document.createElement('div');
                    item.className = 'text-center p-2 bg-white/5 rounded-lg cursor-pointer draggable-furniture hover:bg-white/10 transition-all duration-200';
                    item.draggable = true;
                    item.dataset.type = type.name;
                    item.innerHTML = `
                        <i class="fas ${type.icon} text-2xl text-cyan-400"></i>
                        <p class="text-xs mt-1 text-white">${type.name}</p>
                    `;
                    catalog.appendChild(item);
                });
                
                this.setupDragAndDrop();
            },

            populateForm() {
                const typeSelect = document.getElementById('furnitureType');
                const roomSelect = document.getElementById('furnitureRoom');
                
                typeSelect.innerHTML = this.furnitureTypes.map(t => 
                    `<option value="${t.name}">${t.name}</option>`
                ).join('');
                
                roomSelect.innerHTML = this.roomLayout.map(r => 
                    `<option value="${r.id}">${r.name}</option>`
                ).join('');
            },

            renderFloorPlan() {
                const floorPlan = document.getElementById('floorPlan');
                floorPlan.innerHTML = '';
                
                this.roomLayout.forEach(room => {
                    const roomEl = document.createElement('div');
                    roomEl.id = `room-${room.id}`;
                    roomEl.className = 'room-dropzone border-2 border-dashed border-white/20 rounded-lg p-2 flex flex-col items-center justify-center hover:border-white/40 transition-all duration-200';
                    roomEl.dataset.roomId = room.id;
                    roomEl.innerHTML = `<p class="text-sm font-bold text-white">${room.name}</p>`;
                    floorPlan.appendChild(roomEl);
                });
                
                this.renderPlacedFurniture();
            },

            renderPlacedFurniture() {
                document.querySelectorAll('.placed-furniture').forEach(el => el.remove());
                const obra = dataManager.obras.find(o => o.id === this.currentObraId);
                if (!obra || !obra.furniture) return;

                obra.furniture.forEach((item, index) => {
                    const roomEl = document.getElementById(`room-${item.room}`);
                    if (roomEl) {
                        const furnitureIcon = document.createElement('div');
                        const typeInfo = this.furnitureTypes.find(t => t.name === item.type);
                        const color = item.status === 'existente' ? 'text-green-400' : 'text-orange-400';
                        
                        // Posicionamento fixo na planta baixa
                        furnitureIcon.className = `placed-furniture ${color} text-lg absolute cursor-pointer hover:scale-110 transition-transform duration-200`;
                        furnitureIcon.style.position = 'absolute';
                        furnitureIcon.style.left = item.x ? `${item.x}px` : `${20 + (index % 3) * 25}px`;
                        furnitureIcon.style.top = item.y ? `${item.y}px` : `${20 + Math.floor(index / 3) * 25}px`;
                        furnitureIcon.style.zIndex = '10';
                        furnitureIcon.dataset.furnitureId = item.id;
                        furnitureIcon.title = `${item.type} (${item.status})`;
                        
                        furnitureIcon.innerHTML = `<i class="fas ${typeInfo.icon}"></i>`;
                        
                        // Adicionar evento de clique para remover
                        furnitureIcon.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (confirm(`Remover ${item.type} de ${roomEl.querySelector('p').textContent}?`)) {
                                this.removeFurniture(item.id);
                            }
                        });
                        
                        roomEl.appendChild(furnitureIcon);
                    }
                });
            },

            renderInventory() {
                const obra = dataManager.obras.find(o => o.id === this.currentObraId);
                if (!obra) return;

                // Inventory by room
                const roomInventory = document.getElementById('roomInventory');
                roomInventory.innerHTML = '';
                
                this.roomLayout.forEach(room => {
                    const roomFurnitures = obra.furniture.filter(f => f.room === room.id);
                    const inventoryEl = document.createElement('div');
                    inventoryEl.innerHTML = `<h4 class="font-bold text-white">${room.name} (${roomFurnitures.length})</h4>`;
                    const list = document.createElement('ul');
                    list.className = 'text-sm pl-4';
                    roomFurnitures.forEach(f => {
                        const color = f.status === 'existente' ? 'text-green-400' : 'text-orange-400';
                        list.innerHTML += `<li class="${color}">${f.type}</li>`;
                    });
                    inventoryEl.appendChild(list);
                    roomInventory.appendChild(inventoryEl);
                });

                // General Stats
                const total = obra.furniture.length;
                const existentes = obra.furniture.filter(f => f.status === 'existente').length;
                const novos = total - existentes;
                
                document.getElementById('furnitureStats').innerHTML = `
                    <p class="text-white">Total de M√≥veis: <span class="font-bold">${total}</span></p>
                    <p class="text-green-400">Existentes: <span class="font-bold">${existentes}</span></p>
                    <p class="text-orange-400">Novos: <span class="font-bold">${novos}</span></p>
                `;
                
                this.renderPlacedFurniture();
            },

            setupDragAndDrop() {
                const draggables = document.querySelectorAll('.draggable-furniture');
                const dropzones = document.querySelectorAll('.room-dropzone');

                draggables.forEach(draggable => {
                    draggable.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('text/plain', e.target.dataset.type);
                    });
                });

                dropzones.forEach(dropzone => {
                    // Tornar o dropzone relativo para posicionamento absoluto dos m√≥veis
                    dropzone.style.position = 'relative';
                    dropzone.style.minHeight = '120px';
                    
                    dropzone.addEventListener('dragover', e => {
                        e.preventDefault();
                        dropzone.classList.add('bg-white/20');
                    });
                    
                    dropzone.addEventListener('dragleave', e => {
                        dropzone.classList.remove('bg-white/20');
                    });
                    
                    dropzone.addEventListener('drop', e => {
                        e.preventDefault();
                        dropzone.classList.remove('bg-white/20');
                        const type = e.dataTransfer.getData('text/plain');
                        const roomId = dropzone.dataset.roomId;
                        
                        // Calcular posi√ß√£o relativa ao dropzone
                        const rect = dropzone.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        this.addFurnitureToRoom(type, roomId, 'novo', x, y);
                    });
                });
            },

            addFurniture() {
                const type = document.getElementById('furnitureType').value;
                const room = document.getElementById('furnitureRoom').value;
                const status = document.getElementById('furnitureStatus').value;
                
                this.addFurnitureToRoom(type, room, status);
            },

            addFurnitureToRoom(type, room, status, x = null, y = null) {
                const obra = dataManager.obras.find(o => o.id === this.currentObraId);
                if (!obra) return;

                const newFurniture = {
                    id: Date.now(),
                    type: type,
                    room: room,
                    status: status,
                    x: x,
                    y: y
                };
                
                obra.furniture.push(newFurniture);
                dataManager.saveData();
                this.renderInventory();
                this.renderPlacedFurniture();
                this.generatePDF(); // Gerar PDF automaticamente
                
                historySystem.addEntry("create", "Cria√ß√£o", `Adicionou m√≥vel: ${type} em ${room}`, "success");
                toastSystem.show(`${type} adicionado a ${room}!`, "success");
            },

            removeFurniture(id) {
                const obra = dataManager.obras.find(o => o.id === this.currentObraId);
                if (!obra) return;

                obra.furniture = obra.furniture.filter(f => f.id !== id);
                dataManager.saveData();
                this.renderInventory();
                this.renderPlacedFurniture();
                
                historySystem.addEntry("delete", "Exclus√£o", `Removeu m√≥vel com ID: ${id}`, "success");
                toastSystem.show("M√≥vel removido com sucesso!", "success");
            },

            generatePDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const obra = dataManager.obras.find(o => o.id === this.currentObraId);

                doc.setFontSize(18);
                doc.text(`Relatorio de Mobiliario - ${obra.nome}`, 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 10, 10);
                doc.line(10, 25, 200, 25);

                let y = 40;
                this.roomLayout.forEach(room => {
                    const roomFurnitures = obra.furniture.filter(f => f.room === room.id);
                    if (roomFurnitures.length > 0) {
                        if (y > 260) { doc.addPage(); y = 20; }
                        doc.setFontSize(14);
                        doc.text(room.name, 10, y);
                        y += 7;
                        roomFurnitures.forEach(f => {
                            if (y > 270) { doc.addPage(); y = 20; }
                            doc.setFontSize(10);
                            const statusText = f.status === 'existente' ? '(Existente)' : '(Novo)';
                            doc.text(`- ${f.type} ${statusText}`, 15, y);
                            y += 5;
                        });
                        y += 5;
                    }
                });

                if (y > 260) { doc.addPage(); y = 20; }
                doc.line(10, y, 200, y); y += 10;
                doc.setFontSize(12);
                doc.text('Resumo Geral', 10, y); y += 7;
                const total = obra.furniture.length;
                const existentes = obra.furniture.filter(f => f.status === 'existente').length;
                const novos = total - existentes;
                doc.text(`Total de Moveis: ${total}`, 15, y); y += 5;
                doc.text(`Moveis Existentes: ${existentes}`, 15, y); y += 5;
                doc.text(`Moveis Novos: ${novos}`, 15, y);

                doc.save(`relatorio_mobiliario_${obra.nome.replace(/ /g, '_')}.pdf`);
                historySystem.addEntry('download', 'Sistema', `Gerou PDF de mobili√°rio para: ${obra.nome}`, 'success');
                toastSystem.show('Relat√≥rio de mobili√°rio gerado!', 'success');
            }
        };

        // Global functions for furniture system
        function openFurnitureModal(obraId) {
            furnitureSystem.openModal(obraId);
        }

        function closeFurnitureModal() {
            furnitureSystem.closeModal();
        }

        function generateFurniturePDF() {
            furnitureSystem.generatePDF();
        }

        // Timeline management functions
        async function deleteTimelineItem(etapaId) {
            if (!etapaId) {
                toastSystem.show('ID da etapa n√£o encontrado', 'error');
                return;
            }

            const confirmDelete = confirm('Tem certeza que deseja excluir esta etapa? Ela ser√° movida para a lixeira.');
            if (!confirmDelete) return;

            try {
                const usuario = authSystem.getCurrentUser()?.username || 'Sistema';
                
                // Fazer soft delete da etapa (mover para lixeira)
                const response = await fetch(`/api/etapas/${etapaId}/soft-delete`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ usuario })
                });

                if (response.ok) {
                    toastSystem.show('Etapa movida para a lixeira com sucesso!', 'success');
                    
                    // Registrar no hist√≥rico
                    historySystem.addEntry('delete', usuario, `Moveu etapa para a lixeira`, 'success');
                    
                    // Atualizar o timeline
                    if (timelineSystem.currentObraId) {
                        timelineSystem.loadTimeline(timelineSystem.currentObraId);
                    }
                    
                    // Atualizar a lista de obras
                    ui.loadObras();
                } else {
                    const error = await response.json();
                    toastSystem.show(`Erro ao excluir etapa: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir etapa:', error);
                toastSystem.show('Erro de conex√£o ao excluir etapa', 'error');
            }
        }

        async function openTrashModal() {
            try {
                const response = await fetch('/api/lixeira');
                if (response.ok) {
                    const lixeiraItems = await response.json();
                    renderTrashModal(lixeiraItems);
                    modalSystem.open('trashModal');
                } else {
                    toastSystem.show('Erro ao carregar lixeira', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar lixeira:', error);
                toastSystem.show('Erro de conex√£o ao carregar lixeira', 'error');
            }
        }

        function renderTrashModal(items) {
            const container = document.getElementById('trashContainer');
            if (!container) return;

            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-trash text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-300">Lixeira vazia</p>
                        <p class="text-gray-400 text-sm">Nenhuma etapa foi exclu√≠da</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="glassmorphism bg-white/5 rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h4 class="text-white font-medium">${item.etapa?.titulo || 'Etapa sem t√≠tulo'}</h4>
                            <p class="text-gray-300 text-sm">${item.etapa?.descricao || 'Sem descri√ß√£o'}</p>
                            <div class="flex items-center space-x-4 text-xs text-gray-400 mt-2">
                                <span><i class="fas fa-calendar mr-1"></i>${new Date(item.dataExclusao).toLocaleDateString('pt-BR')}</span>
                                <span><i class="fas fa-user mr-1"></i>${item.usuarioExclusao}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-4">
                            <button onclick="restoreTimelineItem(${item.etapaId})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm transition-all duration-200" title="Restaurar">
                                <i class="fas fa-undo mr-1"></i>Restaurar
                            </button>
                            <button onclick="permanentDeleteTimelineItem(${item.etapaId})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm transition-all duration-200" title="Excluir permanentemente">
                                <i class="fas fa-trash mr-1"></i>Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function restoreTimelineItem(etapaId) {
            if (!etapaId) return;

            try {
                const response = await fetch(`/api/etapas/${etapaId}/restore`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    toastSystem.show('Etapa restaurada com sucesso!', 'success');
                    
                    // Registrar no hist√≥rico
                    const usuario = authSystem.getCurrentUser()?.username || 'Sistema';
                    historySystem.addEntry('restore', usuario, `Restaurou etapa da lixeira`, 'success');
                    
                    // Atualizar a lixeira
                    openTrashModal();
                    
                    // Atualizar timeline se estiver aberto
                    if (timelineSystem.currentObraId) {
                        timelineSystem.loadTimeline(timelineSystem.currentObraId);
                    }
                    
                    // Atualizar a lista de obras
                    ui.loadObras();
                } else {
                    const error = await response.json();
                    toastSystem.show(`Erro ao restaurar etapa: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao restaurar etapa:', error);
                toastSystem.show('Erro de conex√£o ao restaurar etapa', 'error');
            }
        }

        async function permanentDeleteTimelineItem(etapaId) {
            if (!etapaId) return;

            const confirmDelete = confirm('Tem certeza que deseja excluir permanentemente esta etapa? Esta a√ß√£o n√£o pode ser desfeita.');
            if (!confirmDelete) return;

            try {
                const response = await fetch(`/api/etapas/${etapaId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    toastSystem.show('Etapa exclu√≠da permanentemente!', 'success');
                    
                    // Registrar no hist√≥rico
                    const usuario = authSystem.getCurrentUser()?.username || 'Sistema';
                    historySystem.addEntry('permanent_delete', usuario, `Excluiu etapa permanentemente`, 'warning');
                    
                    // Atualizar a lixeira
                    openTrashModal();
                } else {
                    const error = await response.json();
                    toastSystem.show(`Erro ao excluir etapa: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir etapa:', error);
                toastSystem.show('Erro de conex√£o ao excluir etapa', 'error');
            }
        }

        async function clearTrash() {
            const confirmClear = confirm('Tem certeza que deseja limpar toda a lixeira? Todas as etapas ser√£o exclu√≠das permanentemente.');
            if (!confirmClear) return;

            try {
                const response = await fetch('/api/lixeira/limpar', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    toastSystem.show('Lixeira limpa com sucesso!', 'success');
                    
                    // Registrar no hist√≥rico
                    const usuario = authSystem.getCurrentUser()?.username || 'Sistema';
                    historySystem.addEntry('clear_trash', usuario, `Limpou toda a lixeira`, 'warning');
                    
                    // Atualizar a lixeira
                    openTrashModal();
                } else {
                    const error = await response.json();
                    toastSystem.show(`Erro ao limpar lixeira: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('Erro ao limpar lixeira:', error);
                toastSystem.show('Erro de conex√£o ao limpar lixeira', 'error');
            }
        }
    </script>